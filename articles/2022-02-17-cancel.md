---
title: "ã€Swift, Combineã€‘ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ cancel() ã‚„ send(completion:) ã‚’å—ã‘ä»˜ã‘ãŸæ™‚ç‚¹ã§å‡ºåŠ›ã‚’å—ã‘ä»˜ã‘ãªã„"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift"]
published: true
---

# ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

- Combine ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ `cancel()` ã‚„ `send(completion:)` ã‚’å—ã‘ä»˜ã‘ãŸæ™‚ç‚¹ã§å‡ºåŠ›ã‚’å—ã‘ä»˜ã‘ãªã„


# å®Ÿé¨“(1) `cancel()` ã®å ´åˆ

## å‰ææ¡ä»¶

ä»¥ä¸‹ã®ã‚ˆã†ã®ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚

ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ã€`map()` å‡¦ç†ã«é…å»¶ã‚’å…¥ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã§ã™ã€‚

```swift
import Combine
import Foundation

var cancellables = Set<AnyCancellable>()
let numPublisher: PassthroughSubject<Int, Error> = .init()

numPublisher
    .handleEvents(receiveOutput: {
        print("receiveRequest: \($0)")
    }, receiveCancel: {
        print("receiveCancel")
    })
    .map { num -> Int in
        Thread.sleep(forTimeInterval: 3.0) // é…å»¶å‡¦ç†
        return num
    }
    .sink { result in
        switch result {
        case .finished:
            print("finished")
        case let .failure(error):
            print("failure: \(error)")
        }
    } receiveValue: { value in
        print("receiveValue: \(value)")
    }
    .store(in: &cancellables)
```

## å®Ÿé¨“å†…å®¹

ã“ã®çŠ¶æ…‹ã§ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

1. `numPublisher` ã®å‡ºåŠ›
2. `cancellables` ã® `cancel()`
3. `numPublisher` ã®å‡ºåŠ›

```swift:å®Ÿé¨“
// 1. `numPublisher` ã®å‡ºåŠ›
numPublisher.send(1)
numPublisher.send(2)

// 2. `cancellables` ã® `cancel()`
cancellables.map { $0.cancel() }

// 3. `numPublisher` ã®å‡ºåŠ›
numPublisher.send(3)
```

## ç¢ºèªãƒã‚¤ãƒ³ãƒˆ

`map()` ã«3ç§’ã®é…å»¶å‡¦ç†ã‚’å…¥ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã€2. `cancellables` ã® `cancel()`ã€ã‚’å®Ÿè¡Œã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã¯ã€ã¾ã ã€ã€1. `numPublisher` ã®å‡ºåŠ›ã€ ãŒ `receiveValue` ã¾ã§åˆ°é”ã—ã¦ã„ãªã„ã¨ã†çŠ¶æ³ã§ã€ã€3. `numPublisher` ã®å‡ºåŠ›ã€ãŒã©ã†å‡¦ç†ã•ã‚Œã‚‹ã®ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

## å‡ºåŠ›çµæœ

å‡ºåŠ›ã®çµæœã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```swift:çµæœ
// ï¼ˆå‡ºåŠ›ï¼‰
// receiveRequest: 1
// receiveValue: 1
// receiveRequest: 2
// receiveValue: 2
// receiveCancel
â†‘
`numPublisher.send(3)` ã¯å—ã‘ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„ï¼ï¼
```

ã“ã®ã‚ˆã†ã«ã€Œ3. `numPublisher` ã®å‡ºåŠ›ã€ãŒå—ã‘ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## ã“ã®ã“ã¨ã‹ã‚‰ã‚ã‹ã‚‹ã“ã¨

- Combine ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ cancel() ã‚’å—ã‘ä»˜ã‘ãŸæ™‚ç‚¹ã§å‡ºåŠ›ã‚’å—ã‘ä»˜ã‘ãªã„ã€‚

# å®Ÿé¨“(2) `send(completion:)` ã®å ´åˆ

`cancel()` ã§ã¯ãªã Publisher ã® `send(completion:)` ã‚’è¡Œã£ãŸå ´åˆã«ã©ã†ãªã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¦ã¿ã¾ã™ã€‚

## `send(completion: .finished)` ã®å ´åˆ

```swift
// 1. `numPublisher` ã®å‡ºåŠ›
numPublisher.send(1)
numPublisher.send(2)

// 2. `numPublisher` ã® `send(completion:)`
numPublisher.send(completion: .finished)

// 3. `numPublisher` ã®å‡ºåŠ›
numPublisher.send(3)

// ï¼ˆå‡ºåŠ›ï¼‰
// receiveRequest: 1
// receiveValue: 1
// receiveRequest: 2
// receiveValue: 2
// finished
â†‘
`numPublisher.send(3)` ã¯å—ã‘ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„ï¼ï¼
```

`cancel()` ã¨åŒæ§˜ã«ã€Œ3. `numPublisher` ã®å‡ºåŠ›ã€ãŒå—ã‘ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

## `send(completion: .failure())` ã®å ´åˆ

```swift
enum TestError: Error {
    case testError
}

// 1. `numPublisher` ã®å‡ºåŠ›
numPublisher.send(1)
numPublisher.send(2)

// 2. `numPublisher` ã® `send(completion:)`
numPublisher.send(completion: .failure(TestError.testError))

// 3. `numPublisher` ã®å‡ºåŠ›
numPublisher.send(3)

// ï¼ˆå‡ºåŠ›ï¼‰
// receiveRequest: 1
// receiveValue: 1
// receiveRequest: 2
// receiveValue: 2
// failure: testError
â†‘
`numPublisher.send(3)` ã¯å—ã‘ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„ï¼ï¼
```

ã“ã¡ã‚‰ã‚‚ `cancel()` ã¨åŒæ§˜ã«ã€Œ3. `numPublisher` ã®å‡ºåŠ›ã€ãŒå—ã‘ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

# ã¾ã¨ã‚

- Combine ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ `cancel()` ã‚„ `send(completion:)` ã‚’å—ã‘ä»˜ã‘ãŸæ™‚ç‚¹ã§å‡ºåŠ›ã‚’å—ã‘ä»˜ã‘ãªã„"

ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚