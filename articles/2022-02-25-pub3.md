---
title: "[Swift] [Combine] delegate ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¨˜è¿°ã—ãŸ View ã‚’ @Published ã§æ›¸ãç›´ã—ã¦ã¿ãŸ"
emoji: "ðŸŒ¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift"]
published: true
---

# ã“ã®è¨˜äº‹ã§ã‚ã‹ã‚‹ã“ã¨

`delegate` ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¨˜è¿°ã—ã¦ã„ãŸ View ã¨ Presenter ã®å‡¦ç†ã‚’ `@Published` ã‚’ä½¿ã£ã¦æ›¸ãç›´ã—ã¦ã¿ãŸã¨ã“ã‚ã€ãã‚Œãžã‚Œã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€ä»¥ä¸‹ã®ã“ã¨ãŒæŒ™ã’ã‚‰ã‚ŒãŸã€‚

- **`delegate` ãƒ‘ã‚¿ãƒ¼ãƒ³**
  - **ãƒ¡ãƒªãƒƒãƒˆ**
    - **Computed property ã‚’æ°—ã«ã›ãšä½¿ãˆã‚‹**
  - **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**
    - **`didSet` ã§ `delegete` ã®å‡¦ç†ã‚’èµ°ã‚‰ã›ã¦ã€ãã‚ŒãŒ View ã«åæ˜ ã•ã‚Œã‚‹ã¾ã§ã®è¦‹é€šã—ãŒæ‚ªã„**
    - Computed Property ã‚’å¤šç”¨ã—ã¦ã„ã‚‹ã¨ã€ãƒã‚¹ãƒˆã—ãŸ Computed Property ã®å€¤ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ãã®è¦‹é€šã—ãŒæ‚ªã„
    - `delegete` ã® `protocol` ã‚’å®Ÿè£…ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„
    - `weak var delegete` ã¸ã®ä»£å…¥ã‚’ã—å¿˜ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- **`@Published`**
  - **ãƒ¡ãƒªãƒƒãƒˆ**
    - **å€¤ã®å¤‰æ›´ãŒãã®ã¾ã¾ View ã«åæ˜ ã™ã‚‹ã‚ˆã†ã«è¨˜è¿°ã§ãã‚‹ = å‡¦ç†ã®è¦‹é€šã—ãŒè‰¯ã„**
    - `didSet` ã‚’å»ƒæ­¢ã§ãã‚‹
    - Computed Property ã‚’å»ƒæ­¢ã§ãã‚‹
    - `delegate` ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯å¿…è¦ã ã£ãŸã‚ˆã†ãª `protocol` ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒãªã„
  - **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**
    - `@Published` ãª Computed Property ã‚’è¨˜è¿°ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ Combine ã§æ›¸ãç›´ã™å¿…è¦ãŒã‚ã‚‹

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ `delegate` ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¨˜è¿°ã—ã¦ã„ãŸ View ã¨ Presenter ã®å‡¦ç†ã‚’ `@Published` ã‚’ä½¿ã£ã¦æ›¸ãç›´ã—ã¦ã€ãã‚Œãžã‚Œã®ãƒ¡ãƒªãƒƒãƒˆã¨ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’ã¾ã¨ã‚ãŸè¨˜äº‹ã«ãªã‚Šã¾ã™ã€‚

# ã‚„ã‚ŠãŸã„ã“ã¨

è²·ã„ç‰©ã‚¢ãƒ—ãƒªã‚’æƒ³å®šã—ãŸã‚«ãƒ¼ãƒˆç”»é¢ã§ä»¥ä¸‹ã®ã‚ˆã†ãªä»•æ§˜ã‚’æƒ³å®šã—ã¾ã™ã€‚

- **è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é …ç›®**
  - ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã¦ã„ã‚‹å•†å“ä¸€è¦§
  - ã‚«ãƒ¼ãƒˆã«å…¥ã‚ŒãŸå•†å“æ•°
  - åˆè¨ˆã®ç¨Žè¾¼ã¿ä¾¡æ ¼
  - é¸æŠžã—ãŸã‚¯ãƒ¼ãƒãƒ³
  - ã‚¯ãƒ¼ãƒãƒ³ã‚’é©å¿œã—ãŸç¨Žè¾¼ã¿ä¾¡æ ¼
- **ã§ãã‚‹æ“ä½œ**
  - ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’å…¥ã‚Œã‚‹
  - ã‚¯ãƒ¼ãƒãƒ³ã‚’é¸æŠžã™ã‚‹

# å…±é€šã‚³ãƒ¼ãƒ‰

```swift:å…±é€šã‚³ãƒ¼ãƒ‰
import Combine

enum Coupon: CaseIterable {
    case none
    case tenPercentOff
    case tenDiscount
}

extension Coupon {
    func apply(price: Int) -> Int {
        switch self {
        case .none:
            return price
        case .tenPercentOff:
            return Int(Double(price) * 0.9)
        case .tenDiscount:
            return price - 10
        }
    }
}

protocol ProductProtocol {
    var name: String { get }
    var price: Int { get }
}

struct Apple: ProductProtocol {
    let name: String = "apple"
    let price: Int = 100
}

struct Pen: ProductProtocol {
    let name: String = "pen"
    let price: Int = 30
}

enum Product: CaseIterable {
    case apple
    case pen
}

extension Product {
    var product: ProductProtocol {
        switch self {
        case .apple:
            return Apple()
        case .pen:
            return Pen()
        }
    }
}

class CommonProperty {
    static let consumptionTaxRate: Double = 0.1
}
```

# `delegate` ã®å ´åˆ

## Cart ã®å®šç¾©

```swift:Cartã®å®šç¾©
protocol CartDelegateProtocol: AnyObject {
    func didUpdateProducts()
}

class Cart {
    weak var delegete: CartDelegateProtocol?
    
    var products: [ProductProtocol] = [] {
        didSet {
            delegete?.didUpdateProducts()
        }
    }
    
    var productsCount: Int {
        products.count
    }
    
    var totalPriceExcludingTax: Int {
        products.reduce(0) { $0 + $1.price }
    }

    func add(product: ProductProtocol) {
        products.append(product)
    }
}
```

## Presenter

```swift:Presenter
protocol ShoppingPresenterDelegateProtocol: AnyObject {
    func didUpdateSelectedCoupon()
}

class ShoppingPresenter {
    weak var delegete: ShoppingPresenterDelegateProtocol?
    
    let productList: [ProductProtocol] = Product.allCases.map { $0.product }
    let couponList: [Coupon] = Coupon.allCases
    
    let cart = Cart()

    var productsInCart: [ProductProtocol] {
        cart.products
    }
    
    var productsCount: Int {
        cart.productsCount
    }
    
    var totalPriceIncludingTax: Int {
        calculateConsumptionTax(priceExcludingTax: cart.totalPriceExcludingTax)
    }
    
    var selectedCoupon: Coupon = .none {
        didSet  {
            delegete?.didUpdateSelectedCoupon()
        }
    }
    
    var couponAppliedTotalPriceIncludingTax: Int {
        selectedCoupon.apply(price: totalPriceIncludingTax)
    }
    
    func addInCart(product: ProductProtocol) {
        cart.add(product: product)
    }
    
    func select(coupon: Coupon) {
        selectedCoupon = coupon
    }
}

extension ShoppingPresenter {
    private func calculateConsumptionTax(priceExcludingTax: Int) -> Int {
        Int(Double(priceExcludingTax) * (CommonProperty.consumptionTaxRate + 1.0))
    }
}
```

## View

```swift:View
class ShoppingView {
    let presenter = ShoppingPresenter()
    
    var productsInCart: [ProductProtocol] = []
    var productsCount: Int = 0
    var selectedCoupon: Coupon = .none
    var totalPriceIncludingTax: Int = 0
    var couponAppliedTotalPriceIncludingTax: Int = 0
    
    init() {
        presenter.delegete = self
        presenter.cart.delegete = self
    }
    
    func update() {
        productsInCart = presenter.productsInCart
        productsCount = presenter.productsCount
        selectedCoupon = presenter.selectedCoupon
        totalPriceIncludingTax = presenter.totalPriceIncludingTax
        couponAppliedTotalPriceIncludingTax = presenter.couponAppliedTotalPriceIncludingTax
    }
}

extension ShoppingView: CartDelegateProtocol {
    func didUpdateProducts() {
        update()
    }
}

extension ShoppingView: ShoppingPresenterDelegateProtocol {
    func didUpdateSelectedCoupon() {
        update()
    }
}
```

## æŒ™å‹•ç¢ºèª

```swift:æŒ™å‹•ç¢ºèª
extension ShoppingView {
    func randomAction() {
        if Bool.random() {
            presenter.addInCart(product: presenter.productList.randomElement()!)
        } else {
            presenter.select(coupon: presenter.couponList.randomElement()!)
        }
        printAll()
    }
    
    func printAll() {
        print("=============printAll=============")
        print("productsInCart: \(productsInCart)")
        print("productsCount: \(productsCount)")
        print("selectedCoupon: \(selectedCoupon)")
        print("totalPriceIncludingTax: \(totalPriceIncludingTax)")
        print("couponAppliedTotalPriceIncludingTax: \(couponAppliedTotalPriceIncludingTax)")
    }
}

let view = ShoppingView()

view.randomAction()
view.randomAction()
view.randomAction()
view.randomAction()
```

## å‡ºåŠ›çµæžœ

```code:å‡ºåŠ›çµæžœ
=============printAll=============
productsInCart: [__lldb_expr_72.Pen(name: "pen", price: 50)]
productsCount: 1
selectedCoupon: none
totalPriceIncludingTax: 55
couponAppliedTotalPriceIncludingTax: 55
=============printAll=============
productsInCart: [__lldb_expr_72.Pen(name: "pen", price: 50)]
productsCount: 1
selectedCoupon: none
totalPriceIncludingTax: 55
couponAppliedTotalPriceIncludingTax: 55
=============printAll=============
productsInCart: [__lldb_expr_72.Pen(name: "pen", price: 50), __lldb_expr_72.Apple(name: "apple", price: 100)]
productsCount: 2
selectedCoupon: none
totalPriceIncludingTax: 165
couponAppliedTotalPriceIncludingTax: 165
=============printAll=============
productsInCart: [__lldb_expr_72.Pen(name: "pen", price: 50), __lldb_expr_72.Apple(name: "apple", price: 100), __lldb_expr_72.Pen(name: "pen", price: 50)]
productsCount: 3
selectedCoupon: none
totalPriceIncludingTax: 220
couponAppliedTotalPriceIncludingTax: 220
```

## ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- **ãƒ¡ãƒªãƒƒãƒˆ**
  - **Computed property ã‚’æ°—ã«ã›ãšä½¿ãˆã‚‹**
- **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**
  - **`didSet` ã§ `delegete` ã®å‡¦ç†ã‚’èµ°ã‚‰ã›ã¦ã€ãã‚ŒãŒ View ã«åæ˜ ã•ã‚Œã‚‹ã¾ã§ã®è¦‹é€šã—ãŒæ‚ªã„**
  - Computed Property ã‚’å¤šç”¨ã—ã¦ã„ã‚‹ã¨ã€ãƒã‚¹ãƒˆã—ãŸ Computed Property ã®å€¤ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ãã®è¦‹é€šã—ãŒæ‚ªã„
  - `delegete` ã® `protocol` ã‚’å®Ÿè£…ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„
  - `weak var delegete` ã¸ã®ä»£å…¥ã‚’ã—å¿˜ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

# `@Published` ã®å ´åˆ

## Cart ã®å®šç¾©

```swift:Cartã®å®šç¾©
class Cart {
    @Published private(set) var products: [ProductProtocol] = []
    @Published private(set) var productsCount: Int = 0
    @Published private(set) var totalPriceExcludingTax: Int = 0
    
    init() {
        $products
            .map { $0.count }
            .assign(to: &$productsCount)
        
        $products
            .map { $0.reduce(0) { $0 + $1.price } }
            .assign(to: &$totalPriceExcludingTax)
    }
    
    func add(product: ProductProtocol) {
        products.append(product)
    }
}
```

## Presenter

```swift:Presenter
class ShoppingPresenter {
    let productList: [ProductProtocol] = Product.allCases.map { $0.product }
    let couponList: [Coupon] = Coupon.allCases
    
    private let cart = Cart()
    
    @Published private(set) var productsInCart: [ProductProtocol] = []
    @Published private(set) var productsCount: Int = 0
    @Published private(set) var totalPriceIncludingTax: Int = 0
    @Published private(set) var selectedCoupon: Coupon = .none
    @Published private(set) var couponAppliedTotalPriceIncludingTax: Int = 0
    
    init() {
        cart.$products
            .assign(to: &$productsInCart)
        
        cart.$productsCount
            .assign(to: &$productsCount)
        
        cart.$totalPriceExcludingTax
            .combineLatest(Just(CommonProperty.consumptionTaxRate))
            .map { Double($0) * ($1 + 1.0) }
            .map { Int($0) }
            .assign(to: &$totalPriceIncludingTax)

        // â†‘ã®ç¨Žè¨ˆç®—ã¯ä»¥ä¸‹ã§ã‚‚å¯èƒ½ã§ã‚ã‚‹
        // cart.$totalPriceExcludingTax
        //    .compactMap { [weak self] in self?.calculateConsumptionTax(priceExcludingTax: $0) }
        //    .assign(to: &$totalPriceIncludingTax)
        
        $selectedCoupon
            .combineLatest($totalPriceIncludingTax)
            .map { $0.apply(price: $1) }
            .assign(to: &$couponAppliedTotalPriceIncludingTax)
    }
    
    func addInCart(product: ProductProtocol) {
        cart.add(product: product)
    }
    
    func select(coupon: Coupon) {
        selectedCoupon = coupon
    }
}

extension ShoppingPresenter {
    private func calculateConsumptionTax(priceExcludingTax: Int) -> Int {
        Int(Double(priceExcludingTax) * (CommonProperty.consumptionTaxRate + 1.0))
    }
}
```

## View

```swift:View
class ShoppingView {
    let presenter = ShoppingPresenter()
    
    var productsInCart: [ProductProtocol] = []
    var productsCount: Int = 0
    var selectedCoupon: Coupon = .none
    var totalPriceIncludingTax: Int = 0
    var couponAppliedTotalPriceIncludingTax: Int = 0
    
    private var cancellables = Set<AnyCancellable>()

    init() {
        presenter.$productsInCart
            .assign(to: \.productsInCart, on: self)
            .store(in: &cancellables)
        
        presenter.$productsCount
            .assign(to: \.productsCount, on: self)
            .store(in: &cancellables)

        presenter.$selectedCoupon
            .assign(to: \.selectedCoupon, on: self)
            .store(in: &cancellables)

        presenter.$totalPriceIncludingTax
            .assign(to: \.totalPriceIncludingTax, on: self)
            .store(in: &cancellables)

        presenter.$couponAppliedTotalPriceIncludingTax
            .assign(to: \.couponAppliedTotalPriceIncludingTax, on: self)
            .store(in: &cancellables)
    }
}
```

## æŒ™å‹•ç¢ºèª

```swift:æŒ™å‹•ç¢ºèª
extension ShoppingView {
    func randomAction() {
        if Bool.random() {
            presenter.addInCart(product: presenter.productList.randomElement()!)
        } else {
            presenter.select(coupon: presenter.couponList.randomElement()!)
        }
        printAll()
    }
    
    func printAll() {
        print("=============printAll=============")
        print("productsInCart: \(productsInCart)")
        print("productsCount: \(productsCount)")
        print("selectedCoupon: \(selectedCoupon)")
        print("totalPriceIncludingTax: \(totalPriceIncludingTax)")
        print("couponAppliedTotalPriceIncludingTax: \(couponAppliedTotalPriceIncludingTax)")
    }
}

let view = ShoppingView()

view.randomAction()
view.randomAction()
view.randomAction()
view.randomAction()
```

## å‡ºåŠ›çµæžœ

```code:å‡ºåŠ›çµæžœ
=============printAll=============
productsInCart: [__lldb_expr_74.Apple(name: "apple", price: 100)]
productsCount: 1
selectedCoupon: none
totalPriceIncludingTax: 110
couponAppliedTotalPriceIncludingTax: 110
=============printAll=============
productsInCart: [__lldb_expr_74.Apple(name: "apple", price: 100)]
productsCount: 1
selectedCoupon: none
totalPriceIncludingTax: 110
couponAppliedTotalPriceIncludingTax: 110
=============printAll=============
productsInCart: [__lldb_expr_74.Apple(name: "apple", price: 100)]
productsCount: 1
selectedCoupon: tenPercentOff
totalPriceIncludingTax: 110
couponAppliedTotalPriceIncludingTax: 99
=============printAll=============
productsInCart: [__lldb_expr_74.Apple(name: "apple", price: 100), __lldb_expr_74.Pen(name: "pen", price: 50)]
productsCount: 2
selectedCoupon: tenPercentOff
totalPriceIncludingTax: 165
couponAppliedTotalPriceIncludingTax: 148
```

## ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- **ãƒ¡ãƒªãƒƒãƒˆ**
  - **å€¤ã®å¤‰æ›´ãŒãã®ã¾ã¾ View ã«åæ˜ ã™ã‚‹ã‚ˆã†ã«è¨˜è¿°ã§ãã‚‹ = å‡¦ç†ã®è¦‹é€šã—ãŒè‰¯ã„**
  - `didSet` ã‚’å»ƒæ­¢ã§ãã‚‹
  - Computed Property ã‚’å»ƒæ­¢ã§ãã‚‹
  - `delegate` ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯å¿…è¦ã ã£ãŸã‚ˆã†ãª `protocol` ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒãªã„
- **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**
  - `@Published` ãª Computed Property ã‚’è¨˜è¿°ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ Combine ã§æ›¸ãç›´ã™å¿…è¦ãŒã‚ã‚‹

# çµè«–

`delegate` ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¨˜è¿°ã—ã¦ã„ãŸ View ã¨ Presenter ã®å‡¦ç†ã‚’ `@Published` ã‚’ä½¿ã£ã¦æ›¸ãç›´ã—ã¦ã¿ãŸã¨ã“ã‚ã€ãã‚Œãžã‚Œã®ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€ä»¥ä¸‹ã®ã“ã¨ãŒæŒ™ã’ã‚‰ã‚ŒãŸã€‚

- **`delegate` ãƒ‘ã‚¿ãƒ¼ãƒ³**
  - **ãƒ¡ãƒªãƒƒãƒˆ**
    - **Computed property ã‚’æ°—ã«ã›ãšä½¿ãˆã‚‹**
  - **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**
    - **`didSet` ã§ `delegete` ã®å‡¦ç†ã‚’èµ°ã‚‰ã›ã¦ã€ãã‚ŒãŒ View ã«åæ˜ ã•ã‚Œã‚‹ã¾ã§ã®è¦‹é€šã—ãŒæ‚ªã„**
    - Computed Property ã‚’å¤šç”¨ã—ã¦ã„ã‚‹ã¨ã€ãƒã‚¹ãƒˆã—ãŸ Computed Property ã®å€¤ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ãã®è¦‹é€šã—ãŒæ‚ªã„
    - `delegete` ã® `protocol` ã‚’å®Ÿè£…ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„
    - `weak var delegete` ã¸ã®ä»£å…¥ã‚’ã—å¿˜ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- **`@Published`**
  - **ãƒ¡ãƒªãƒƒãƒˆ**
    - **å€¤ã®å¤‰æ›´ãŒãã®ã¾ã¾ View ã«åæ˜ ã™ã‚‹ã‚ˆã†ã«è¨˜è¿°ã§ãã‚‹ = å‡¦ç†ã®è¦‹é€šã—ãŒè‰¯ã„**
    - `didSet` ã‚’å»ƒæ­¢ã§ãã‚‹
    - Computed Property ã‚’å»ƒæ­¢ã§ãã‚‹
    - `delegate` ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯å¿…è¦ã ã£ãŸã‚ˆã†ãª `protocol` ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒãªã„
  - **ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**
    - `@Published` ãª Computed Property ã‚’è¨˜è¿°ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ Combine ã§æ›¸ãç›´ã™å¿…è¦ãŒã‚ã‚‹

# Playground ã‚³ãƒ”ãƒšç”¨

å…±é€šã‚³ãƒ¼ãƒ‰ã‚’é™¤ã„ã¦ Playground ã§å‹•ã‹ã—ã¦ã¿ã‚‹ç”¨ã«ã‚³ãƒ”ãƒšã§å‹•ãã‚³ãƒ¼ãƒ‰ã‚’è²¼ã£ã¦ãŠãã¾ã™ã€‚

## `delegete` ãƒ‘ã‚¿ãƒ¼ãƒ³

```swift
protocol CartDelegateProtocol: AnyObject {
    func didUpdateProducts()
}

class Cart {
    weak var delegete: CartDelegateProtocol?
    
    var products: [ProductProtocol] = [] {
        didSet {
            delegete?.didUpdateProducts()
        }
    }
    
    var productsCount: Int {
        products.count
    }
    
    var totalPriceExcludingTax: Int {
        products.reduce(0) { $0 + $1.price }
    }

    func add(product: ProductProtocol) {
        products.append(product)
    }
}

protocol ShoppingPresenterDelegateProtocol: AnyObject {
    func didUpdateSelectedCoupon()
}

class ShoppingPresenter {
    weak var delegete: ShoppingPresenterDelegateProtocol?
    
    let productList: [ProductProtocol] = Product.allCases.map { $0.product }
    let couponList: [Coupon] = Coupon.allCases
    
    let cart = Cart()

    var productsInCart: [ProductProtocol] {
        cart.products
    }
    
    var productsCount: Int {
        cart.productsCount
    }
    
    var totalPriceIncludingTax: Int {
        calculateConsumptionTax(priceExcludingTax: cart.totalPriceExcludingTax)
    }
    
    var selectedCoupon: Coupon = .none {
        didSet  {
            delegete?.didUpdateSelectedCoupon()
        }
    }
    
    var couponAppliedTotalPriceIncludingTax: Int {
        selectedCoupon.apply(price: totalPriceIncludingTax)
    }
    
    func addInCart(product: ProductProtocol) {
        cart.add(product: product)
    }
    
    func select(coupon: Coupon) {
        selectedCoupon = coupon
    }
}

extension ShoppingPresenter {
    private func calculateConsumptionTax(priceExcludingTax: Int) -> Int {
        Int(Double(priceExcludingTax) * (CommonProperty.consumptionTaxRate + 1.0))
    }
}

class ShoppingView {
    let presenter = ShoppingPresenter()
    
    var productsInCart: [ProductProtocol] = []
    var productsCount: Int = 0
    var selectedCoupon: Coupon = .none
    var totalPriceIncludingTax: Int = 0
    var couponAppliedTotalPriceIncludingTax: Int = 0
    
    init() {
        presenter.delegete = self
        presenter.cart.delegete = self
    }
    
    func update() {
        productsInCart = presenter.productsInCart
        productsCount = presenter.productsCount
        selectedCoupon = presenter.selectedCoupon
        totalPriceIncludingTax = presenter.totalPriceIncludingTax
        couponAppliedTotalPriceIncludingTax = presenter.couponAppliedTotalPriceIncludingTax
    }
}

extension ShoppingView: CartDelegateProtocol {
    func didUpdateProducts() {
        update()
    }
}

extension ShoppingView: ShoppingPresenterDelegateProtocol {
    func didUpdateSelectedCoupon() {
        update()
    }
}

extension ShoppingView {
    func randomAction() {
        if Bool.random() {
            presenter.addInCart(product: presenter.productList.randomElement()!)
        } else {
            presenter.select(coupon: presenter.couponList.randomElement()!)
        }
        printAll()
    }
    
    func printAll() {
        print("=============printAll=============")
        print("productsInCart: \(productsInCart)")
        print("productsCount: \(productsCount)")
        print("selectedCoupon: \(selectedCoupon)")
        print("totalPriceIncludingTax: \(totalPriceIncludingTax)")
        print("couponAppliedTotalPriceIncludingTax: \(couponAppliedTotalPriceIncludingTax)")
    }
}

let view = ShoppingView()

view.randomAction()
view.randomAction()
view.randomAction()
view.randomAction()
```

## `@Published`

```swift
class Cart {
    @Published private(set) var products: [ProductProtocol] = []
    @Published private(set) var productsCount: Int = 0
    @Published private(set) var totalPriceExcludingTax: Int = 0
    
    init() {
        $products
            .map { $0.count }
            .assign(to: &$productsCount)
        
        $products
            .map { $0.reduce(0) { $0 + $1.price } }
            .assign(to: &$totalPriceExcludingTax)
    }
    
    func add(product: ProductProtocol) {
        products.append(product)
    }
}
class ShoppingPresenter {
    let productList: [ProductProtocol] = Product.allCases.map { $0.product }
    let couponList: [Coupon] = Coupon.allCases
    
    private let cart = Cart()
    
    @Published private(set) var productsInCart: [ProductProtocol] = []
    @Published private(set) var productsCount: Int = 0
    @Published private(set) var totalPriceIncludingTax: Int = 0
    @Published private(set) var selectedCoupon: Coupon = .none
    @Published private(set) var couponAppliedTotalPriceIncludingTax: Int = 0
    
    init() {
        cart.$products
            .assign(to: &$productsInCart)
        
        cart.$productsCount
            .assign(to: &$productsCount)
        
        cart.$totalPriceExcludingTax
            .combineLatest(Just(CommonProperty.consumptionTaxRate))
            .map { Double($0) * ($1 + 1.0) }
            .map { Int($0) }
            .assign(to: &$totalPriceIncludingTax)

        // â†‘ã®ç¨Žè¨ˆç®—ã¯ä»¥ä¸‹ã§ã‚‚å¯èƒ½
        // cart.$totalPriceExcludingTax
        //    .compactMap { [weak self] in self?.calculateConsumptionTax(priceExcludingTax: $0) }
        //    .assign(to: &$totalPriceIncludingTax)
        
        $selectedCoupon
            .combineLatest($totalPriceIncludingTax)
            .map { $0.apply(price: $1) }
            .assign(to: &$couponAppliedTotalPriceIncludingTax)
    }
    
    func addInCart(product: ProductProtocol) {
        cart.add(product: product)
    }
    
    func select(coupon: Coupon) {
        selectedCoupon = coupon
    }
}

extension ShoppingPresenter {
    private func calculateConsumptionTax(priceExcludingTax: Int) -> Int {
        Int(Double(priceExcludingTax) * (CommonProperty.consumptionTaxRate + 1.0))
    }
}

class ShoppingView {
    let presenter = ShoppingPresenter()
    
    var productsInCart: [ProductProtocol] = []
    var productsCount: Int = 0
    var selectedCoupon: Coupon = .none
    var totalPriceIncludingTax: Int = 0
    var couponAppliedTotalPriceIncludingTax: Int = 0
    
    private var cancellables = Set<AnyCancellable>()
    
    init() {
        presenter.$productsInCart
            .assign(to: \.productsInCart, on: self)
            .store(in: &cancellables)
        
        presenter.$productsCount
            .assign(to: \.productsCount, on: self)
            .store(in: &cancellables)

        presenter.$selectedCoupon
            .assign(to: \.selectedCoupon, on: self)
            .store(in: &cancellables)

        presenter.$totalPriceIncludingTax
            .assign(to: \.totalPriceIncludingTax, on: self)
            .store(in: &cancellables)

        presenter.$couponAppliedTotalPriceIncludingTax
            .assign(to: \.couponAppliedTotalPriceIncludingTax, on: self)
            .store(in: &cancellables)
    }
}

extension ShoppingView {
    func randomAction() {
        if Bool.random() {
            presenter.addInCart(product: presenter.productList.randomElement()!)
        } else {
            presenter.select(coupon: presenter.couponList.randomElement()!)
        }
        printAll()
    }
    
    func printAll() {
        print("=============printAll=============")
        print("productsInCart: \(productsInCart)")
        print("productsCount: \(productsCount)")
        print("selectedCoupon: \(selectedCoupon)")
        print("totalPriceIncludingTax: \(totalPriceIncludingTax)")
        print("couponAppliedTotalPriceIncludingTax: \(couponAppliedTotalPriceIncludingTax)")
    }
}

let view = ShoppingView()

view.randomAction()
view.randomAction()
view.randomAction()
view.randomAction()
```