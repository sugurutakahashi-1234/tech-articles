---
title: "ã€Swiftã€‘delegate ã®å¤‰æ•°ã«ã¤ã‘ã¦ã„ã‚‹ weak ã¯ãªãœã„ã‚‹ã®ã‹ï¼Ÿ"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift", "Combine"]
published: true
---

# ä¼ãˆãŸã„ã“ã¨

delegate ã«é©å¿œã—ãŸ self ã‚’å¼±å‚ç…§ã•ã›ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä»¥ä¸‹ã®2é€šã‚ŠãŒã‚ã‚‹ã€‚

- `weak var` ã§å®£è¨€ã—ãŸå¤‰æ•°ã‚’ç”¨æ„ã—ã¦ã€delegate ã«é©å¿œã—ãŸ `self` ã‚’ä»£å…¥ã™ã‚‹
   - ãƒ¡ãƒªãƒƒãƒˆï¼šã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‚‹
   - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼šdelegate å¤‰æ•°ã®å¤–éƒ¨ã‹ã‚‰ã®å¤‰æ›´ã‚„ã€delegete ã®ä»£å…¥å¿˜ã‚Œã®æã‚ŒãŒã‚ã‚‹
-  `private weak var` ã¾ãŸã¯ `private unowned let`  ã‚’å®£è¨€ã—ãŸå¤‰æ•°ã‚’ç”¨æ„ã—ã¦ã€`lazy var` ã§ delegate ã«é©å¿œã—ãŸ `self` ã‚’ init ã®å¼•æ•°ã§æ¸¡ã™
   - ãƒ¡ãƒªãƒƒãƒˆï¼š`weak var` ã‚’ä½¿ã†å ´åˆã«ã‚ã£ãŸã‚ˆã†ãªãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒãªããªã‚‹
   - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼š`lazy var` ã‚’ä½¿ã†å½±éŸ¿ã§ã€ãã®å¤‰æ•°ãŒå¤‰æ›´ã•ã‚Œã‚‹æã‚Œã‚„ã€`lazy var`ã®å¤‰æ•°ãŒä½¿ã‚ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ init ãŒèµ°ã‚‹ã®ã§ã€ãã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã£ã¦ã¯äºˆæœŸã›ã¬ãƒã‚°ãŒç™ºç”Ÿã™ã‚‹ï¼ˆ= `lazy var` ã®ãƒªã‚¹ã‚¯ï¼‰

# ã©ã†ã—ã¦ `waek var delegate` ã¨ã™ã‚‹ã®ã‹ï¼Ÿ

`waek` ã‚’ã¤ã‘ã¦ã„ãªã„ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç”¨ã„ã¦æŒ™å‹•ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

## weak ã‚’ã¤ã‘ãªã„å ´åˆã®æŒ™å‹•

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```swift
protocol HogeDelegate: AnyObject {
    func hogehoge()
}

class MogeClass {
    var delegate: HogeDelegate?
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate?.hogehoge()
    }
}

class FugaClass {
    let mogeClass: MogeClass
    
    init() {
        mogeClass = MogeClass()
        mogeClass.delegate = self
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func fugafuga() {
        mogeClass.mogemoge()
    }
}

extension FugaClass: HogeDelegate {
    func hogehoge() {
        print("called hogehoge() on FugaClass")
    }
}
```

### fugaClass ã® fugafuga() ã®å®Ÿè¡Œ

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()

// (å‡ºåŠ›)
// called hogehoge() on FugaClass
```

æœŸå¾…é€šã‚Šã§ã™ã­ã€‚

### fugaClass init ã—ã¦ deinit ã™ã‚‹

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass = nil

// (å‡ºåŠ›)
// ãªã—
```

ã‚ã‚Œï¼Ÿ
`fugaClass` ãŒè§£æ”¾ã•ã‚Œã¾ã›ã‚“ã­ã€‚

ã•ã‚‰ã« `mogeClass` ã‚‚è§£æ”¾ã™ã‚‹è¡“ã‚‚å¤±ã£ã¦ã„ã¾ã™ã­ã€‚

## weak ã‚’ã¤ã‘ãŸå ´åˆã®æŒ™å‹•

```swift
class MogeClass {
    weak var delegate: HogeDelegate? // â† weak ã‚’ã¤ã‘ã‚‹
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate?.hogehoge()
    }
}
```

### fugaClass init ã—ã¦ deinit ã™ã‚‹

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// deinit: FugaClass
// deinit: MogeClass
```

è§£æ”¾ã•ã‚Œã¾ã™ã­ï¼ï¼

### fugaClass ã® fugafuga() ã®å®Ÿè¡Œã—ã¦ã€ãã‚Œã‹ã‚‰ fugaClass ã« nil ã‚’ä»£å…¥ã™ã‚‹

ã‚‚ã¡ã‚ã‚“ã€fugaClass ã® fugafuga() ã®å®Ÿè¡Œã—ã¦ã€ãã‚Œã‹ã‚‰ fugaClass ã« nil ã‚’ä»£å…¥ã—ã¦ã‚‚è§£æ”¾ã•ã‚Œã¾ã™ã€‚

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
// deinit: FugaClass
// deinit: MogeClass
```

ã“ã®ã‚ˆã†ã«è§£æ”¾ã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã®ã§ã€`weak var` ã¨å®£è¨€ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# `weak var` ã®å¾®å¦™ãªç‚¹

- å¤‰æ•°ã‚’ `var` ã§å®£è¨€ã™ã‚‹ã®ã§ã€å¤–ã‹ã‚‰å¤‰æ›´ã•ã‚Œã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚‹
- delegate ã®å¤‰æ•°ã«å€¤ã‚’ä»£å…¥ã—å¿˜ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

# `weak var` ã®å¾®å¦™ãªç‚¹ã®æ”¹å–„æ–¹æ³•ã‚’æ¤œè¨ã™ã‚‹

## æ”¹è‰¯æ¡ˆï¼š init ã®å¼•æ•°ã« delegate ã‚’è¨­å®šã—ã€`lazy var` ã§ self ã‚’æ¸¡ã™

ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```swift
protocol HogeDelegate: AnyObject {
    func hogehoge()
}

class MogeClass {
    let delegate: HogeDelegate // let ã«ä¿®æ­£
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate // init ã§ã‚‚ã‚‰ã†ã‚ˆã†ã«ã™ã‚‹
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate.hogehoge()
    }
}

class FugaClass {
    lazy var mogeClass = MogeClass(delegate: self) // lazy var ã§ self ã‚’æ¸¡ã™ã‚ˆã†ã«ã™ã‚‹
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func fugafuga() {
        mogeClass.mogemoge()
    }
}

extension FugaClass: HogeDelegate {
    func hogehoge() {
        print("called hogehoge() on FugaClass")
    }
}
```

### fugaClass ã® fugafuga() ã®å®Ÿè¡Œ

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
```

ã†ã‚“ã€‚å•é¡Œãªã„ã§ã™ã­ã€‚


### fugaClass init ã—ã¦ deinit ã™ã‚‹

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// deinit: FugaClass
```

MogeClass ãŒè§£æ”¾ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã«è¦‹ãˆã‚‹ãŒã€ãã‚‚ãã‚‚ç”Ÿæˆã•ã‚Œã¦ã„ãªã„ã®ã§ã€å•é¡Œãªã„ã§ã™ã­ã€‚

### fugaClass ã® fugafuga() ã®å®Ÿè¡Œã—ã¦ã€ãã‚Œã‹ã‚‰ fugaClass ã« nil ã‚’ä»£å…¥ã—ã¦ã¿ã‚‹

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
```

ã‚ã‚Œã€ã€ã€è§£æ”¾ã•ã‚Œã¦ã„ãªã„ã¿ãŸã„ã€‚ã€‚ã€‚

### çµå±€ã€`let` â†’ `weak var` ã«ã—ã¦ã¿ã‚‹

```swift
class MogeClass {
    weak var delegate: HogeDelegate? // çµå±€ weak var ã«ã™ã‚‹
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate?.hogehoge()
    }
}
```

### å†Try

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
// deinit: FugaClass
// deinit: MogeClass
```

ã†ã¾ãã„ãã¾ã—ãŸã­ã€‚ã€‚ã€‚
ã§ã‚‚çµå¥ `weak var` ã‚’ã¤ã‹ã£ã¦ã—ã¾ã£ã¦ãŠã‚Šã¾ã™ã€‚ã€‚ã€‚

## æ”¹è‰¯æ¡ˆã®å¾®å¦™ãªç‚¹

ã†ã¾ãã„ãã¾ã—ãŸãŒã€`lazy var` ã§ self ã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¦ã‚‚ã€ã‚„ã£ã±ã‚Š `weak var` ã‚’ã¤ã‘ãªã‚Œã°ã„ã‘ãªã„ã®ã§ã™ã­ã€‚ã€‚ã€‚

ãŸã ã€`private` ã‚’ã¤ã‘ã‚Œã°ã€å¤–ã‹ã‚‰ã®å¤‰æ›´ã¯é˜²ã’ã‚‹ã®ã§ã€ãã‚ŒãŒæ°—ã«ãªã‚‹æ–¹ã¯ãã†ã—ãŸæ–¹ãŒã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚

ã—ã‹ã—ã€ãã‚‚ãã‚‚ `lazy var` ã¨ã—ã¦ã„ã‚‹æ–¹ãŒã€å¤‰æ›´ã®ãƒªã‚¹ã‚¯ãŒç™ºç”Ÿã—ã¾ã™ãŒã€ã€ã€ã©ã£ã¡ãŒã„ã„ã‚“ã§ã—ã‚‡ã†ã­ã€‚

ã¾ãŸã€`private` ã‚’ã¤ã‘ã‚‹ã®ã§ã‚ã‚Œã°ã€init ã§ã® delegate ã®è¨­å®šã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã€`delegate` ã‚’ä½¿ã†éš›ã¯å¼·åˆ¶ã‚¢ãƒ³ãƒ©ãƒƒãƒ—ã—ã¦ã‚‚ã‚ˆã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã­ã€‚

```swift
class MogeClass {
    private weak var delegate: HogeDelegate? // private ã‚’ã¤ã‘ã‚‹
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate!.hogehoge() // å¼·åˆ¶ã‚¢ãƒ³ãƒ©ãƒƒãƒ—ã«ã™ã‚‹
    }
}
```

ã§ã‚‚ã€init ã§è¨­å®šã—ã¦ã„ã‚‹ã¯ãšãªã®ã« `delegate?` ã‚„ `delegate!` ã¨ã™ã‚‹ã®ã¯ãªã‚“ã‹ã„ã‘ã¦ã¾ã›ã‚“ã‚ˆã­ã€‚ã€‚ã€‚

`weak let` ãŒã‚ã‚Œã°ã€è§£æ±ºã§ããã†ã§ã™ãŒã€`weak let` ã‚’ä½¿ãŠã†ã¨ã™ã‚‹ã¨ã€Œ`error: 'weak' must be a mutable variable, because it may change at runtime`ã€ã¨æ€’ã‚‰ã‚Œã¾ã™ã€‚

ã©ã†ã‚„ã‚‰ `weak let` ã¯ãªã„ã¿ãŸã„ã§ã™ã­ã€‚ã€‚ã€‚

## æ”¹è‰¯æ¡ˆã®æ”¹è‰¯æ¡ˆ: `unowned let` ã‚’ä½¿ã†ï¼

`weak let` ã¯ã§ããªã„ã§ã™ãŒã€`unowned let` ã§ã‚ã‚Œã°å®£è¨€ã§ãã‚‹ã¿ãŸã„ã§ã—ãŸã€‚
å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã¾ã™ã€‚

```swift
class MogeClass {
    private unowned let delegate: HogeDelegate // unowned ãªã‚‰ let ã‚’å®£è¨€ã§ãã‚‹
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate.hogehoge() // ? ã‚„ ! ã‚‚æ¶ˆã›ã‚‹
    }
}
```

### å†Try

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
// deinit: FugaClass
// deinit: MogeClass
```

ã†ã¾ãã„ãã¾ã—ãŸã­ã€‚

`lazy var` ã§ delegate ã¨ãªã‚‹ self ã‚’ init ã§æ¸¡ã™ã‚ˆã†ãªå ´åˆã¯ã€`unowned let` ã‚’ä½¿ã£ã¦ã‚‚è‰¯ã•ãã†ã§ã™ã­ã€‚

ãŸã ã€`lazy var` ã‚’ä½¿ã†ã“ã¨ã®ãƒªã‚¹ã‚¯ã‚‚ã‚ã‚‹ã®ã§ã€ãã‚Œã«ã¯ååˆ†æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

å…¨ä½“åƒã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```swift
protocol HogeDelegate: AnyObject {
    func hogehoge()
}

class MogeClass {
    private unowned let delegate: HogeDelegate
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate.hogehoge()
    }
}

class FugaClass {
    lazy var mogeClass = MogeClass(delegate: self)
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func fugafuga() {
        mogeClass.mogemoge()
    }
}

extension FugaClass: HogeDelegate {
    func hogehoge() {
        print("called hogehoge() on FugaClass")
    }
}

var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
// deinit: FugaClass
// deinit: MogeClass
```

# çµè«–

delegate ã«é©å¿œã—ãŸ self ã‚’å¼±å‚ç…§ã•ã›ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä»¥ä¸‹ã®2é€šã‚ŠãŒã‚ã‚‹ã€‚

- `weak var` ã§å®£è¨€ã—ãŸå¤‰æ•°ã‚’ç”¨æ„ã—ã¦ã€delegate ã«é©å¿œã—ãŸ `self` ã‚’ä»£å…¥ã™ã‚‹
   - ãƒ¡ãƒªãƒƒãƒˆï¼šã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‚‹
   - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼šdelegate å¤‰æ•°ã®å¤–éƒ¨ã‹ã‚‰ã®å¤‰æ›´ã‚„ã€delegete ã®ä»£å…¥å¿˜ã‚Œã®æã‚ŒãŒã‚ã‚‹
-  `private weak var` ã¾ãŸã¯ `private unowned let`  ã‚’å®£è¨€ã—ãŸå¤‰æ•°ã‚’ç”¨æ„ã—ã¦ã€`lazy var` ã§ delegate ã«é©å¿œã—ãŸ `self` ã‚’ init ã®å¼•æ•°ã§æ¸¡ã™
   - ãƒ¡ãƒªãƒƒãƒˆï¼š`weak var` ã‚’ä½¿ã†å ´åˆã«ã‚ã£ãŸã‚ˆã†ãªãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒãªããªã‚‹
   - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼š`lazy var` ã‚’ä½¿ã†å½±éŸ¿ã§ã€ãã®å¤‰æ•°ãŒå¤‰æ›´ã•ã‚Œã‚‹æã‚Œã‚„ã€`lazy var`ã®å¤‰æ•°ãŒä½¿ã‚ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ init ãŒèµ°ã‚‹ã®ã§ã€ãã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã£ã¦ã¯äºˆæœŸã›ã¬ãƒã‚°ãŒç™ºç”Ÿã™ã‚‹ï¼ˆ= `lazy var` ã®ãƒªã‚¹ã‚¯ï¼‰
