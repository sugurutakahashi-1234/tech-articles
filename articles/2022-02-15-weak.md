---
title: "ã€Swiftã€‘delegate ã®å¤‰æ•°ã® weak ã¯ãªãœã„ã‚‹ã®ã‹ï¼Ÿ"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift", "Combine"]
published: false
---


å…ˆã«çµè«–

delegate ã«å¯¾å¿œã—ãŸ self ã‚’è¨­å®šã—ã¦ã€å¼±å‚ç…§ã•ã›ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä»¥ä¸‹ã®2é€šã‚ŠãŒã‚ã‚‹ã€‚

- delegate ã‚’ä»£å…¥ã™ã‚‹éš›ã¯ `weak var` ã§å®£è¨€ã—ãŸå¤‰æ•°ã‚’ä½¿ã†
  - ãƒ¡ãƒªãƒƒãƒˆï¼šã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‚‹
  - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼šdelegate å¤‰æ•°ã®å¤–éƒ¨ã‹ã‚‰ã®å¤‰æ›´ã‚„ã€delegete ä»£å…¥å¿˜ã‚Œã®æã‚ŒãŒã‚ã‚‹
- `lazy var` ã§ delegate ã«é©å¿œã—ãŸ self ã‚’ init ã§æ¸¡ã™éš›ã¯ `unowned let` ã§å®£è¨€ã—ãŸå¤‰æ•°ã‚’ä½¿ã£ãŸæ–¹ãŒ
  - ãƒ¡ãƒªãƒƒãƒˆï¼š`weak var` ã‚’ä½¿ã†å ´åˆã«ã‚ã£ãŸã‚ˆã†ãªãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒãªããªã‚‹
  - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼š`lazy var` ã‚’ä½¿ã†å½±éŸ¿ã§ã€ãã¡ã‚‰ã®å¤‰æ•°ãŒå¤‰æ›´ã•ã‚Œã‚‹æã‚Œã‚„ã€init ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã£ã¦æ€ã‚ã¬ãƒã‚°ãŒç™ºç”Ÿã™ã‚‹

```swift
protocol HogeDelegate: AnyObject {
    func hogehoge()
}

class MogeClass {
    var delegate: HogeDelegate?
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate?.hogehoge()
    }
}

class FugaClass {
    let mogeClass: MogeClass
    
    init() {
        mogeClass = MogeClass()
        mogeClass.delegate = self
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func fugafuga() {
        mogeClass.mogemoge()
    }
}

extension FugaClass: HogeDelegate {
    func hogehoge() {
        print("called hogehoge() on FugaClass")
    }
}
```

å½“ãŸã‚Šå‰ã®æŒ™å‹•ã®ç¢ºèª

fugaClass ã® fugafuga() ã®å®Ÿè¡Œ

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()

// (å‡ºåŠ›)
// called hogehoge() on FugaClass
```

fugaClass init ã—ã¦ deinit ã™ã‚‹

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass = nil

// (å‡ºåŠ›)
// ãªã—
```

ã‚ã‚Œï¼Ÿ
fugaClass ãŒè§£æ”¾ã•ã‚Œãªã„ã€ã€ã€

ã¨ã„ã†ã‹ mogeClass ã‚‚è§£æ”¾ã™ã‚‹è¡“ã‚‚å¤±ã£ãŸã€ã€ã€

```swift
class MogeClass {
    weak var delegate: HogeDelegate? // â† weak ã‚’ã¤ã‘ã‚‹
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate?.hogehoge()
    }
}
```

fugaClass init ã—ã¦ deinit ã™ã‚‹

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// deinit: FugaClass
// deinit: MogeClass
```

è§£æ”¾ã•ã‚ŒãŸï¼ï¼


ã‚‚ã¡ã‚ã‚“ã€fugaClass ã® fugafuga() ã®å®Ÿè¡Œã—ã¦ã€ãã‚Œã‹ã‚‰ fugaClass ã« nil ã‚’ä»£å…¥ã—ã¦ã‚‚è§£æ”¾ã•ã‚Œã‚‹

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
// deinit: FugaClass
// deinit: MogeClass
```

ãŸã ã€ã“ã‚Œã ã¨ã€ã©ã†ã—ã¦ã‚‚ var ã§å®£è¨€ã™ã‚‹ã®ã§ã€å¤–ã‹ã‚‰å¤‰æ›´ã•ã‚ŒãŸã‚Šã€delegate ã‚’ä»£å…¥ã—å¿˜ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

å¤‰æ›´æ¡ˆï¼š
MogeClass ã® init ã§ delegate ã‚’ã‚‚ã‚‰ã†ã‚ˆã†ã«ã—ã¦ã€FugaClass ã§ lazy var ã§ self ã‚’æ¸¡ã™

```swift
protocol HogeDelegate: AnyObject {
    func hogehoge()
}

class MogeClass {
    let delegate: HogeDelegate // let ã«ä¿®æ­£
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate // init ã§ã‚‚ã‚‰ã†ã‚ˆã†ã«ã™ã‚‹
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate.hogehoge()
    }
}

class FugaClass {
    lazy var mogeClass = MogeClass(delegate: self) // lazy var ã§ self ã‚’æ¸¡ã™ã‚ˆã†ã«ã™ã‚‹
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func fugafuga() {
        mogeClass.mogemoge()
    }
}

extension FugaClass: HogeDelegate {
    func hogehoge() {
        print("called hogehoge() on FugaClass")
    }
}
```

fugaClass ã® fugafuga() ã®å®Ÿè¡Œ

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
```

ã†ã‚“ã€‚å•é¡Œãªã„ã€‚


fugaClass init ã—ã¦ deinit ã™ã‚‹

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// deinit: FugaClass
```

MogeClass ãŒè§£æ”¾ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã«è¦‹ãˆã‚‹ãŒã€ãã‚‚ãã‚‚ç”Ÿæˆã•ã‚Œã¦ã„ãªã„ã®ã§ã€å•é¡Œãªã„ã€‚


fugaClass ã® fugafuga() ã®å®Ÿè¡Œã—ã¦ã€ãã‚Œã‹ã‚‰ fugaClass ã« nil ã‚’ä»£å…¥ã—ã¦ã¿ã‚‹

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
```

ã‚ã‚Œã€ã€ã€è§£æ”¾ã•ã‚Œã¦ã„ãªã„ã¿ãŸã„ã€‚ã€‚ã€‚

çµå±€ weak var ã«ã™ã‚‹

```swift
class MogeClass {
    weak var delegate: HogeDelegate? // çµå±€ weak var ã«ã™ã‚‹
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate?.hogehoge()
    }
}
```

å†Try

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
// deinit: FugaClass
// deinit: MogeClass
```

ã†ã¾ãã„ãã¾ã—ãŸãŒã€`lazy var` ã§ self ã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¦ã‚‚ã€ã‚„ã£ã±ã‚Š `weak var` ã‚’ã¤ã‘ãªã‚Œã°ã„ã‘ãªã„ã®ã§ã™ã­ã€‚ã€‚ã€‚

ãŸã ã€`private` ã‚’ã¤ã‘ã‚Œã°ã€å¤–ã‹ã‚‰ã®å¤‰æ›´ã¯é˜²ã’ã‚‹ã®ã§ã€ãã‚ŒãŒæ°—ã«ãªã‚‹æ–¹ã¯ãã†ã—ãŸæ–¹ãŒã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚

ã—ã‹ã—ã€ãã‚‚ãã‚‚ `lazy var` ã¨ã—ã¦ã„ã‚‹æ–¹ãŒã€å¤‰æ›´ã®ãƒªã‚¹ã‚¯ãŒç™ºç”Ÿã—ã¾ã™ãŒã€ã€ã€ã©ã£ã¡ãŒã„ã„ã‚“ã§ã—ã‚‡ã†ã­ã€‚

ã¾ãŸã€`private` ã‚’ã¤ã‘ã‚‹ã®ã§ã‚ã‚Œã°ã€init ã§ã® delegate ã®è¨­å®šã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã€`delegate` ã‚’ä½¿ã†éš›ã¯å¼·åˆ¶ã‚¢ãƒ³ãƒ©ãƒƒãƒ—ã—ã¦ã‚‚ã‚ˆã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã­ã€‚

```swift
class MogeClass {
    private weak var delegate: HogeDelegate? // private ã‚’ã¤ã‘ã‚‹
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate!.hogehoge() // å¼·åˆ¶ã‚¢ãƒ³ãƒ©ãƒƒãƒ—ã«ã™ã‚‹
    }
}
```

ã§ã‚‚ã€init ã§è¨­å®šã—ã¦ã„ã‚‹ã¯ãšãªã®ã« `delegate?` ã‚„ `delegate!` ã¨ã™ã‚‹ã®ã¯ãªã‚“ã‹ã„ã‘ã¦ã¾ã›ã‚“ã‚ˆã­ã€‚ã€‚ã€‚

`weak let` ãŒã‚ã‚Œã°ã€è§£æ±ºã§ããã†ã§ã™ãŒã€`weak let` ã‚’ä½¿ãŠã†ã¨ã™ã‚‹ã¨ã€Œ`error: 'weak' must be a mutable variable, because it may change at runtime`ã€ã¨æ€’ã‚‰ã‚Œã¾ã™ã€‚

ã©ã†ã‚„ã‚‰ `weak let` ã¯ãªã„ã¿ãŸã„ã§ã™ã­ã€‚ã€‚ã€‚

ãã“ã§ `unowned let` ãªã‚“ã§ã™ã‚ˆï¼

```swift
class MogeClass {
    private unowned let delegate: HogeDelegate // unowned ãªã‚‰ let ã‚’å®£è¨€ã§ãã‚‹
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate.hogehoge() // ? ã‚„ ! ã‚‚æ¶ˆã›ã‚‹
    }
}
```

å†Try

```swift
var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
// deinit: FugaClass
// deinit: MogeClass
```

ã†ã¾ãã„ãã¾ã—ãŸã­ã€‚

`lazy var` ã§ delegate ã¨ãªã‚‹ self ã‚’ init ã§æ¸¡ã™ã‚ˆã†ãªå ´åˆã¯ã€`unowned let` ã‚’ä½¿ã£ã¦ã‚‚è‰¯ã•ãã†ã§ã™ã­ã€‚

å…¨ä½“åƒã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```swift
protocol HogeDelegate: AnyObject {
    func hogehoge()
}

class MogeClass {
    private unowned let delegate: HogeDelegate
    
    init(delegate: HogeDelegate) {
        self.delegate = delegate
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func mogemoge() {
        delegate.hogehoge()
    }
}

class FugaClass {
    lazy var mogeClass = MogeClass(delegate: self)
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    func fugafuga() {
        mogeClass.mogemoge()
    }
}

extension FugaClass: HogeDelegate {
    func hogehoge() {
        print("called hogehoge() on FugaClass")
    }
}

var fugaClass: FugaClass? = FugaClass()
fugaClass?.fugafuga()
fugaClass = nil

// ï¼ˆå‡ºåŠ›ï¼‰
// called hogehoge() on FugaClass
// deinit: FugaClass
// deinit: MogeClass
```

çµè«–

delegate ã«å¯¾å¿œã—ãŸ self ã‚’è¨­å®šã—ã¦ã€å¼±å‚ç…§ã•ã›ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä»¥ä¸‹ã®2é€šã‚ŠãŒã‚ã‚‹ã€‚

- delegate ã‚’ä»£å…¥ã™ã‚‹éš›ã¯ `weak var` ã§å®£è¨€ã—ãŸå¤‰æ•°ã‚’ä½¿ã†
  - ãƒ¡ãƒªãƒƒãƒˆï¼šã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‚‹
  - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼šdelegate å¤‰æ•°ã®å¤–éƒ¨ã‹ã‚‰ã®å¤‰æ›´ã‚„ã€delegete ä»£å…¥å¿˜ã‚Œã®æã‚ŒãŒã‚ã‚‹
- `lazy var` ã§ delegate ã«é©å¿œã—ãŸ self ã‚’ init ã§æ¸¡ã™éš›ã¯ `unowned let` ã§å®£è¨€ã—ãŸå¤‰æ•°ã‚’ä½¿ã£ãŸæ–¹ãŒ
  - ãƒ¡ãƒªãƒƒãƒˆï¼š`weak var` ã‚’ä½¿ã†å ´åˆã«ã‚ã£ãŸã‚ˆã†ãªãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒãªããªã‚‹
  - ãƒ‡ãƒ¡ãƒªãƒƒãƒˆï¼š`lazy var` ã‚’ä½¿ã†å½±éŸ¿ã§ã€ãã¡ã‚‰ã®å¤‰æ•°ãŒå¤‰æ›´ã•ã‚Œã‚‹æã‚Œã‚„ã€init ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã‚ˆã£ã¦æ€ã‚ã¬ãƒã‚°ãŒç™ºç”Ÿã™ã‚‹