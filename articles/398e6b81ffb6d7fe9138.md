---
title: "ã€AWSã€‘ã€Serverless Frameworkã€‘ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šæ–¹æ³•ï¼ˆé–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®åˆ†é›¢ã‚‚è€ƒæ…®ï¼‰"
emoji: "ğŸŒ³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS","route53","APIGateway","CertificateManager","ServerlessFramework"]
published: true
---
# ã¯ã˜ã‚ã«

[ã“ã¡ã‚‰](https://qiita.com/sugurutakahashi12345/items/8eafa9ef6ce26531290a)ã®è¨˜äº‹ã®ç¶šç·¨ã§ã™ã€‚
ï¼ˆâ€» èª­ã¾ãªãã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚ï¼‰

Serverless Framework ã§ REST API ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€AWS å´ã§ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‰ãƒ¡ã‚¤ãƒ³ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚

```
https://5tjwpqfgo2.execute-api.us-east-1.amazonaws.com/dev/hello
```

ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å«ã¾ã‚Œã‚‹ `5tjwpqfgo2` ã¨ã„ã†å€¤ã¯ã€ã“ã¡ã‚‰ã§ä½•ã‚‚è¨­å®šã—ãªã„ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã”ã¨ã«æ¯å›å¤‰æ›´ã•ã‚Œã¦ã—ã¾ã„ã€ä½¿ã„å‹æ‰‹ãŒã‚ˆããªã„ã§ã™ã€‚

ãªã®ã§ã€ã“ã‚Œã‚’ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã§å›ºå®šã—ã‚ˆã†ã¨ã„ã†ã®ãŒã€ä»Šå›ã‚„ã‚ŠãŸã„ã“ã¨ã«ãªã‚Šã¾ã™ã€‚


# ã‚µãƒãƒªãƒ¼

ä»¥ä¸‹ã‚’ Serverless Framework ã§å®Ÿç¾ã—ã¾ã—ãŸã€‚

- ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨
- é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ç•°ãªã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨

ãã®çµæœã€REST API ã®ãƒ‘ã‚¹ãŒä»¥ä¸‹ã®ã‚ˆã†ã«å›ºå®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

- Before
  - URLï¼š`https://xxxxxxx.execute-api.us-east-1.amazonaws.com/dev/hello`
  - å‚™è€ƒï¼šURL ã® `xxxxxxx` ã®éƒ¨åˆ†ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã³ã«å¤‰ã‚ã‚‹
- After
  - é–‹ç™ºç’°å¢ƒ URLï¼š`https://dev.suguru-takahashi.com/api/hello`
  - æœ¬ç•ªç’°å¢ƒ URLï¼š`https://suguru-takahashi.com/api/hello`
  - å‚™è€ƒï¼šã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯å›ºå®šã§ã‚ã‚‹

å…¨ä½“æ§‹æˆå›³ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
![png.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/e6422002-aaa2-9515-a36a-05c90114ad30.png)


å…¨ä½“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://github.com/suguruTakahashi-1234/sls-hogehoge)ã«ã‚ã’ã¾ã—ãŸã€‚


# ã‚„ã‚ŠãŸã„ã“ã¨

ã‚„ã‚ŠãŸã„ã“ã¨ã¯ä»¥ä¸‹ã® 2 ã¤ã§ã™ã€‚

1. **ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨**
2. **é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ç•°ãªã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨**
 
ã“ã‚Œã‚’â†“

- ã‚«ã‚¹ã‚¿ãƒ åº¦åæŒ‡å®šå‰ï¼ˆBeforeï¼‰

```
https://5tjwpqfgo2.execute-api.us-east-1.amazonaws.com/dev/hello
```

ã“ã†ã—ãŸã„â†“

- ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³æŒ‡å®šå¾Œï¼ˆAfter ãã®1ï¼‰

```
https://mogemoge.suguru-takahashi.com/api/hello
```

ãã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ URL ã‚’åˆ†ã‘ãŸã„â†“

- é–‹ç™ºç’°å¢ƒï¼ˆAfter ãã®2ï¼‰

```
https://dev.suguru-takahashi.com/api/hello
```

- æœ¬ç•ªç’°å¢ƒï¼ˆAfter ãã®2ï¼‰

```
https://suguru-takahashi.com/api/hello
```

# å…¨ä½“æ§‹æˆå›³

- ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³æŒ‡å®šå‰ï¼ˆBeforeï¼‰
![1.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/82677080-8dd3-8d4b-2595-40635637ff35.png)

- ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³æŒ‡å®šå¾Œï¼ˆAfterï¼‰
![png.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/b79127c6-025b-2582-5ec5-7b98e1b4b3a6.png)


ã“ã®è¨˜äº‹ã§ã¯å¢—ç¯‰ã•ã‚ŒãŸéƒ¨åˆ†ã®è¨­å®šã®ä»•æ–¹ã«ã¤ã„ã¦è§¦ã‚Œã¾ã™ã€‚

# ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

## å‰æ

ä»¥ä¸‹ã®æ“ä½œã¯ã™ã¹ã¦æ¸ˆã‚“ã§ã„ã‚‹ã“ã¨ã‚’å‰æã«æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

- Serverless Framework é–¢é€£ã®æº–å‚™
  - ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¨­å®šã‚’é™¤ã„ãŸ serverless.yml ã®è¨­å®š
- ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³é–¢é€£ã®æº–å‚™
  - å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ or Route 53 ã§ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å–å¾—
  - Route 53 ã§ã®ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã®ä½œæˆ
  - ACM ã§ã® SSLè¨¼æ˜æ›¸ã®ä½œæˆ

ã“ã‚Œã‚‰ã®æ“ä½œã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚

ã€å‚è€ƒã€‘
- [Serverless Frameworkã§ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã™ã‚‹](https://qiita.com/motchi0214/items/0b43ba924a4814c503e1)
- [ã€Serverless Framework å…¥é–€ã€‘ API Gateway + Lambda + DynamoDB ã‚µãƒ³ãƒ—ãƒ«](https://qiita.com/sugurutakahashi12345/items/8eafa9ef6ce26531290a)ï¼ˆéå»è¨˜äº‹1ï¼‰
- [ã€AWSã€‘ Route 53 + ACM + CloudFront + S3 ã®æ§‹æˆã‚’æ§‹ç¯‰ã™ã‚‹éš›ã«ã¤ã¾ãšã„ãŸã¨ã“ã‚è§£èª¬](https://qiita.com/sugurutakahashi12345/items/bd99e6b32e4f5f0e8096)ï¼ˆéå»è¨˜äº‹2ï¼‰

## ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[serverless-domain-manager](https://github.com/amplify-education/serverless-domain-manager) ã¨ã„ã† npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã®ã§ Serverless Framework ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ Node.js ã§ä½¿ç”¨ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã„ã†ç¸›ã‚Šã¯ãªã„ã§ã™ã€‚ï¼ˆä¾‹ãˆã° Python ãªã©ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ä½¿ç”¨å¯èƒ½ï¼‰

```shell
# package.json ã®ä½œæˆï¼ˆã™ã§ã«ã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
$ npm init -y

# serverless-domain-manager ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ npm install serverless-domain-manager --save-dev
```

## serverless.yml ã®è¨­å®š

- plugins ã®è¨­å®š

`serverless-domain-manager` ã‚’è¿½è¨˜ã™ã‚‹ã ã‘ã§ã™ã€‚

```yml:serverless.yml
plugins:
  - serverless-domain-manager
```

- custom ã®è¨­å®š

`mogemoge.suguru-takahashi.com/api` ã¨ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹ä¾‹ã«ãªã‚Šã¾ã™ã€‚

```yml:serverless.yml
custom:
  customDomain:
    # API ã®ãƒ‘ã‚¹ã¯ `https://<domainName>/<basePath>/xxxx` ã¨ãªã‚‹
    domainName: mogemoge.suguru-takahashi.com
    basePath: api
    certificateName: '*.suguru-takahashi.com'
    createRoute53Record: true
    endpointType: 'regional'
    securityPolicy: tls_1_2
```

è©³ã—ã„è¨­å®šé …ç›®ã®èª¬æ˜ã¯ [serverless-domain-manager](https://github.com/amplify-education/serverless-domain-manager) ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ãã ã•ã„ã€‚

å®Ÿã®ã¨ã“ã‚ã€Serverless Framework ã‚’ä½¿ç”¨ã—ãªãã¦ã‚‚ã€ä»¥ä¸‹ã® AWS å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ“ä½œã‚’è¡Œãˆã°åŒã˜ã“ã¨ã¯å®Ÿç¾ã§ãã¾ã™ã€‚

ã€å‚è€ƒã€‘
ãƒ»[REST API ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’è¨­å®šã™ã‚‹](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/how-to-custom-domains.html)

`endpointType` ãªã©ã«ã¤ã„ã¦ã®è¨­å®šé …ç›®ã¯ä¸Šè¨˜ã® AWS å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è©³ã—ãèª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€äº‹å‰ã« Route 53 ã‚„ ACM ã®è¨­å®šã¯å¿…è¦ã§ã™ã€‚ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã§ã™ã€‚
![a.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/db895504-62dd-d475-db6b-61a4b9fc8bac.png)

## ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã® AWS ã¸ã®åæ˜ 

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ã€AWS ã«ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã‚’åæ˜ ã•ã›ã¾ã™ã€‚

```shell
$ sls create_domain
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã«ã‚ˆã£ã¦ Route 53 ã« A ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ AAAA ãƒ¬ã‚³ãƒ¼ãƒ‰ã® 2 ã¤ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
![b.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/70a34c96-e9c4-c739-aa9d-0bd374f59245.png)


ã€å‚è€ƒã€‘
ãƒ»[DNSãƒ¬ã‚³ãƒ¼ãƒ‰](https://qiita.com/leomaro7/items/7d717077dd9165357f16)

## ãƒ‡ãƒ—ãƒ­ã‚¤

```shell
$ sls deploy
```

## æŒ™å‹•ã®ç¢ºèª

Serverless Framework ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é…ç½®ã•ã‚Œã¦ã„ã‚‹ `/hello` ã® API ã§æŒ™å‹•ã‚’ç¢ºèªã—ã¾ã™ã€‚

- A. ä»Šã¾ã§é€šã‚Šã® AWS ãŒç™ºè¡Œã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã§ã¦ã„ã‚‹ AWS å´ã‹ã‚‰ç™ºè¡Œã•ã‚Œã‚‹ `https://xxxxx.execute-api.us-east-1.amazonaws.com/dev/hello` ã¨ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

â€» `/dev` ã®éƒ¨åˆ†ã¯ API Gateway å´ã®ã‚¹ãƒ†ãƒ¼ã‚¸åãŒåæ˜ ã•ã‚Œã¾ã™ã€‚Serverless Framework ã§ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¸åã¯ dev ã«ãªã‚Šã¾ã™ã€‚
![c.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/f3453a53-8278-36fa-8def-38c5eb71fd58.png)
ã‚‚ã¡ã‚ã‚“ã€è¨¼æ˜æ›¸ã¯ AWS ãŒç”¨æ„ã—ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚
![c-1.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/12195153-9546-6424-98a8-f23616bbea6a.png)


- B. ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ï¼ˆæœ¬å‘½ï¼‰

è¨­å®šã—ãŸä»¥ä¸‹ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ã—ã¾ã™ã€‚

```
https://mogemoge.suguru-takahashi.com/api/hello
```

![d.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/b6ff9b74-1750-18f3-fcbc-20b07fe4cb13.png)

è¨¼æ˜æ›¸ã¯ ACM ã«ç™»éŒ²ã—ãŸã‚‚ã®ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
![e.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/f562a415-27f2-d0fa-e8d9-db3712783b51.png)
API Gateway ã®è¨­å®šã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã®ç”»åƒã®ã‚ˆã†ã« Route 53 ã«æŒ¿å…¥ã•ã‚ŒãŸ A ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ AAAA ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å¯¾å¿œé€šã‚Šã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
![f.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/cef6a526-f628-7e01-2173-8832c139b17b.png)
serverless.yml ã§è¨­å®šã—ãŸ `basePath: api` ã‚‚åæ˜ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
![f-2.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/b3013136-a238-94e6-a200-52157202c78d.png)

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤

ã“ã¡ã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

```
$ sls remove
```

å…ˆã«ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã‚’å‰Šé™¤ã—ã¦ã—ã¾ã†ã¨ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã™ã‚‹ãŠãã‚ŒãŒã‚ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

## ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã®å‰Šé™¤

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ã€AWS ã«ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã‚’åæ˜ ã•ã›ã¾ã™ã€‚

```shell
$ sls delete_domain
```

Route 53 ã‚’ç¢ºèªã™ã‚‹ã¨ `sls create_domain` ã§ä½œæˆã•ã‚ŒãŸ A ãƒ¬ã‚³ãƒ¼ãƒ‰ãŠã‚ˆã³ AAAA ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
![g.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/f9c84fd6-2f09-c081-6655-38de53d2c793.png)

## é‹ç”¨

serverless-domain-manager ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ serverless.yml ã®è¨­å®šãŒå®Œäº†ã™ã‚Œã°ã€å®Ÿé‹ç”¨ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã—ãŸ REST API ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‹ã‚‰å‰Šé™¤ã¾ã§ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```shell
# ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆ
$ sls create_domain

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
$ sls deploy

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
$ sls remove

# ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤
$ sls delete_domain
```

Serverless Framework ã§ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã®åŸºç¤çš„ãªéƒ¨åˆ†ã¯ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚

# é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ç•°ãªã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

`sls create_domain` ã®å®Ÿè¡Œæ™‚ã« `sls deploy` ã®ã¨ãã¨åŒæ§˜ã«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã« `--stage <ã‚¹ãƒ†ãƒ¼ã‚¸å>` ã§ stage ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ãã‚Œã‚’åˆ©ç”¨ã—ã¦é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã§ç•°ãªã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚


## å‰æ

- ã€ãã® 1ï¼šã‚«ã‚¹ã‚¿ãƒ ã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨

## serverless.yml ã®è¨­å®š

å¤‰æ›´ã™ã‚‹ã®ã¯ `serverless.yml` ã®ã¿ã§ã™ã€‚
ã‚¹ãƒ†ãƒ¼ã‚¸åã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

- é–‹ç™ºç’°å¢ƒ
  - ã‚¹ãƒ†ãƒ¼ã‚¸åï¼š`dev`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  - ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š`dev.suguru-takahashi.com`
- æœ¬ç•ªç’°å¢ƒ
  - ã‚¹ãƒ†ãƒ¼ã‚¸åï¼š`prd`
  - ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼š`suguru-takahashi.com`

```yml:serverless.yml
custom:
  stage: ${opt:stage, self:provider.stage}
  endpoint:
    dev: "dev.suguru-takahashi.com"
    prd: "suguru-takahashi.com"
  customDomain:
    domainName: ${self:custom.endpoint.${self:custom.stage}}
    stage: ${self:custom.stage}
    basePath: api
    certificateName: '*.suguru-takahashi.com'
    createRoute53Record: true
    endpointType: 'regional'
    securityPolicy: tls_1_2
```

`custom.stage`, `custom.endpoint` ã¯ã¨ã„ã†åç§°ã¯å¼•æ•°åãªã®ã§ä½•ã§ã‚‚ã‚ˆã„ã§ã™ã€‚

ã“ã“ã§ã®ãƒã‚¤ãƒ³ãƒˆã¯ã‚¹ãƒ†ãƒ¼ã‚¸åã‚’ `domainName` ã«åŸ‹ã‚è¾¼ã‚€ã‚ˆã†ã«ã™ã‚‹ã¨æœ¬ç•ªç’°å¢ƒã®ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒ `prd.suguru-takahashi.com` ãªã£ã¦ã—ã¾ã„ `prd` ãŒæ ¼å¥½æ‚ªã„ã®ã§ã€`custom.endpoint` ã‚’ã‚¯ãƒƒã‚·ãƒ§ãƒ³ã«ãŠã„ã¦è‡ªç”±ãªã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## é–‹ç™ºç’°å¢ƒ

é–‹ç™ºç’°å¢ƒã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¹ãƒ†ãƒ¼ã‚¸åãŒ `dev` ãªã®ã§ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¨å‰Šé™¤ã®ã‚³ãƒãƒ³ãƒ‰ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```shell
# ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆ
$ sls create_domain

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
$ sls deploy

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
$ sls remove

# ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤
$ sls delete_domain
```

â€» ã‚‚ã¡ã‚ã‚“ã€`--stage dev` ã¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦ã‚‚åŒæ§˜ã®æŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚

## æœ¬ç•ªç’°å¢ƒ

é–‹ç™ºç’°å¢ƒã¨ã®é•ã„ã¯ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã« `--stage <ã‚¹ãƒ†ãƒ¼ã‚¸å>` ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚¹ãƒ†ãƒ¼ã‚¸åã‚’ `prd` ã¨æŒ‡å®šã—ã¦ã‚ã’ã‚‹ã ã‘ã§ã™ã€‚

```shell
# ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆ
$ sls create_domain --stage prd

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
$ sls deploy --stage prd

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤
$ sls remove --stage prd

# ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤
$ sls delete_domain --stage prd
```

â€» ã‚ãˆã¦ã€serverless.yml å†…ã§è¨­å®šã—ã¦ã„ãªã„ã‚ˆã†ãªã‚¹ãƒ†ãƒ¼ã‚¸åã‚’ `--stage <ã‚¹ãƒ†ãƒ¼ã‚¸å>` ã§ã‚ãŸã™ã¨ serverless.yml ã§ã®å¤‰æ•°åãŒè§£æ±ºã§ããšã€ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¦ãã‚Œã¾ã™ã€‚

## æŒ™å‹•ã®ç¢ºèª

é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã® AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ä¸¡æ–¹ã®ç’°å¢ƒãŒåˆ¥ã€…ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒãµã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

- Route 53
![x.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/326ad3c2-574d-9098-3512-75991d338824.png)

- API Gateway
![y.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/7082a120-0102-b2a2-6289-71f0b5e486d8.png)

ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚

# å‚è€ƒæ–‡çŒ®

- Serverless Framework å…¬å¼ã®ãƒ–ãƒ­ã‚°ã§ã®è§£èª¬
  - [How to set up a custom domain name for Lambda & API Gateway with Serverless](https://www.serverless.com/blog/serverless-api-gateway-domain)
- serverless-domain-manager
  - [serverless-domain-manager](https://github.com/amplify-education/serverless-domain-manager)
- ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸè¨˜äº‹
  - [[AWS] Serverless Frameworkã§ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’SSLä»˜ãã§è¨­å®šã™ã‚‹](https://blog.katsubemakito.net/aws/lambda-with-serverless-framework2)
- é–‹ç™ºç’°å¢ƒ/æœ¬ç•ªç’°å¢ƒã®åˆ‡ã‚Šæ›¿ãˆã§å‚è€ƒã«ãªã£ãŸè³‡æ–™
