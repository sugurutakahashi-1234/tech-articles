---
title: "[Swift] [Combine] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã«å€¤ã‚’æŒãŸã›ãªã„æ–¹æ³•"
emoji: "ğŸŒ¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift"]
published: true
---

# ä¼ãˆãŸã„ã“ã¨

- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã«å€¤ã‚’æŒãŸã›ãªã„æ–¹æ³•
  - ã€å€¤ã€ã¨ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enumã€ ã‚’åˆ†é›¢ã™ã‚‹
  - ã€å€¤ã€ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«å¯¾å¿œã—ã¦ã€ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enumã€ã‚’æ›´æ–°ã™ã‚‹
    - å®£è¨€çš„ãªè¨˜è¿°ãŒã§ãã‚‹ `Combine` ã§è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã‚ªã‚¹ã‚¹ãƒ¡ï¼ˆ`didSet` ã¯ã‚„ã‚ã‚ˆã†ï¼ï¼‰
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã«å€¤ã‚’æŒãŸã›ãªã„ã“ã¨ã®ãƒ¡ãƒªãƒƒãƒˆ
  - ViewModelå´ã®ãƒ¡ãƒªãƒƒãƒˆ: ã€APIã®å‘¼ã³å‡ºã—ã€ã¨ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®æ›´æ–°ã€ã‚’åˆ†ã‘ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
  - Viewå´ã®ãƒ¡ãƒªãƒƒãƒˆ: ã€å€¤ã€ã¨ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enumã€ ã®é–¢å¿ƒäº‹ã‚’åˆ†é›¢ã§ãã‚‹
- å‰æã¨ã—ã¦ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã«å€¤ã‚’æŒãŸã›ãªã„æ–¹ãŒã‚ˆã„ï¼ˆã¯ãšï¼‰
  - ï¼ˆã¨ã„ã†ã‚ˆã‚Šã‚‚ãã‚‚ãã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã¯å¿…è¦ã§ã‚ã‚Œã°ã€ãã®å€¤ã‚’ç®¡ç†ã™ã¹ãã§ã‚ã‚‹ãŒã€ç”»é¢ã”ã¨ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ã¯ãªãã€å…±é€šã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æç”»ã™ã‚‹ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿ã§ã€ãã®å€¤ã‚’ç”¨ã„ã‚‹ã‚ˆã†ã«ã—ãŸæ–¹ãŒè‰¯ã„ï¼‰ï¼ˆã“ã®è¨˜äº‹ã§ã¯ãã‚Œã«ã¤ã„ã¦ç‰¹ã«è§¦ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ï¼‰


# å‰æ

ä»¥ä¸‹ã®ã‚ˆã†ãªã€`HogeResponse` ã¨ `MogeResponse` ã®2ã¤ã® API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦å—ã‘å–ã¨ã‚‹ç”»é¢ã«ãŠã„ã¦ã€ç”»é¢å´ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®çŠ¶æ…‹ã«åˆã‚ã›ã¦ UI ã‚’å¤‰åŒ–ã•ã›ã‚‹ãŸã‚ã®å¤‰æ•°ï¼ˆ`LoadState`ï¼‰ã‚’å…¬é–‹ã™ã‚‹ `ObservableObject` ã‚’é©å¿œã•ã›ãŸ class ã‚’è€ƒãˆã¾ã™ã€‚

```swift
struct HogeResponse {
    let hoge: Int
}

struct MogeResponse {
    let moge: Int
}

struct TestError: Error {}
```

# ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã«å€¤ã‚’æŒãŸã›ãŸå ´åˆ

## ViewModel ã®å®Ÿè£…

```swift
enum LoadState {
    case notLoad
    case loading
    case loaded(Result<(HogeResponse, MogeResponse), TestError>) // å€¤ã‚’æŒãŸã›ã‚‹
}

class ViewModel: ObservableObject {
    @Published private(set) var loadState: LoadState = .notLoad

    func onAppear() async {
        loadState = .loading

        // API ã®å‘¼ã³å‡ºã—ï¼ˆçœç•¥ã—ãŸè¨˜è¿°ï¼‰
        // HogeResponse ã®å–å¾—
        let hogeResponse = HogeResponse(hoge: 1)
        // MogeResponse ã®å–å¾—
        let mogeResponse = MogeResponse(moge: 2)

        loadState = .loaded(.success((hogeResponse, mogeResponse)))
    }
}
```

## View å´ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```swift
var cancellables: Set<AnyCancellable> = []
let viewModel = ViewModel()

viewModel.$loadState
    .sink { completion in
        switch completion {
        case .finished:
            print("finished: \(completion)")

        case let .failure(error):
            print("error: \(error)")
        }
    } receiveValue: { result in
        switch result {
        case .notLoad:
            print("notLoad: \(result)")

        case .loading:
            print("loading: \(result)")

        case .loaded(.success((let hogeResponse, let mogeResponse))):
            print("loaded: (hogeResponse: \(hogeResponse), mogeResponse: \(mogeResponse))")

        case .loaded(.failure(let error)):
            print("error: \(error)")
        }
    }
    .store(in: &cancellables)
```

## ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å‡¦ç†

```swift
Task {
    await viewModel.onAppear()
}

// notLoad: notLoad
// loading: loading
// loaded: (hogeResponse: HogeResponse(hoge: 1), mogeResponse: MogeResponse(moge: 2))
```

# ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã«å€¤ã‚’æŒãŸã›ãªã„å ´åˆ

## ViewModel ã®å®Ÿè£…

```swift
enum LoadState {
    case notLoad
    case loading
    case loaded // å€¤ã‚’æŒãŸã›ãªã„
}

class ViewModel: ObservableObject {
    @Published private(set) var loadState: LoadState = .notLoad
    @Published private(set) var error: TestError?
    @Published private(set) var hogeResponse: HogeResponse?
    @Published private(set) var mogeResponse: MogeResponse?
    private var cancellables: Set<AnyCancellable> = []

    init() {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã‚’ $hogeResponse ã¨ $mogeResponse ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‹ã‚‰ç”Ÿæˆã™ã‚‹
        $hogeResponse
            .combineLatest($mogeResponse)
            .map { hogeResponse, mogeResponse -> LoadState in
                switch (hogeResponse, mogeResponse) {
                case (.none, .none):
                    return .notLoad

                case (.some, .none):
                    return .loading
                    
                case (.none, .some):
                    return .loading
                    
                case (.some, .some):
                    return .loaded
                }
            }
            .removeDuplicates()
            .assign(to: \.loadState, on: self)
            .store(in: &cancellables)
    }

    func onAppear() async {
        // API ã®å‘¼ã³å‡ºã—ï¼ˆçœç•¥ã—ãŸè¨˜è¿°ï¼‰
        // HogeResponse ã®å–å¾—
        hogeResponse = HogeResponse(hoge: 1)
        // MogeResponse ã®å–å¾—
        mogeResponse = MogeResponse(moge: 2)
    }
}
```

ä¸€è¦‹ã€è¤‡é›‘ã«ãªã‚Šã¾ã—ãŸãŒã€`init()` ã§ã¯ `hogeResponse` ã‚„ `mogeResponse` ã®å€¤ã«å¿œã˜ã¦ `loadState` ã®å€¤ã‚’æ›´æ–°ã—ã¦ã€`onAppear()` ã§ã¯ API ã®å‘¼ã³å‡ºã—ã®å‡¦ç†ã‚’ã—ã¦ã„ã‚‹ã ã‘ã«ãªã‚Šã¾ã™ã€‚

`ãƒ‘ã‚¿ãƒ¼ãƒ³1` ã¨æ¯”è¼ƒã—ã¦ã€è¨˜è¿°é‡ã¯å¢—ãˆã¾ã—ãŸãŒã€`onAppear()` ã§ã‚„ã‚‹ã“ã¨ãŒã€API ã®å‘¼ã³å‡ºã—ã«é›†ä¸­ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## View å´ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

`ãƒ‘ã‚¿ãƒ¼ãƒ³1` ã¨æ¯”è¼ƒã—ã¦ã€Viewå´ã®è¨˜è¿°ãŒåœ§å€’çš„ã«æ¸›ã‚Šã¾ã™ã€‚

```swift
var cancellables: Set<AnyCancellable> = []
let viewModel = ViewModel()

viewModel.$loadState
    .sink(receiveValue: { print("loadState: \($0)") })
    .store(in: &cancellables)

viewModel.$error
    .compactMap { $0 }
    .sink(receiveValue: { print("error: \($0)") })
    .store(in: &cancellables)

viewModel.$hogeResponse
    .compactMap { $0 }
    .sink(receiveValue: { print("hogeResponse: \($0)") })
    .store(in: &cancellables)

viewModel.$mogeResponse
    .compactMap { $0 }
    .sink(receiveValue: { print("mogeResponse: \($0)") })
    .store(in: &cancellables)
```

## ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å‡¦ç†

```swift
Task {
    await viewModel.onAppear()
}

// loadState: notLoad
// loadState: loading
// hogeResponse: HogeResponse(hoge: 1)
// loadState: loaded
// mogeResponse: MogeResponse(moge: 2)
```

# ä¼ãˆãŸã„ã“ã¨ï¼ˆãŠã•ã‚‰ã„ï¼‰

- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã«å€¤ã‚’æŒãŸã›ãªã„æ–¹æ³•
  - ã€å€¤ã€ã¨ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enumã€ ã‚’åˆ†é›¢ã™ã‚‹
  - ã€å€¤ã€ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«å¯¾å¿œã—ã¦ã€ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enumã€ã‚’æ›´æ–°ã™ã‚‹
    - å®£è¨€çš„ãªè¨˜è¿°ãŒã§ãã‚‹ `Combine` ã§è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã‚ªã‚¹ã‚¹ãƒ¡ï¼ˆ`didSet` ã¯ã‚„ã‚ã‚ˆã†ï¼ï¼‰
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã«å€¤ã‚’æŒãŸã›ãªã„ã“ã¨ã®ãƒ¡ãƒªãƒƒãƒˆ
  - ViewModelå´ã®ãƒ¡ãƒªãƒƒãƒˆ: ã€APIã®å‘¼ã³å‡ºã—ã€ã¨ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®æ›´æ–°ã€ã‚’åˆ†ã‘ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
  - Viewå´ã®ãƒ¡ãƒªãƒƒãƒˆ: ã€å€¤ã€ã¨ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enumã€ ã®é–¢å¿ƒäº‹ã‚’åˆ†é›¢ã§ãã‚‹
- å‰æã¨ã—ã¦ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã«å€¤ã‚’æŒãŸã›ãªã„æ–¹ãŒã‚ˆã„ï¼ˆã¯ãšï¼‰
  - ï¼ˆã¨ã„ã†ã‚ˆã‚Šã‚‚ãã‚‚ãã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ã™ enum ã¯å¿…è¦ã§ã‚ã‚Œã°ã€ãã®å€¤ã‚’ç®¡ç†ã™ã¹ãã§ã‚ã‚‹ãŒã€ç”»é¢ã”ã¨ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ã¯ãªãã€å…±é€šã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æç”»ã™ã‚‹ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿ã§ã€ãã®å€¤ã‚’ç”¨ã„ã‚‹ã‚ˆã†ã«ã—ãŸæ–¹ãŒè‰¯ã„ï¼‰ï¼ˆã“ã®è¨˜äº‹ã§ã¯ãã‚Œã«ã¤ã„ã¦ç‰¹ã«è§¦ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ï¼‰

ä»¥ä¸Šã§ã™ã€‚