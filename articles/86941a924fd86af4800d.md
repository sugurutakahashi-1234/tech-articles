---
title: "ã‚µã‚¤ãƒœã‚¦ã‚ºæ–°äººç ”ä¿®ã®ã€ŒKubernetes ã‚’ä½¿ã£ãŸé–‹ç™ºå…¥é–€ã€ã‚’è§¦ã£ã¦ã¿ãŸå‚™å¿˜éŒ²"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kubernetes","minikube"]
published: true
---

# ã¯ã˜ã‚ã«

[ã‚µã‚¤ãƒœã‚¦ã‚ºã®æ–°äººç ”ä¿®ã®è³‡æ–™](https://blog.cybozu.io/entry/2019/09/05/080000)ãŒå…¬é–‹ã•ã‚Œã¦ãŠã‚Šã€ãã“ã« [ã€ŒKubernetes ã‚’ä½¿ã£ãŸé–‹ç™ºå…¥é–€ã€](https://cybozu.github.io/introduction-to-kubernetes/) ãªã‚‹ç ”ä¿®è³‡æ–™ãŒã‚ã£ãŸã®ã§ã€ãã¡ã‚‰ã‚’ Kubernetes åˆå¿ƒè€…ãŒè§¦ã£ã¦ã¿ãŸå‚™å¿˜éŒ²ã«ãªã‚Šã¾ã™ã€‚

è§£èª¬ã¯æœ¬å®¶ã®ã‚µã‚¤ãƒˆãŒã¨ã¦ã‚‚è©³ã—ãè§£èª¬ã—ã¦ã‚ã‚‹ã®ã§ã€è©³ã—ã„è§£èª¬ã‚’æ±‚ã‚ã‚‹æ–¹ã¯ãã¡ã‚‰ã‚’å‚ç…§ãã ã•ã„ã€‚
ã¾ãŸã€kubectl ã‚³ãƒãƒ³ãƒ‰ã«ã¤ã„ã¦ã‚‚ã»ã¨ã‚“ã©è§£èª¬ã—ã¾ã›ã‚“ãŒ [ã“ã¡ã‚‰](https://qiita.com/Veritas666777/items/6609844efe88e7b333b6) ã®è¨˜äº‹ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚

# æ„Ÿæƒ³
è§¦ã£ã¦ã¿ãŸæ„Ÿæƒ³ã§ã™ãŒã€ã‹ãªã‚Šåˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã®ã§ Kubernetes ã‚’å…¥é–€ã™ã‚‹ã«ã¯ã‚ªã‚¹ã‚¹ãƒ¡ã ã¨æ€ã„ã¾ã™ã€‚

ãã®è¾ºã® Kubernetes é–¢é€£ã®è¨˜äº‹ã‚„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’èª­ã‚€ã¨ãã®ç†è§£åº¦ãŒã€ã“ã¡ã‚‰ã®ç ”ä¿®ã‚’å‹•ã‹ã—ãŸå‰ã¨å¾Œã§ã¯å…¨ãé•ã†ã®ã§ã€ã¨ã¦ã‚‚ãŸã‚ã«ãªã‚Šã¾ã—ãŸã€‚

# ç ”ä¿®è³‡æ–™ã«ã¤ã„ã¦

ä»¥ä¸‹ã® 3 éƒ¨æ§‹æˆã§ã™ã€‚

- Introduction to Kubernetes
- More Introduction to Kubernetes
- Exercise

ã€ŒIntroduction to Kubernetesã€ãŒå…¥é–€ç·¨ã®ãƒ¡ã‚¤ãƒ³ã«ãªã£ã¦ãŠã‚Šã€ã€ŒMore Introduction to Kubernetesã€ã¯ "æœ¬ç•ªé‹ç”¨ã‚’æƒ³å®šã—ãŸã‚‰ã“ã†ã„ã†ã“ã¨ã‚‚è€ƒãˆã‚‹å¿…è¦ã‚ã‚Šã¾ã™ã‚ˆ" ã¨ã„ã†ã‚ˆã†ãªã‚„ã‚„å¿œç”¨çš„ãªå†…å®¹ã«ãªã‚Šã¾ã™ã€‚ã€ŒExerciseã€ã¯æ¼”ç¿’å•é¡Œã§ã™ãŒã“ã¡ã‚‰ã¯æ‰‹ã‚’ã¤ã‘ã¦ãªã„ã§ã™ï¼ˆç”˜ãˆï¼‰ã€‚

ã“ã®è¨˜äº‹ã¯ã€ŒIntroduction to Kubernetesã€ã«ã¤ã„ã¦ã¯æ‰‹åšã‚ã«è¨˜è¼‰ã—ã¾ã™ã€‚

ã€ŒMore Introduction to Kubernetesã€ã®å†…å®¹ã«ã¤ã„ã¦ã¯è§¦ã‚Šã ã‘è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

# Introduction to Kubernetes

åŸºæœ¬ç·¨ã§ã™ã€‚

## Kubernetes ç’°å¢ƒã‚’æ•´ãˆã‚‹

Minikube ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

Minikube ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ãƒ‰ã® Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

è¤‡æ•°ãƒãƒ¼ãƒ‰ã® Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã¯ Minikube ã§ã¯ã§ããªã„ã‚ˆã†ã§ã™ã€‚

ã¾ãŸã€Minikube ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ Docker ã®è¨­å®šã§ `CPUs:2` ä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚
ï¼ˆ`CPUs:1` ã§ã¯æ€’ã‚‰ã‚Œã¦ Minikube ã‚’èµ·å‹•ã—ã¾ã›ã‚“ã§ã—ãŸã€‚ï¼‰

### Kubernetes ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹

```
# Minikube ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$ brew install minikube

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
$ minikube version
minikube version: v1.12.3
commit: 2243b4b97c131e3244c5f014faedca0d846599f5

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
$ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured

# ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®èµ·å‹•
$ minikube dashboard
```

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![a.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/e9d9543c-c1b0-a64c-f99e-85d6bfc7cc18.png)


## Kubernetes ä¸Šã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹

Kubernetes ä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹æœ€å°å˜ä½ã¯ Pod ã¨ã„ã†å˜ä½ã«ãªã‚Šã¾ã™ã€‚
Pod ã¯ã²ã¨ã¤ä»¥ä¸Šã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚ åŒã˜ Pod ã«å±ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã¯å¸¸ã«åŒã˜ãƒãƒ¼ãƒ‰ã«é…ç½®ã•ã‚Œã¾ã™ã€‚

æ¦‚å¿µçš„ã«ã¯ Container < Pod < Node ã¨ã„ã†é †ã§ã¾ã¨ã¾ã£ãŸå˜ä½ã«ãªã‚Šã¾ã™ã€‚

ã¡ãªã¿ã« Minikube ã¯ Node ã«ãªã‚Šã¾ã™ã€‚

Kubernetes ä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ Pod ã‚’è¨­å®šã—ãŸ YAML ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ã‚’ã—ã¾ã™ã€‚

ä¸€æ—¦ã€ä»¥ä¸‹ã®å†…å®¹ã§è¨˜è¿°ã—ã¾ã™ã€‚

```yaml:nginx-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-first-pod
  labels:
    component: nginx
spec:
  containers:
    - name: nginx
      image: nginx:latest
```

`kubectl apply -f [applyã™ã‚‹YAMLãƒ•ã‚¡ã‚¤ãƒ«å]` ã‚³ãƒãƒ³ãƒ‰ã§ Kubernetes ä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```
# Kubernetes ã¸ã® apply
$ kubectl apply -f nginx-pod.yaml
pod/my-first-pod created

# ã‚¯ãƒ©ã‚¹ã‚¿å†…ã® Pod ã®ä¸€è¦§ã‚’è¡¨ç¤º
$ kubectl get pod
NAME           READY   STATUS    RESTARTS   AGE
my-first-pod   1/1     Running   0          103s

# Pod ã®è©³ç´°ã‚’è¡¨ç¤º
$ kubectl describe pod my-first-pod
Name:         my-first-pod
Namespace:    default
Priority:     0
Node:         minikube/172.17.0.3
Start Time:   Sat, 15 Aug 2020 04:15:37 +0900
Labels:       component=nginx
ï¼ˆçœç•¥ï¼‰
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  5m5s   default-scheduler  Successfully assigned default/my-first-pod to minikube
  Normal  Pulling    5m4s   kubelet, minikube  Pulling image "nginx:latest"
  Normal  Pulled     4m50s  kubelet, minikube  Successfully pulled image "nginx:latest"
  Normal  Created    4m50s  kubelet, minikube  Created container nginx
  Normal  Started    4m50s  kubelet, minikube  Started container nginx

# Pod ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³
kubectl exec -it my-first-pod -- /bin/bash

# curl ã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
root@my-first-pod:/# apt update && apt install -y curl
ï¼ˆçœç•¥ï¼‰

# localhost:80 ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆç–é€šç¢ºèªï¼‰
root@my-first-pod:/# curl -i localhost:80
HTTP/1.1 200 OK
ï¼ˆçœç•¥ï¼‰
```

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« my-first-pod ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![b.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/78cdd860-0d1e-0087-4e56-d47399fde5b1.png)


## ä»–ã® Pod ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

Pod - Pod é–“ã®ç–é€šã‚’ç¢ºèªã—ã¾ã™ã€‚

my-first-pod ã¨ã¯åˆ¥ã® Pod ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```yaml:bastion.yaml
apiVersion: v1
kind: Pod
metadata:
  name: bastion
spec:
  containers:
    - name: bastion
      image: debian:stretch
      command: ["sleep", "infinity"]
```

ã¡ãªã¿ã« bastion ã¯ã€Œè¸ã¿å°ã€ã¨ã„ã†æ„å‘³ã«ãªã‚Šã¾ã™ã€‚

bastion -> my-first-pod (nginx) ã¸ã®ç–é€šã‚’ç¢ºèªã—ã¾ã™ã€‚

```
# Kubernetes ã¸ã® apply
$ kubectl apply -f bastion.yaml
pod/bastion created

# Pod ã®ä¸€è¦§è¡¨ç¤º
$ kubectl get pod
NAME           READY   STATUS    RESTARTS   AGE
bastion        1/1     Running   0          14s
my-first-pod   1/1     Running   1          10h

# IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¡¨ç¤º
$ kubectl get pod -o wide
NAME           READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
bastion        1/1     Running   0          84s   172.18.0.6   minikube   <none>           <none>
my-first-pod   1/1     Running   1          10h   172.18.0.2   minikube   <none>           <none>

# bastion ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ `my-first-pod` ã®v IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã® `172.18.0.2` ã«ã‚¢ã‚¯ã‚»ã‚¹
$ kubectl exec -it bastion -- bash
(bastion)# apt update && apt install -y curl
(bastion)# curl -i http://172.18.0.2/
HTTP/1.1 200 OK
ï¼ˆçœç•¥ï¼‰
```
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« bastion ãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
![c.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/f8ce8d86-a32b-405f-81e6-dd5d04370a6b.png)


## Service ã‚’ä½¿ã£ã¦ä»–ã® Pod ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

ã•ãã»ã©ã€Pod - Pod é–“ã®ç–é€šã‚’è©¦ã—ã¾ã—ãŸãŒã€Pod ã¯æ¶ˆãˆãŸã‚Šå¢—ãˆãŸã‚Šã™ã‚‹ã‚‚ã®ãªã®ã§ã€IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰ã‚ã£ã¦ã—ã¾ã„ Pod ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã—ã¦é€šä¿¡ã‚’è¡Œã†ã®ã¯ã‚ˆããªã„ã§ã™ã€‚

ãã“ã§ç‰¹å®šã® Pod ã§ã¯ãªãã€Œæ‰€æœ›ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ Pod ã®ã©ã‚Œã‹ã€ã¨é€šä¿¡ã™ã‚‹ãŸã‚ã®å®‰å®šã—ãŸ(=å¤‰åŒ–ã—ãªã„)ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ¬²ã—ããªã‚Šã¾ã™ã€‚

ãã“ã§ã€æ™®é€šä»–ã® Pod ã¨ã®é€šä¿¡ã™ã‚‹ã¨ãã«ã¯ Service ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚ Service ã‚’ä½¿ã†ã¨ã€Œã‚ã‚‹ç‰¹å®šã® Podã€ã§ã¯ãªãã€Œç‰¹å®šã® ãƒ©ãƒ™ãƒ« ã‚’æŒã¤ Pod ã®ã©ã‚Œã‹ã€ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ©ãƒ™ãƒ«ã¨ã„ã†ã®ã¯ã€ä¸Šã® nginx ã®ä¾‹ã ã¨ `component: nginx` ã®éƒ¨åˆ†ã§ã™ã€‚ ã“ã“ã§ã® component ã‚„ nginx ãŒç‰¹åˆ¥ãªæ„å‘³ã‚’æŒã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªãã€åˆ©ç”¨è€…ãŒå¥½ããªæ–‡å­—åˆ—ã‚’æŒ‡å®šã§ãã¾ã™ã€‚

ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ãª Service ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```yaml:nginx-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-first-service
spec:
  selector:
    component: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
```

Service ã‚’ Kubernetes ã¸ apply ã—ã¾ã™ã€‚

apply ã®æ–¹æ³•ã¯ Pod ã¨åŒã˜ã«ãªã‚Šã¾ã™ã€‚

```
$ kubectl apply -f nginx-service.yaml
service/my-first-service created

$ kubectl get service
NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
kubernetes         ClusterIP   10.96.0.1      <none>        443/TCP   12h
my-first-service   ClusterIP   10.101.46.86   <none>        80/TCP    3m7s
```

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« my-first-service ãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
![d.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/ddf8bb76-bdf8-c489-f3f3-67e7c782f0ec.png)

bastion ã® Pod ã‹ã‚‰ my-first-service ã‚’é€šã—ã¦ `component: nginx` ã§ãƒ©ãƒ™ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹ my-first-pod ã® Pod ã«å…ˆã»ã©åŒæ§˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚

```
$ kubectl exec -it bastion -- bash
root@bastion:/# curl -i http://my-first-service/
HTTP/1.1 200 OK
ï¼ˆçœç•¥ï¼‰
```

å›³ã§è¡¨ã™ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![f.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/a4c3ccde-1f9b-26f3-877f-a2648c05468a.png)



## åŒã˜ Pod ã‚’ã„ãã¤ã‚‚ç«‹ã¦ã‚‹

å‰ã®ç¯€ã§ã¯ nginx ã‚’ä¸€å°ç«‹ã¡ä¸Šã’ã¾ã—ãŸã€‚ å®Ÿéš›ã®é‹ç”¨ç’°å¢ƒã§ã¯å†—é•·æ€§ã‚„ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®ãŸã‚ã«ä¸€ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¤‡æ•°å°ã® Pod ã§æ§‹æˆã™ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚ ã“ã“ã§ã¯ Kubernetes ã® ReplicaSet ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ©ç”¨ã—ã¦ nginx ã‚’æŒ‡å®šã—ãŸå°æ•°ã ã‘ç«‹ã¡ä¸Šã’ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ä»¥ä¸‹ãŒä»Šå›ä½¿ç”¨ã™ã‚‹ ReplicaSet ã®å®šç¾©ã«ãªã‚Šã¾ã™ã€‚

```yaml:nginx-replicaset.yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx-replicaset
  labels:
    component: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      component: nginx
  template:
    metadata:
      labels:
        component: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:latest
```

è©³ã—ã„èª¬æ˜ã¯çœç•¥ã—ã¾ã™ãŒã€ReplicaSet ã¯ã€Œselector ã«ãƒãƒƒãƒã™ã‚‹ Pod ã®æ•°ã€ãŒã€Œreplicas ã«æŒ‡å®šã—ãŸæ•°ã€ã«ãªã‚‹ã‚ˆã†ã« Pod ã‚’è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚Šå‰Šé™¤ã—ãŸã‚Šã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚


ã¨ã‚Šã‚ãˆãš apply ã—ã¦ pod ã®æ•°ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```
$ kubectl get pod
NAME           READY   STATUS    RESTARTS   AGE
bastion        1/1     Running   0          109m
my-first-pod   1/1     Running   1          12h

$ kubectl apply -f nginx-replicaset.yaml
replicaset.apps/nginx-replicaset created

$ kubectl get replicaset
NAME               DESIRED   CURRENT   READY   AGE
nginx-replicaset   3         3         3       13s

$ kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
bastion                  1/1     Running   0          110m
my-first-pod             1/1     Running   1          12h
nginx-replicaset-wqcdk   1/1     Running   0          28s
nginx-replicaset-xbs28   1/1     Running   0          28s
```

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ã¿ã‚‹ã¨ Pod ãŒ 3ã¤ã‚ãŒã£ã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚
![g.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/2b85826b-4a72-5372-4976-cc31965d535f.png)


ã“ã“ã§è©¦ã—ã« Pod ã‚’ä¸€ã¤æ¶ˆã—ã¦ã¿ã¾ã™ã€‚
Pod ã‚’æ¶ˆã—ã¦ã¿ã¦ã‚‚ã¾ãŸã™ãã« Pod ãŒ 3 ã¤ã«ãªã‚‹ã‚ˆã†ã«ç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚

```
$ kubectl delete pod my-first-pod
pod "my-first-pod" deleted

$ kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
bastion                  1/1     Running   0          123m
nginx-replicaset-dn57j   1/1     Running   0          9s
nginx-replicaset-wqcdk   1/1     Running   0          13m
nginx-replicaset-xbs28   1/1     Running   0          13m
```

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã‚‚å¤‰ã‚ã‚‰ãš Pod ãŒ 3ã¤ã‚ãŒã£ã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚

![h.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/3d582027-ad72-7081-28db-b250297b7bf0.png)


ã¤ã¥ã„ã¦ `replicas: 3` -> `replicas: 4` ã«å¤‰æ›´ã—ã¦ apply ã—ã¦ã¿ã¾ã™ã€‚

```
$ kubectl apply -f nginx-replicaset.yaml
replicaset.apps/nginx-replicaset configured

$ kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
bastion                  1/1     Running   0          126m
nginx-replicaset-5swkc   1/1     Running   0          7s
nginx-replicaset-dn57j   1/1     Running   0          3m33s
nginx-replicaset-wqcdk   1/1     Running   0          16m
nginx-replicaset-xbs28   1/1     Running   0          16m
```

nginx ã® Pod ãŒ 4 ã¤ã«ãªã‚Šã¾ã—ãŸã­ã€‚

ã‚‚ã¡ã‚ã‚“ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã‚‚ç¢ºèªã§ãã¾ã™ã€‚
![i.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/841b8f22-7298-937d-2bbd-47e81e3fb3ff.png)

ã•ã‚‰ã«ã“ã®çŠ¶æ…‹ã‹ã‚‰ ReplicaSet ã‚’å‰Šé™¤ã—ã¦ã¿ã¾ã™ã€‚

```
$ kubectl delete replicaset nginx-replicaset
replicaset.apps "nginx-replicaset" deleted

$ kubectl get pod
NAME                     READY   STATUS        RESTARTS   AGE
bastion                  1/1     Running       0          163m
nginx-replicaset-5swkc   0/1     Terminating   0          37m
nginx-replicaset-dn57j   0/1     Terminating   0          40m
nginx-replicaset-wqcdk   0/1     Terminating   0          54m
nginx-replicaset-xbs28   0/1     Terminating   0          54m
```

nginx ã® Pod ãŒãªããªã‚Šã¾ã—ãŸã­ã€‚

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèªã™ã‚‹ã¨ nginx ã® Pod ã‚‚ ReplicaSet ã‚‚æ¶ˆãˆã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
![j.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/10b22af7-c266-6e75-e7db-29074045f138.png)



## ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹

Kubernetes ã§ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è¡Œã†ã«ã¯ Deployment ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ Deployment ã¯ ReplicaSet ã¨ä¼¼ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ãŒã€ReplicaSet ã¨é•ã£ã¦ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ã¡ãªã¿ã« Deployment ã‚’ä½¿ã‚ãšã«  ReplicaSet ã§ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’è¡Œã†å ´åˆã¯ä»¥ä¸‹ã®å›³ã®ã‚ˆã†ãªæ‰‹é †ã‚’è¸ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![j2.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/ff9ea3ab-4057-9b7a-84c3-153abb9d7d41.png)


ã“ã®è¤‡é›‘ãªæ‰‹é †ãŒ Deployment ã‚’ä½¿ã†ã¨ Kubernetes ã«ã‚„ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šå›ä½¿ç”¨ã™ã‚‹ Deployment ã® YAML ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã»ã¨ã‚“ã© ReplicaSet ã¨åŒã˜ã§ã™ã€‚

```yaml:nginx-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    component: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      component: nginx
  template:
    metadata:
      labels:
        component: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.15
```

Deployment ã‚’ apply ã—ã¦ã¿ã¾ã™ã€‚

```
$ kubectl apply -f nginx-deployment.yaml
deployment.apps/nginx-deployment created

$ kubectl get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           40s

# ç¢ºèªï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã« IMAGE ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼‰
$ kubectl get pod -o 'custom-columns=NAME:.metadata.name,IMAGE:.spec.containers[*].image,PHASE:.status.phase'
NAME                                IMAGE            PHASE
bastion                             debian:stretch   Running
nginx-deployment-77bc96745b-9tdr2   nginx:1.15       Running
nginx-deployment-77bc96745b-kg96q   nginx:1.15       Running
nginx-deployment-77bc96745b-xn4v6   nginx:1.15       Running
```

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã§ã¯ã“ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![k.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/caff7132-92c3-0e00-0606-896961d38d13.png)

ã“ã“ã§ `image: nginx:1.15` -> `image: nginx:1.16` ã«å¤‰æ›´ã—ã¦ã€Deployment ã‚’ apply ã—ã¦ã¿ã¾ã™ã€‚

```
$ kubectl apply -f nginx-deployment.yaml
deployment.apps/nginx-deployment configured
```

ä»¥é™ã€`kubectl get pod` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ç¶šã‘ã‚‹ã¨ Kubernetes ãŒãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã„ã‚‹æ§˜å­ã‚’ä¼ºã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```
$ kubectl get pod -o 'custom-columns=NAME:.metadata.name,IMAGE:.spec.containers[*].image,PHASE:.status.phase'
NAME                                IMAGE            PHASE
bastion                             debian:stretch   Running
nginx-deployment-5b4c7f657-pnwkr    nginx:1.16       Pending
nginx-deployment-77bc96745b-9tdr2   nginx:1.15       Running
nginx-deployment-77bc96745b-kg96q   nginx:1.15       Running
nginx-deployment-77bc96745b-xn4v6   nginx:1.15       Running

$ kubectl get pod -o 'custom-columns=NAME:.metadata.name,IMAGE:.spec.containers[*].image,PHASE:.status.phase'
NAME                                IMAGE            PHASE
bastion                             debian:stretch   Running
nginx-deployment-5b4c7f657-dcqwd    nginx:1.16       Running
nginx-deployment-5b4c7f657-pnwkr    nginx:1.16       Running
nginx-deployment-5b4c7f657-t9ddv    nginx:1.16       Running
nginx-deployment-77bc96745b-9tdr2   nginx:1.15       Running
nginx-deployment-77bc96745b-kg96q   nginx:1.15       Running
nginx-deployment-77bc96745b-xn4v6   nginx:1.15       Running
SuguruTakahashiMBP sugurutakahashi ~/git/k8s-sample $

$ kubectl get pod -o 'custom-columns=NAME:.metadata.name,IMAGE:.spec.containers[*].image,PHASE:.status.phase'
NAME                               IMAGE            PHASE
bastion                            debian:stretch   Running
nginx-deployment-5b4c7f657-dcqwd   nginx:1.16       Running
nginx-deployment-5b4c7f657-pnwkr   nginx:1.16       Running
nginx-deployment-5b4c7f657-t9ddv   nginx:1.16       Running
```

ã“ã®ã‚ˆã†ã«ã™ã¹ã¦ã® Pod ãŒ `image: nginx:1.15` -> `image: nginx:1.16` ã¨ãªã‚Šã¾ã—ãŸã­ã€‚

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã‚‚ç¢ºèªã§ãã¾ã™ã€‚
![l.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/2e623fca-777c-3f93-25ad-5e40dc8f7e34.png)

Kubernetes ã‚’å®Ÿéš›ã«åˆ©ç”¨ã™ã‚‹å ´åˆã€Pod ã‚„ ReplicaSet ã‚’ç›´æ¥ä½œæˆã™ã‚‹ã“ã¨ã¯ã»ã¨ã‚“ã©ãªã„ãã†ã§ã™ã€‚

**Pod ã‚’ä½œæˆã™ã‚‹ã¨ãã¯ Deployment ã‚’ä½¿ã£ã¦ä½œæˆã™ã‚‹ã“ã¨ãŒå¤§æŠµã®ã‚±ãƒ¼ã‚¹ã§ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã®ã“ã¨ã§ã™ã€‚**

ãã‚ŒãŒä¾‹ãˆ replica æ•°ãŒï¼‘ã®å ´åˆã§ã‚‚ Pod ã‚’ä½œæˆã™ã‚‹å ´åˆã¯ Deployment ã‚’ä½¿ã£ã¦ä½œã‚‹ã¹ãã§ã‚ã‚Šã€ç†ç”±ã¯å˜ã« Pod ã‚’ã²ã¨ã¤ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå ´åˆã€Pod ãŒç«‹ã£ã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ãŒæ­»ã¬ã¨ Pod ã‚‚é“é€£ã‚Œã«ãªã£ã¦ã—ã¾ã†ã‹ã‚‰ã§ã™ã€‚


## ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ã®å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹

Kubernetes ä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’ Kubernetes ã‚¯ãƒ©ã‚¹ã‚¿ã®å¤–å´ã«å…¬é–‹ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚ ã‚¯ãƒ©ã‚¹ã‚¿å¤–ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’å…¬é–‹ã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯æœ€ã‚‚ç°¡å˜ãª NodePort ã‚’ä½¿ã†æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

Service ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```yaml:nginx-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-first-service
spec:
  selector:
    component: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 30000
  type: NodePort
```

`nodePort: 30000` ã¨ `type: NodePort` ã®è¡ŒãŒè¿½åŠ ã•ã‚ŒãŸè¡Œã§ã™ã€‚

apply ã—ã¾ã™ã€‚

```
$ kubectl get service my-first-service
NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
my-first-service   ClusterIP   10.101.46.86   <none>        80/TCP    3m7s

$ kubectl apply -f nginx-service.yaml
service/my-first-service configured

# TYPE ãŒå¤‰ã‚ã£ã¦ã„ã¾ã™ã­
$ kubectl get service my-first-service
NAME               TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
my-first-service   NodePort   10.101.46.86   <none>        80:30000/TCP   124m
```
ã“ã®ä½œæ¥­ã«ã‚ˆã£ã¦ã€my-first-service ã® type ãŒ ClusterIP (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) ã‹ã‚‰ NodePort ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã‚‚ãƒãƒ¼ãƒˆç•ªå· 30000 ã§ç©ºã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
![m.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/bda2a16b-2b42-adb3-fa44-cd2cab75c5d5.png)


ã“ã“ã‹ã‚‰ãŒç ”ä¿®è³‡æ–™ã¨ç•°ãªã‚‹ã®ã§ã™ãŒã€<`minikube ip` ã§è¿”å´ã•ã‚ŒãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ : 30000> ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ã†ã¾ãã„ã‹ãªã‹ã£ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‹ãƒãƒ¼ãƒˆç•ªå·ãŒå…¬é–‹ã•ã‚Œã‚‹ã¿ãŸã„ãªã®ã§ãã¡ã‚‰ã§å®Ÿè¡Œã—ã¦ã¿ã¾ã—ãŸã€‚

```
$ minikube service my-first-service --url
ğŸƒ  Starting tunnel for service my-first-service.
|-----------|------------------|-------------|------------------------|
| NAMESPACE |       NAME       | TARGET PORT |          URL           |
|-----------|------------------|-------------|------------------------|
| default   | my-first-service |             | http://127.0.0.1:53157 |
|-----------|------------------|-------------|------------------------|
http://127.0.0.1:53157
```

`http://127.0.0.1:53157` ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã« nginx ã«æ¥ç¶šã§ãã¾ã—ãŸã€‚

![n.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/bfac425e-5512-a27a-c6c4-a88870dc1885.png)


## Pod ã‚’ãƒ‡ãƒãƒƒã‚°ã™ã‚‹

å¤šãã®å ´åˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸ Pod ã‚’ãƒ‡ãƒãƒƒã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
`kubectl exec` ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚„ `kubectl describe` ã¯ Pod ã®ãƒ‡ãƒãƒƒã‚°ã«å½¹ç«‹ã¡ã¾ã™ã€‚

ã“ã®ç¯€ã§ã¯ã€ã“ã®ï¼’ã¤ã«åŠ ãˆã¦ãƒ‡ãƒãƒƒã‚°ã§ä¾¿åˆ©ãªï¼’ã¤ã®ã‚³ãƒãƒ³ãƒ‰ `kubectl logs` ã¨ `kubectl port-forward` ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

### ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¦‹ã‚‹

`kubectl logs` ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ã‚°ãŒç¢ºèªã§ãã¾ã™ã€‚

```
# ç¾åœ¨ã® Pod ä¸€è¦§
$ kubectl get pod
NAME                               READY   STATUS    RESTARTS   AGE
nginx-deployment-5b4c7f657-cbd8r   1/1     Running   0          103m
nginx-deployment-5b4c7f657-fvd88   1/1     Running   0          103m
nginx-deployment-5b4c7f657-lqqkm   1/1     Running   0          103m

# ç‰¹å®šã® Pod ã«å¯¾ã—ã¦ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹
$ kubectl logs nginx-deployment-5b4c7f657-cbd8r
172.17.0.3 - - [15/Aug/2020:10:32:24 +0000] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36" "-"
172.17.0.3 - - [15/Aug/2020:10:32:24 +0000] "GET /favicon.ico HTTP/1.1" 404 555 "http://127.0.0.1:52378/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36" "-"
2020/08/15 10:32:24 [error] 6#6: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.17.0.3, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "127.0.0.1:52378", referrer: "http://127.0.0.1:52378/"

# ãƒ©ãƒ™ãƒ«ã«è©²å½“ã™ã‚‹ Pod ã«å¯¾ã—ã¦ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹
$ kubectl logs -l component=nginx
172.17.0.3 - - [15/Aug/2020:10:32:24 +0000] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36" "-"
172.17.0.3 - - [15/Aug/2020:10:32:24 +0000] "GET /favicon.ico HTTP/1.1" 404 555 "http://127.0.0.1:52378/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36" "-"
2020/08/15 10:32:24 [error] 6#6: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.17.0.3, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "127.0.0.1:52378", referrer: "http://127.0.0.1:52378/"
172.17.0.3 - - [15/Aug/2020:10:45:24 +0000] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36" "-"
2020/08/15 10:45:25 [error] 6#6: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.17.0.3, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "127.0.0.1:52724", referrer: "http://127.0.0.1:52724/"
172.17.0.3 - - [15/Aug/2020:10:45:25 +0000] "GET /favicon.ico HTTP/1.1" 404 555 "http://127.0.0.1:52724/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36" "-"
172.17.0.3 - - [15/Aug/2020:12:01:44 +0000] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36" "-"
2020/08/15 12:01:44 [error] 6#6: *3 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 172.17.0.3, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "127.0.0.1:53157", referrer: "http://127.0.0.1:53157/"
172.17.0.3 - - [15/Aug/2020:12:01:44 +0000] "GET /favicon.ico HTTP/1.1" 404 555 "http://127.0.0.1:53157/" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36" "-"
```

### ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã™ã‚‹

`kubectl port-forward` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã¨ã€Pod ã®ç‰¹å®šã®ãƒãƒ¼ãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã‚Œã‚’ä½¿ãˆã°ãƒ­ãƒ¼ã‚«ãƒ«ã® curl ã‚³ãƒãƒ³ãƒ‰ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥ Pod ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã® 8080 ã‚’ã‚¯ãƒ©ã‚¹ã‚¿å†…ã® nginx ã® 80 ã«ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã—ã¦ãã‚Œã¾ã™ã€‚

```
$ kubectl port-forward deployment/nginx-deployment 8080:80

```

`localhost:8080` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ "Welcome to nginx!" ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![o.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/007a8461-14f4-afab-57fc-b74f56fb48ea.png)

# More Introduction to Kubernetes

ã•ã‚‰ã«æœ¬ç•ªç’°å¢ƒã§ã®é‹ç”¨ã‚’æƒ³å®šã—ã¦é‡è¦ãªæ©Ÿèƒ½ã‚’èª¬æ˜ã—ã¾ã™ã€‚

ã“ã“ã§ã¯ã•ã‚‰ã£ã¨è§¦ã‚Œã‚‹ç¨‹åº¦ã§ã®ç´¹ä»‹ã«ãªã‚Šã¾ã™ã€‚

## ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

Kubernetes ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¯ä»¥ä¸‹ã®ï¼’ã¤ãŒã‚ã‚Šã€ç”¨é€”ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- Liveness probe â€• Pod ãŒç”Ÿãã¦ã„ã‚‹ã‹æ­»ã‚“ã§ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ä¸€å®šå›æ•° Liveness probe ãŒå¤±æ•—ã—ãŸå ´åˆã€Pod ã¯å†èµ·å‹•ã•ã‚Œã¾ã™ã€‚
- Readiness probe â€• Pod ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œç­”ã§ãã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚Readiness probe ãŒæˆåŠŸã™ã‚‹ã¾ã§ã®é–“ã€ãã® Pod ã¯èµ·å‹•ãŒå®Œäº†ã—ã¦ã„ãªã„ã¨ã¿ãªã•ã‚Œã€Service ã®ãƒªãƒãƒ—ãƒ­å…ˆã«è¿½åŠ ã•ã‚Œã¾ã›ã‚“ã€‚Readiness probe ã‚’ä½¿ã†ã“ã¨ã§ Pod ãŒèµ·å‹•ãŒå®Œäº†ã™ã‚‹å‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ãã‚‹ç¾è±¡ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

ç ”ä¿®è³‡æ–™ã®ã‚µãƒ³ãƒ—ãƒ«ã¯å‹•ã‹ã™ã“ã¨ãŒã§ããªã‹ã£ãŸã®ã§ã€[ã“ã¡ã‚‰](https://qiita.com/yuta_vamdemic/items/1438455946b7533b921f)ã®è¨˜äº‹ã‚’å‚è€ƒã« YAML ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®šç¾©ã—ã¾ã—ãŸã€‚

```yaml:sample-healthcheck.yaml
apiVersion: v1
kind: Pod
metadata:
  name: sample-healthcheck
  labels:
    app: sample-app
spec:
  containers:
    - name: nginx-container
      image: nginx:1.12
      ports:
        - containerPort: 80
      livenessProbe:
        httpGet:
          path: /index.html
          port: 80
          scheme: HTTP
        timeoutSeconds: 1
        successThreshold: 1
        failureThreshold: 2
        initialDelaySeconds: 5
        periodSeconds: 3
      readinessProbe:
        exec:
          command: ["ls", "/usr/share/nginx/html/50x.html"]
        timeoutSeconds: 1
        successThreshold: 2
        failureThreshold: 1
        initialDelaySeconds: 5
        periodSeconds: 3
```

apply ã—ã¦ã¿ã¾ã™ã€‚

```
$ kubectl apply -f sample-healthcheck.yaml
pod/sample-healthcheck created

$ kubectl get pod
NAME                 READY   STATUS    RESTARTS   AGE
sample-healthcheck   1/1     Running   0          17s

# describe ã§ Liveness ã®è¨­å®šã‚’ç¢ºèª
$ kubectl describe pod sample-healthcheck | grep "Liveness"
    Liveness:       http-get http://:80/index.html delay=5s timeout=1s period=3s #success=1 #failure=2

# describe ã§ Readiness ã®è¨­å®šã‚’ç¢ºèª
$ kubectl describe pod sample-healthcheck | grep "Readiness"
    Readiness:      exec [ls /usr/share/nginx/html/50x.html] delay=5s timeout=1s period=3s #success=2 #failure=1
```

å®Ÿéš›ã«ã‚ã–ã¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒç™ºå‹•ã™ã‚‹ã‚ˆã†ã«å®Ÿé¨“ã—ã¾ã™ã€‚

```
# å…ˆã«åˆ¥ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ Pod ã®çŠ¶æ…‹ã‚’ç›£è¦–
$ kubectl get pods sample-healthcheck --watch

# DocumentRoot ã® index.html ã®å‰Šé™¤ï¼ˆLiveness ã§ã®ç›£è¦–å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ï¼‰
$ kubectl exec -it sample-healthcheck rm /usr/share/nginx/html/index.html

# Pod ãŒå†èµ·å‹•ã™ã‚‹ï¼ˆå†èµ·å‹•å¾Œã¯ index.html ãŒä½œæˆã•ã‚Œã‚‹ãŸã‚å†èµ·å‹•ã¯ç¹°ã‚Šè¿”ã•ãªã„ï¼‰
$ kubectl get pods sample-healthcheck --watch
NAME                 READY   STATUS    RESTARTS   AGE
sample-healthcheck   0/1     Running   2          9m12s
sample-healthcheck   1/1     Running   2          9m20s
```

Liveness probe, Readiness probe ã¯é‹ç”¨ä¸Šéå¸¸ã«é‡è¦ãªãŸã‚ã€å¸¸é§ã™ã‚‹ Pod ã«ã¯å¿…ãšä¸¡æ–¹è¨­å®šã—ã¦ãŠãã¨ã‚ˆã„ã¨ã®ã“ã¨ã§ã™ã€‚

## Resource Requests/Limits

Pod ã«å¯¾ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚ã‚‰ã‹ã˜ã‚è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

è¨­å®šã¯2ç¨®é¡ã‚ã‚Šã¾ã™ã€‚

- Resource Requests
ã‚³ãƒ³ãƒ†ãƒŠãŒè¦æ±‚ã™ã‚‹ãƒ¡ãƒ¢ãƒªã‚„CPUã®é‡ã‚’å®£è¨€ã™ã‚‹æ©Ÿèƒ½ã§ã€Kubernetes ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã¯ Resource Requests ã®å€¤ã‚’è¦‹ã¦ Pod ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒãƒ¼ãƒ‰ã‚’æ±ºã‚ã¾ã™ã€‚
- Resource Limits
ãã®ã‚³ãƒ³ãƒ†ãƒŠãŒå®Ÿéš›ã«ä½¿ç”¨ã§ãã‚‹ãƒ¡ãƒ¢ãƒªã‚„CPUã®é‡ã®ä¸Šé™ã‚’è¨­å®šã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚ ã‚³ãƒ³ãƒ†ãƒŠãŒä½¿ç”¨ã™ã‚‹ãƒ¡ãƒ¢ãƒªãŒè¨­å®šã•ã‚ŒãŸä¸Šé™ã‚’è¶…ãˆãŸå ´åˆã€ãã®ã‚³ãƒ³ãƒ†ãƒŠã¯ kill ã•ã‚Œã¾ã™ã€‚ ã¾ãŸ CPU ä½¿ç”¨é‡ãŒä¸Šé™ã«é”ã—ãŸå ´åˆã€ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã¯ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚

YMML ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹ã§ã™ã€‚

```yaml:sample-resource.yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    component: nginx
spec:
  containers:
    - name: nginx
      image: nginx:1.16
      resources:
        requests:
          memory: "128Mi"
          cpu: "250m"
        limits:
          memory: "128Mi"
          cpu: "500m"
```

apply ã—ã¦è¨­å®šã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl apply -f sample-resource.yaml

$ kubectl describe pod nginx
ï¼ˆçœç•¥ï¼‰
    Limits:
      cpu:     500m
      memory:  128Mi
    Requests:
      cpu:        250m
      memory:     128Mi
ï¼ˆçœç•¥ï¼‰
```

## Volume

Pod ã«è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚‹ã¨ãã€ãã‚Œã‚‰ã®é–“ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…±æœ‰ã—ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ä¾‹ãˆã°ã€APã‚µãƒ¼ãƒãƒ¼ãŒå‡ºåŠ›ã™ã‚‹ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ã‚°è»¢é€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§è»¢é€ã™ã‚‹ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

ã¡ãªã¿ã«ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ fluentd ã‚’åˆ©ç”¨ã—ã¾ã™ãŒã€OSS ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚°åé›†ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã¯ã‹ãªã‚Šæœ‰åãªã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

```yaml:sample-volume.yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    component: nginx
spec:
  containers:
    - name: nginx
      image: nginx:1.16
      volumeMounts:
        - name: nginx-log
          mountPath: /var/log/nginx

    - name: fluentd
      image: fluent/fluentd:v1.11
      volumeMounts:
        - name: nginx-log
          mountPath: /var/log/nginx
          readOnly: true

  volumes:
    - name: nginx-log
      emptyDir: {}
```

applyã—ã¦ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl apply -f sample-volume.yaml
Pod/nginx created

$ kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
nginx   2/2     Running   0          2m5s

$ kubectl describe pod nginx
ï¼ˆçœç•¥ï¼‰
Containers:
  nginx:
    Container ID:   docker://3ebb817cf4ee20439c722bbeba711943bb5f05a2d75b420d308faaf1edbd0af2
    Image:          nginx:1.16
    Image ID:       docker-pullable://nginx@sha256:d20aa6d1cae56fd17cd458f4807e0de462caf2336f0b70b5eeb69fcaaf30dd9c
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Sat, 15 Aug 2020 22:26:10 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/log/nginx from nginx-log (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-q8zvm (ro)
  fluentd:
    Container ID:   docker://f001646ac161052c67e6aba83ec999b97cb55650c4db095c310e60af75a871cc
    Image:          fluent/fluentd:v1.11
    Image ID:       docker-pullable://fluent/fluentd@sha256:617fa61a8a811fd49b730c27835983ecb2a8150584138ec825649ff8352a6d44
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Sat, 15 Aug 2020 22:28:13 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/log/nginx from nginx-log (ro)
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-q8zvm (ro)
ï¼ˆçœç•¥ï¼‰
```

æ¦‚å¿µçš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå›³ã«ãªã‚Šã¾ã™ã€‚

![p.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/89f529c8-66b6-8891-e9f2-18f3b37ed810.png)


## Anti Affinity

Deployment ã‚’ä½¿ã£ã¦åŒã˜ Pod ã‚’ï¼’ã¤ä½œã£ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚ ä½•ã‚‚æŒ‡å®šã—ã¦ã„ãªã„ã¨ãã®ï¼’ã¤ã® Pod ãŒåŒã˜ãƒãƒ¼ãƒ‰ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ ã“ã®ã‚ˆã†ãªå ´åˆã€ãã®ãƒãƒ¼ãƒ‰ãŒéšœå®³ã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãªã©ã§æ­»äº¡ã™ã‚‹ã¨ï¼’ã¤ã® Pod ãŒåŒæ™‚ã«æ¶ˆå¤±ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

Affinity ã®æ©Ÿèƒ½ã‚’ä½¿ãˆã° Pod ãŒç•°ãªã‚‹ãƒãƒ¼ãƒ‰ã«é…ç½®ã•ã‚Œã‚‹ã‚ˆã†ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã«è¦æ±‚ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ Kubernetes ã® Affinity ã¯éå¸¸ã«æŸ”è»Ÿã§æ§˜ã€…ãªã“ã¨ãŒã§ãã¾ã™ãŒã€ã“ã“ã§ã¯ä¸Šã§æŒ™ã’ãŸãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«çµã£ã¦èª¬æ˜ã—ã¾ã™ã€‚

```yaml:sample-affinity.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    component: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      component: nginx
  template:
    metadata:
      labels:
        component: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.16
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: component
                    operator: In
                    values:
                      - "nginx"
              topologyKey: "kubernetes.io/hostname"

```

å®šç¾©ã§ã¯ `replicas: 2` ã¨ 2 ã¤ã® Pod ãŒç«‹ã¤ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ãã“ã« `affinity:` ã‹ã‚‰ã®è¨˜è¿°ã§ Kubernetes ãŒã“ã® Pod ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãã« `component: nginx` ã¨ã„ã†ãƒ©ãƒ™ãƒ«ã‚’æŒã¤ Pod ãŒã„ãªã„ãƒãƒ¼ãƒ‰ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒãƒ¼ãƒ‰ãŒä¸€å°æ­»äº¡ã—ãŸã¨ã—ã¦ã‚‚ nginx ã® Pod ãŒã²ã¨ã¤ä»¥ä¸Šç”Ÿãæ®‹ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚

Minikube ã®ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ãƒ‰ç’°å¢ƒã§ applyã—ã¦ã¿ã¾ã™ã€‚

```
$ kubectl apply -f sample-affinity.yaml
deployment.apps/nginx-deployment created

$ kubectl get pod
NAME                               READY   STATUS    RESTARTS   AGE
nginx-deployment-6b7b554df-9p4b9   0/1     Pending   0          71s
nginx-deployment-6b7b554df-xf5bp   1/1     Running   0          71s
```

ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ãƒ‰ã®ãŸã‚ã€1 ã¤ Pod ãŒç«‹ã¤ã¨ã€ã‚‚ã† 1 ã¤ã® Pod ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œãšã« Pending ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«æ¡ä»¶ã‚’æº€ãŸã™ãƒãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„ã¨ãã¯ã€Pod ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œãšã€æ¡ä»¶ã‚’æº€ãŸã™ãƒãƒ¼ãƒ‰ãŒå‡ºç¾ã™ã‚‹ã¾ã§ Pending çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

é•·æ™‚é–“ Pending ã«ãªã£ã¦ã„ã‚‹ Pod ãŒå­˜åœ¨ã—ãªã„ã‹ã©ã†ã‹ã¯ç›£è¦–é …ç›®ã«å«ã‚ã¦ãŠãã¨ã‚ˆã„ã¨ã®ã“ã¨ã§ã™ã€‚

## Pod Disruption Budget

ãƒãƒ¼ãƒ‰ã®å†èµ·å‹•ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ ä¾‹ãˆã° Linux ã‚«ãƒ¼ãƒãƒ«ã«è„†å¼±æ€§ãŒç™ºè¦‹ã•ã‚ŒãŸå ´åˆãªã©ã§ã™ã€‚

Pod ã‚’è¤‡æ•°ç«‹ã¦ã¦å†—é•·åŒ–ã—ã¦ãŠã‘ã°ã€å˜ä¸€ã®ãƒãƒ¼ãƒ‰ã®ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã«ã¯è€ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã—ã‹ã—ã€ãƒãƒ¼ãƒ‰ã‚’æ¬¡ã€…ã¨å†èµ·å‹•ã—ã¦ã„ãçŠ¶æ³ã§ã¯å•é¡ŒãŒèµ·ã“ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ä¸‹ã®å›³ã®ã‚ˆã†ã«ï¼“å°ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰ãªã‚‹ã‚¯ãƒ©ã‚¹ã‚¿ã®ä¸Šã«ï¼’ã¤ã® Pod ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã¤ã„ã¦è€ƒãˆã¾ã™ã€‚
ã“ã®2ã¤ã® Pod ã¯ Deployment ã«ã‚ˆã‚Šãƒ¬ãƒ—ãƒªã‚«æ•°ãŒï¼’ã«ãªã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®ã‚¯ãƒ©ã‚¹ã‚¿ã«å¯¾ã—ã¦ã€ãƒãƒ¼ãƒ‰ã‚’ï¼‘å°ãšã¤ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒªãƒ–ãƒ¼ãƒˆã—ã¦ã„ãã¾ã™ã€‚

![ll.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/b86013b4-6878-bfe1-9a09-5ebcbb9ab4ff.png)

ï¼‘å°ç›®ã®ãƒãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã™ã‚‹éç¨‹ã§ã€ãã®ä¸Šã§èµ°ã£ã¦ã„ãŸ Pod ãŒ Evict ã•ã‚Œã¾ã™ã€‚ Pod ã®æ•°ãŒæ¸›ã£ãŸã“ã¨ã‚’æ¤œçŸ¥ã—ãŸ Deployment ãŒç›´ã¡ã«æ–°ã—ã„ Pod ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ ã—ã‹ã—ã€ã“ã® Pod ã®èµ·å‹•ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã€starting ã®çŠ¶æ…‹ã§æ­¢ã¾ã£ã¦ã„ã¾ã™ã€‚ ã“ã®çŠ¶æ³ã§ node 2 ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã™ã‚‹ã¨ã€available ãª Pod ãŒå­˜åœ¨ã—ãªããªã‚Šã€ã‚µãƒ¼ãƒ“ã‚¹ãŒåœæ­¢ã—ã¾ã™ã€‚

ã“ã‚Œã‚’é˜²ãã«ã¯ Pod Disruption Budget ã«ã‚ˆã£ã¦ã‚µãƒ¼ãƒ“ã‚¹ã®ç¨¼åƒã«å¿…è¦ãª Pod ã®æ•°ã®æœ€å°å€¤ã‚’æŒ‡å®šã—ã¾ã—ã‚‡ã†ã€‚

PDB ã‚’æŒ‡å®šã™ã‚‹ã¨ã€Kubernetes ã®ãƒ„ãƒ¼ãƒ«ãŒãƒãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã™ã‚‹å‰ã«ã“ã®åˆ¶ç´„ãŒæº€ãŸã•ã‚Œã‚‹ã‚ˆã†ã«é©åˆ‡ã«å¾…ã£ã¦ãã‚Œã¾ã™ã€‚

```yaml:frontend-pdb.yaml
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  name: nginx-pdb
spec:
  minAvailable: 1
  selector:
    matchLabels:
      component: nginx
```

apply ã—ã¦ç¢ºèªã—ã¾ã™ã€‚

```
$ kubectl apply -f frontend-pdb.yaml
poddisruptionbudget.policy/nginx-pdb created

$ kubectl get poddisruptionbudget
NAME        MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
nginx-pdb   1               N/A               0                     66s
```

å½“ç„¶ã§ã™ãŒã€PDB ã®åˆ¶ç´„ãŒå®ˆã‚‰ã‚Œã‚‹ã®ã¯ã‚¯ãƒ©ã‚¹ã‚¿ç®¡ç†è€…ãŒæ„å›³ã—ã¦ãƒãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã™ã‚‹å ´åˆã ã‘ã§ã™ã€‚ éšœå®³ã§ãƒãƒ¼ãƒ‰ãŒæ­»ã¬å ´åˆã«ã¯ PDB ã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚ ã¾ãŸã€Deployment ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã‚‚ PDB ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚

Pod ãŒ available ã‹ã©ã†ã‹ã®åˆ¤å®šã¯ Readiness probe ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œã¾ã™ã€‚PDB ã‚’æ­£ã—ãæ©Ÿèƒ½ã•ã›ã‚‹ãŸã‚ã«ã¯ã€Pod ã«é©åˆ‡ãª Readiness probe ã‚’è¨­å®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# Exercise

ç ”ä¿®è³‡æ–™ã«ã‚ã‚‹ Exercise ã¯ã‚„ã£ã¦ã„ã¾ã›ã‚“ã€‚

ã”ã‚ã‚“ãªã•ã„ã€‚ã€‚ã€‚

ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚
