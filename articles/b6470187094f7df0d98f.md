---
title: "[Swift] ã€Combineå…¥é–€ã€‘AnyPublisher ã® Output ã‚’ Never ã«ã—ãŸå ´åˆã®æŒ™å‹•"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift","Combine"]
published: true
---
# ã¯ã˜ã‚ã«

Combine ã§å‡¦ç†ã‚’é€£çµã™ã‚‹ã¨ãã«ã€`AnyPublisher` ã® `Output` ã«ç©ºã® `Void` ã‚’è¿”ã—ã¦ã€ä½•ã‚‚è¿”ã‚Šå€¤ãŒãªã„ã“ã¨ã‚’æš—ã«ç¤ºã—ã¦ã„ãŸã®ã§ã™ãŒã€ãã‚Œã‚ˆã‚Šã¯ `.ignoreOutput()` ã—ã¦ `Output` ã‚’ `Never` ã«ã—ãŸã»ã†ãŒæ„å›³ãŒä¼ã‚ã‚‹ã®ã§ã¯ï¼Ÿ ã¨æ€ã„ã€ãã‚Œã§å®Ÿè£…ã—ãŸã¨ã“ã‚æ€ã£ãŸã‚ˆã†ã«å‹•ã‹ãªã‹ã£ãŸãŸã‚ã€æŒ™å‹•ã‚’æ•´ç†ã—ã¾ã—ãŸã€‚


ç’°å¢ƒï¼šXcode 12.5.1

# çµè«–

å…ˆã«çµè«–ã‹ã‚‰è¿°ã¹ã¾ã™ã€‚

- `AnyPublisher` ã® `Output` ãŒ `Never` ã«ãªã£ãŸæ®µéšã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯æµã‚Œãªããªã‚‹
- ä½•ã‚‚è¿”ã‚Šå€¤ãŒãªã„å ´åˆã® `AnyPublisher` ã® `Output` ã¯ `Void` ã‚’è¿”ã—ã¦ã€`Never` ã«ã—ãŸã„ç®‡æ‰€ã§ `.ignoreOutput()` ã¨ã¤ã‘ã¦ `Never` ã«ã—ã¦ã‚ã’ã‚‹ã®ãŒè‰¯ã•ãã†

# å®Ÿé¨“ãã®1

`CurrentValueSubject<Int, Never>` ã® `number` ãŒ 0 ã‹è² ã®å€¤ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã„ã†é©å½“ãªå‡¦ç†ã‚’ä¾‹ã«ã—ã¦å®Ÿé¨“ã—ã¾ã™ã€‚

```swift
import Combine
import Foundation

enum TestError: Error {
    case zeroError
    case minusError
}

var cancellables: Set<AnyCancellable> = []
let number = CurrentValueSubject<Int, Never>(0)

func start() {
       number
        .dropFirst()
        .setFailureType(to: TestError.self)
        .flatMap { _ -> AnyPublisher<Never, TestError> in
            print("checkZero")
            return checkZero()
        }
        .flatMap { _ -> AnyPublisher<Never, TestError> in
            print("checkMinus") // ä¸Šã®flatMapã®æ®µéšã§Neverã«ãªã‚‹ã®ã§ã“ã“ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯æµã‚Œã¦ã“ãªã„
            return checkMinus()
        }
        .sink { completion in
            switch completion {
            case .finished:
                print("finished")
            case let .failure(error):
                print("error: \(error)")
            }
            print("completion.")
        } receiveValue: { hoge in
            print("receiveValue: \(hoge)")
        }
        .store(in: &cancellables)
}

func checkZero() -> AnyPublisher<Never, TestError> {
    Future<Void, TestError> { promise in
        let numberValue = number.value
        print("now: \(numberValue)")
        guard number.value != 0 else {
            promise(.failure(TestError.zeroError))
            return
        }
        promise(.success(()))
    }
    .ignoreOutput()
    .eraseToAnyPublisher()
}

func checkMinus() -> AnyPublisher<Never, TestError> {
    Future<Void, TestError> { promise in
        let numberValue = number.value
        print("now: \(numberValue)")
        guard numberValue > 0 else {
            promise(.failure(TestError.minusError))
            return
        }
        promise(.success(()))
    }
    .ignoreOutput()
    .eraseToAnyPublisher()
}

start()

number.value = 1
number.value = -1 // æœ¬å½“ã¯ã“ã“ã§minusErrorã«ãªã£ã¦ã»ã—ã„ãŒcheckMinusã«åˆ°é”ã—ãªã„
number.value = 0

// å‡ºåŠ›
// checkZero
// now: 1
// checkZero
// now: -1
// checkZero
// now: 0
// error: zeroError
// completion.
```

ã“ã®ã‚ˆã†ã« `checkMinus()`ã¾ã§å‡¦ç†ãŒåˆ°é”ã—ã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
ã¤ã¾ã‚Šã€å‰æ®µã® ` checkZero()` ã§æ­¢ã¾ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

- ãƒã‚¤ãƒ³ãƒˆ
    - `AnyPublisher` è¿”ã™é–¢æ•°å´ã§ `Never` ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã‚‹
    - `AnyPublisher` ã® `Output` ãŒ `Never` ã«ãªã£ãŸæ®µéšã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯æµã‚Œãªããªã‚‹ï¼ˆæœ¬å½“ã¯æµã‚Œã¦ã»ã—ã„ï¼‰
        - â†’ é€”ä¸­ã® `flatMap` ã§ `Never` ã«ã™ã‚‹ã¨ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯ãã“ã§æ­¢ã¾ã‚‹

# å®Ÿé¨“ãã®2

```swift
import Combine
import Foundation

enum TestError: Error {
    case zeroError
    case minusError
}

var cancellables: Set<AnyCancellable> = []
let number = CurrentValueSubject<Int, Never>(0)

func start() {
       number
        .dropFirst()
        .setFailureType(to: TestError.self)
        .flatMap { _ -> AnyPublisher<Void, TestError> in
            print("checkZero")
            return checkZero()
        }
        .flatMap { _ -> AnyPublisher<Never, TestError> in // æœ€å¾Œã®flatMapã§Neverã«ã™ã‚‹
            print("checkMinus")
            return checkMinus() // AnyPublisher<Void, TestError>
                .ignoreOutput() // Void ã‚’ Never ã«å¤‰æ›
                .eraseToAnyPublisher() // å‹åˆã‚ã›
        }
        .sink { completion in
            switch completion {
            case .finished:
                print("finished")
            case let .failure(error):
                print("error: \(error)")
            }
            print("completion.")
        } receiveValue: { hoge in
            print("receiveValue: \(hoge)")
        }
        .store(in: &cancellables)
}

func checkZero() -> AnyPublisher<Void, TestError> { // Voidã«å¤‰æ›´
    Future<Void, TestError> { promise in
        let numberValue = number.value
        print("now: \(numberValue)")
        guard number.value != 0 else {
            promise(.failure(TestError.zeroError))
            return
        }
        promise(.success(()))
    }
//    .ignoreOutput()
    .eraseToAnyPublisher()
}

func checkMinus() -> AnyPublisher<Void, TestError> { // Voidã«å¤‰æ›´
    Future<Void, TestError> { promise in
        let numberValue = number.value
        print("now: \(numberValue)")
        guard numberValue > 0 else {
            promise(.failure(TestError.minusError))
            return
        }
        promise(.success(()))
    }
//    .ignoreOutput()
    .eraseToAnyPublisher()
}

start()

number.value = 1
number.value = -1
number.value = 0

// å‡ºåŠ›
// checkZero
// now: 1
// checkMinus
// now: 1
// checkZero
// now: -1
// checkMinus
// now: -1
// error: minusError
// completion.
// checkZero
// now: 0
```

ä»Šå›ã¯ `checkZero()` ã® `flatMap` ã§ã¯ã€`Never` ã¨ã—ã¦ã„ãªã„ãŸã‚ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒæµã‚Œã¦ã€`checkMinus()` ã¾ã§å‡¦ç†ãŒæµã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã¾ãŸã€æœ€å¾Œã® `AnyPublisher` è¿”ã™é–¢æ•°å´ã§ `Never` ã§ã‚ã‚Œã°ã€`sink()` ã® `receiveValue` ã¾ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒãªãŒã‚Œã¦ã„ãªã„ã“ã¨ã‚‚ã‚ã‹ã‚Šã¾ã™ï¼ˆã‚‚ã—ãªãŒã‚Œã¦ã„ã‚Œã°ã€`"receiveValue: \(hoge)"` ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã¯ãšï¼‰ã€‚

ã“ã‚Œã¯ã€ `Never` ã«ãªã£ãŸæ®µéšã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯æµã‚Œãªããªã‚‹è¨¼æ‹ ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚

- ãƒã‚¤ãƒ³ãƒˆ
    - `AnyPublisher` è¿”ã™é–¢æ•°å´ã§ `Never` ã¨ã¯ã›ãšã«ã€`flatMap` ã®ä¸­ã§å¿…è¦ã«å¿œã˜ã¦ã€ `Never` ã«å¤‰æ›ã™ã‚‹
    - ã“ã‚Œãªã‚‰ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ å´ã§ã‚³ãƒ³ãƒˆãƒ¼ãƒ«ãŒå¯èƒ½ã«ãªã‚‹
      - â†’ ä½•ã‚‚è¿”ã‚Šå€¤ãŒãªã„å ´åˆã® `AnyPublisher` ã® `Output` ã¯ `Void` ã‚’è¿”ã—ã¦ã€`Never` ã«ã—ãŸã„ç®‡æ‰€ã§ `.ignoreOutput()` ã¨ã¤ã‘ã¦ã‚ã’ã‚‹ã®ãŒè‰¯ã•ãã†

# ã¾ã¨ã‚

- `AnyPublisher` ã® `Output` ãŒ `Never` ã«ãªã£ãŸæ®µéšã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯æµã‚Œãªããªã‚‹
- ä½•ã‚‚è¿”ã‚Šå€¤ãŒãªã„å ´åˆã® `AnyPublisher` ã® `Output` ã¯ `Void` ã‚’è¿”ã—ã¦ã€`Never` ã«ã—ãŸã„ç®‡æ‰€ã§ `.ignoreOutput()` ã¨ã¤ã‘ã¦ `Never` ã«ã—ã¦ã‚ã’ã‚‹ã®ãŒè‰¯ã•ãã†

ãã‚‚ãã‚‚ã€ã“ã†ã„ã†å‡¦ç†ã¯ `async/await` ã§ã‚„ã£ã¦ã‚ã’ã‚‹ã¨ã‚ˆã•ãã†ã§ã‚ã‚‹ãŒã€ iOS15 ä»¥ä¸Šå¯¾å¿œã¾ã§ã§ã‚ˆã„ã‚¢ãƒ—ãƒªé–‹ç™ºãŒã„ã¤ã«ãªã£ãŸã‚‰ã§ãã‚‹ã®ã ã‚ã†ã‹ã€ã€ã€

