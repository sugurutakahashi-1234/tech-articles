---
title: "[Swift] weak self ã—ãªã„ã¨å¼·å‚ç…§ã§è§£æ”¾ã§ããªã„ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰"
emoji: "ğŸ•Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift"]
published: true
---

# ã¯ã˜ã‚ã«

`weak self` ã—ãªã„ã“ã¨ã«ã‚ˆã£ã¦ã€å‚ç…§å…ƒãŒå¼·å‚ç…§ã®ãŸã‚ã€è§£æ”¾ã§ããªã„ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ä½œã‚‹ã®ãŒé›£ã—ã‹ã£ãŸã®ã§ã€ãƒ¡ãƒ¢ã®ä»£ã‚ã‚Šã«ã“ã“ã«æ®‹ã—ã¾ã™ã€‚

## é©å½“ãª closure ã‚’æŒã¤ struct ã‚’ç”¨æ„

```swift
struct Calculator {
    let numA: Double
    let numB: Double
    let closure: (Double, Double) -> Void
    
    init(numA: Double, numB: Double, closure: @escaping (Double, Double) -> Void) {
        self.numA = numA
        self.numB = numB
        self.closure = closure
    }
    
    func calc() {
        closure(numA, numB)
    }
}
```

## å¼·å‚ç…§ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

```swift
class SampleStrongClass {
    private let taxRate = 1.1
    let numA: Double
    let numB: Double
    
    init(numA: Double, numB: Double) {
        self.numA = numA
        self.numB = numB
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }

    // å¼·å‚ç…§ãªã‚³ãƒ¼ãƒ‰
    func getCalculator() -> Calculator {
        Calculator(numA: numA, numB: numB) { numA, numB in // â† `[weak self]` ãŒãªã„ãŸã‚å¼·å‚ç…§
            print("\((numA + numB) * (self.taxRate))")
        }
    }
}
```

## å¼±å‚ç…§ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

```swift
class SampleWeakClass {
    private let taxRate = 1.1
    let numA: Double
    let numB: Double
    
    init(numA: Double, numB: Double) {
        self.numA = numA
        self.numB = numB
    }
    
    deinit {
        print("deinit: \(type(of: self))")
    }
    
    // å¼±å‚ç…§ãªã‚³ãƒ¼ãƒ‰
    func getCalculator() -> Calculator {
        Calculator(numA: numA, numB: numB) { [weak self] numA, numB in // â† `[weak self]` ã‚’ã¤ã‘ã‚‹
            guard let self = self else {
                print("self is nil")
                return
            }
            print("\((numA + numB) * (self.taxRate))")
        }
    }
}
```

## å¼·å‚ç…§ã¨å¼±å‚ç…§ã®æ¯”è¼ƒ

### å¼·å‚ç…§ã®å ´åˆ

```swift
// åˆæœŸåŒ–
var smapleStrongClass: SampleStrongClass? = .init(numA: 3, numB: 4)
var strongClassCalculator: Calculator? = smapleStrongClass?.getCalculator()

// ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã®å®Ÿè¡Œ
strongClassCalculator?.calc() // 7.700000000000001

// å‚ç…§å…ƒã® class ã« nil ã‚’ä»£å…¥
smapleStrongClass = nil // ï¼ˆå‡ºåŠ›ãªã—ï¼‰ â† deinit ãŒèµ°ã‚‰ãªã„ = ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯

// ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã®å®Ÿè¡Œ
strongClassCalculator?.calc() // 7.700000000000001 â† è¨ˆç®—ã§ãã¦ã—ã¾ã†
```

### å¼±å‚ç…§ã®å ´åˆ

```swift
// åˆæœŸåŒ–
var smapleWeakClass: SampleWeakClass? = .init(numA: 5, numB: 6)
var weakClassCalculator: Calculator? = smapleWeakClass?.getCalculator()

// ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã®å®Ÿè¡Œ
weakClassCalculator?.calc() // 12.100000000000001

// å‚ç…§å…ƒã® class ã« nil ã‚’ä»£å…¥
smapleWeakClass = nil // deinit: SampleWeakClass â† deinit ãŒèµ°ã‚‹

// ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã®å®Ÿè¡Œ
weakClassCalculator?.calc() // self is nil â† è¨ˆç®—ã§ããªã„
```

ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚