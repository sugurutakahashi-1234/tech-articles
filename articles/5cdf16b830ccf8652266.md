---
title: "ã€AWSã€‘ã€Serverless Frameworkã€‘API ã‚­ãƒ¼ã®è¨­å®šï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åˆ¶é™ã®è¨­å®šï¼‰"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["APIGateway","ServerlessFramework","apikey"]
published: true
---
# ã‚„ã£ãŸã“ã¨

ã“ã®è¨˜äº‹ã§ã¯ Serverless Framework ã§ API ã‚­ãƒ¼ã®è¨­å®šæ–¹æ³•ã‚„ã€è¨­å®šã—ãŸå ´åˆã® API ã®æŒ™å‹•ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

çµå±€ã®ã¨ã“ã‚ serverless.yml ã§è¨˜è¿°ã™ã‚‹ãã‚Œã‚‰ã®è¨­å®šã¯ API Gateway ã® API ã‚­ãƒ¼ã®è¨­å®šã«åæ˜ ã•ã‚Œã¾ã™ã€‚

# serverless.yml

serverless.yml ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§ API ã‚­ãƒ¼ã®è¨­å®šãŒè¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šå›ã¯ serverless.yml ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸã€‚


```yaml:serverless.yml
provider:
  # ï¼ˆçœç•¥ï¼‰
  apiKeys:
    - free: # ä½¿ç”¨é‡ãƒ—ãƒ©ãƒ³
        - name: ${opt:stage, self:provider.stage}-free-key # key å
          value: a123456789012345678901234567890 # 30-128æ–‡å­—ã®è‹±æ•°å­—
    - mogemoge: # è¤‡æ•°ã®ãƒ—ãƒ©ãƒ³ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½
        - ${opt:stage, self:provider.stage}-mogemoge-key # name, value ã‚’æŒ‡å®šã—ãªã„ã¨ value ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹
  usagePlan:
    - free:
        quota:
          limit: 1000 # API ã®å‘¼ã³å‡ºã—ã‚’è¡Œãˆã‚‹æœ€å¤§å›æ•°
          offset: 2 # API ã®å‘¼ã³å‡ºã—å›æ•°ã®åˆæœŸå€¤ï¼ˆé€šå¸¸ã¯ 0 å›ã‚’æŒ‡å®šã™ã‚‹ï¼‰
          period: MONTH # DAY or WEEK or MONTH
        throttle:
          rateLimit: 2 # 1 ç§’ã‚ãŸã‚Šã«å‡¦ç†ã§ãã‚‹ API ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
          burstLimit: 3 # åŒæ™‚ã«å‡¦ç†ã§ãã‚‹æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
    - mogemoge:
        quota:
          limit: 50000
          offset: 1
          period: MONTH
        throttle:
          burstLimit: 2000
          rateLimit: 1000

# ï¼ˆçœç•¥ï¼‰

functions:
  hello:
    handler: handler.hello
    events:
      - http:
          path: hello
          method: get
          private: true # API ã‚­ãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ true ã«ã™ã‚‹
```

apiKeys, quota, throttle ã®è¨­å®šã«ã¤ã„ã¦ã‚³ãƒ¡ãƒ³ãƒˆã§æ³¨é‡ˆã‚’ã„ã‚Œã¾ã—ãŸã€‚

ã•ã‚‰ã«è©³ã—ã„ã“ã¨ã¯ä»¥ä¸‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

ã€å‚è€ƒã€‘
ãƒ»[API Gateway ã® API Key ã‚’èª¿ã¹ã¦ã¿ãŸ](https://dev.classmethod.jp/articles/api-gateway-usage-plan/)
ãƒ»[API ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èª¿æ•´ã—ã¦ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’å‘ä¸Šã•ã›ã‚‹](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-request-throttling.html)

**å€‹äººçš„ã«æ€ã†ã“ã¨ã¨ã—ã¦ã€API ã‚­ãƒ¼ã®å€¤ã¯è‡ªå‹•ç”Ÿæˆã•ã›ã‚‹ã®ã§ã¯ãªãã€å€¤ã‚’å›ºå®šã—ã¦é‹ç”¨ã™ã‚‹ã“ã¨ãŒã»ã¨ã‚“ã©ã ã¨æ€ã„ã¾ã™ã€‚**

ãƒ‡ãƒ—ãƒ­ã‚¤ã”ã¨ã« API ã‚­ãƒ¼ãŒå¤‰ã‚ã‚‹ã¨ã€ä»Šã¾ã§ä½¿ç”¨ã—ã¦ã„ãŸ API ã‚­ãƒ¼ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€ã‚‚ã—ã€è‡ªå‹•ç”Ÿæˆã¨ã—ã¦ã„ã‚‹å ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¨ API å´ã¯å¸¸ã«åŒæ™‚ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ãªã‘ã‚Œã°ãªã‚‰ãªã„åˆ¶ç´„ãŒè¨­ã‘ã‚‰ã‚Œã¾ã™ã€‚

ã‹ã¨ã„ã£ã¦ã€ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸Šã« API ã‚­ãƒ¼ã®å€¤ã‚’ç›´æ¥æ›¸ãã“ã¨ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã‚ˆããªã„ã®ã§ã¯ï¼Ÿã€ã¨æ€ã„ã¾ã™ãŒã€ãã‚‚ãã‚‚è«–ã¨ã—ã¦ã€API ã‚­ãƒ¼ã¯å”¯ä¸€ã®èªè¨¼ã«ã¯ä½¿ç”¨ã—ã¦ã¯ã„ã‘ãªãã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åˆ¶é™ã‚’è¡Œã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã—ã¦ç®¡ç†ã™ã‚‹ãŸã‚ã«ç”¨ã„ã‚‹ã‚‚ã®ã§ã‚ã‚‹ã®ã§ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸Šã«ãƒ™ã‚¿ã«æ›¸ã„ã¦ã‚‚å•é¡Œãªã„ã¨æ€ã„ã¾ã™ã€‚ï¼ˆã‚‚ã¡ã‚ã‚“ã€èªè¨¼ã®ä»•çµ„ã¿ã¯åˆ¥ã«è¨­ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€‚ï¼‰

# API ã‚­ãƒ¼ã®ä½œæˆ

ä¸Šè¨˜ã®ã‚ˆã†ã« serverless.yml ã‚’è¨­å®šã—ã¦ `sls deploy` ã™ã‚‹ã ã‘ã§ã™ã€‚

```
$ sls deploy
```

ãƒ‡ãƒ—ãƒ­ã‚¤ã«æˆåŠŸã™ã‚‹ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®æœ€å¾Œã®æ–¹ã« API ã‚­ãƒ¼ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

å‰Šé™¤ã¯ `sls remove` ã§å‰Šé™¤

# API ã‚­ãƒ¼ã®ç¢ºèª

ã¡ãªã¿ã« API ã‚­ãƒ¼ã®ç¢ºèªã¯ `sls info` ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã™ã‚Œã°ã€ã„ã¤ã§ã‚‚å¯èƒ½ã§ã™ã€‚
ã‚‚ã¡ã‚ã‚“ sls deploy ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« API ã‚­ãƒ¼ã®å€¤ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```
$ sls info
```
![aaa.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/ebbfd47c-2aa4-e526-c2cc-23b1601f3b28.png)

# API ã®æŒ™å‹•

å®Ÿéš›ã« API ã‚­ãƒ¼ ã‚’è¨­å®šã—ãŸå ´åˆã® API ã®æŒ™å‹•ã«ã¤ã„ã¦ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã§è¡Œã£ã¦ã¿ã¾ã—ãŸã€‚

- x-api-key ã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆ
- x-api-key ãŒä¸æ­£ãªå ´åˆ
- x-api-key ãŒæ­£å¸¸ãªå ´åˆ
- quota ã®ä¸Šé™ã‚’è¶…ãˆãŸå ´åˆ
- throttle ã®ä¸Šé™ã‚’è¶…ãˆãŸå ´åˆ

API ã‚­ãƒ¼ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«è¨­å®šã™ã‚‹å ´åˆã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã® **`x-api-key`** ã¨ã„ã†ã‚­ãƒ¼ã«å¯¾ã—ã¦ã€API ã‚­ãƒ¼ã®å€¤ã‚’è¨­å®šã—ã¾ã™ã€‚

## x-api-key ã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆ

ãƒ»æ–¹æ³•ï¼š `x-api-key` ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã§è¨­å®šã—ãªã„
![aa.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/f4bee96d-02b8-2c4f-68a3-abcc0111e01c.png)
ã€çµæœã€‘
ãƒ» Stats: 403 Forbidden
ãƒ» Response body: {"message":"Forbidden"}

## x-api-key ãŒä¸æ­£ãªå ´åˆ

ãƒ»æ–¹æ³•ï¼š `x-api-key` ã«ä¸æ­£ãªå€¤ï¼ˆhogehogeï¼‰ã‚’ä½¿ç”¨ã™ã‚‹
![bb.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/da805249-be4c-f53b-2c7d-167bdf29f4bd.png)
ã€çµæœã€‘
ãƒ» Stats: 403 Forbidden
ãƒ» Response body: {"message":"Forbidden"}

## x-api-key ãŒæ­£å¸¸ãªå ´åˆ

ãƒ»æ–¹æ³•ï¼š `x-api-key` ã«æ­£å¸¸ãªå€¤ï¼ˆa123456789012345678901234567890ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹
![cc.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/8c52e60f-eda6-98ca-01b7-50d84a28e486.png)
ã€çµæœã€‘
ãƒ»Stats: 200 OK
ãƒ»Response body: æ­£å¸¸ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹

## quota ã®ä¸Šé™ã‚’è¶…ãˆãŸå ´åˆ

ãƒ»æ–¹æ³•ï¼š quota ã®è¨­å®šã‚’ã‹ãªã‚Šä½ãã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå›æ•°ã®ä¸Šé™ã‚’è¶…ãˆã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
![d 2.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/0ae00431-564e-00bc-9ae8-c8152b0c2455.png)
ã€çµæœã€‘
ãƒ»Stats: 429 Too Many Requests
ãƒ»Response body: **{"message":"Limit Exceeded"}**

## throttle ã®ä¸Šé™ã‚’è¶…ãˆãŸå ´åˆ

ãƒ»æ–¹æ³•ï¼š throttle ã®ä¸Šé™ã‚’ã‹ãªã‚Šä½ãè¨­å®šã—ã¦ 100 ä»¶é€£ç¶šã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã˜ã‚‹
![qqqqq.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/625824d1-d43d-be46-7f4d-83eb8876b0fd.png)
ã€çµæœã€‘
ãƒ»Stats: 429 Too Many Requests
ãƒ»Response body: **{"message":"Too Many Requests"}**

## æ¤œè¨¼çµæœ

- x-api-key ã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆ
  - Stats: 403 Forbidden
  - Response body: {"message":"Forbidden"}
- x-api-key ã‚’è¨­å®šã—ã¦ã„ãªã„å ´åˆ
  - Stats: 403 Forbidden
  - Response body: {"message":"Forbidden"}
- x-api-key ãŒæ­£å¸¸ãªå ´åˆ
  - Stats: 200 OK
  - Response body: æ­£å¸¸ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹
- quota ã®ä¸Šé™ã‚’è¶…ãˆãŸå ´åˆ
  - Stats: 429 Too Many Requests
  - Response body: **{"message":"Limit Exceeded"}**
- throttle ã®ä¸Šé™ã‚’è¶…ãˆãŸå ´åˆ
  - Stats: 429 Too Many Requests
  - Response body: **{"message":"Too Many Requests"}**

quotaã€throttle ã®ä¸Šé™ã‚’è¶…ãˆãŸå ´åˆã¯ä¸¡æ–¹ã¨ã‚‚ `Stats: 429 Too Many Requests` ã§ã—ãŸãŒã€Response body ã®å€¤ãŒé•ã†ã‚ˆã†ã§ã™ã­ã€‚

# API Gateway ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèª

serverless.yml ã§è¨˜è¿°ã—ãŸè¨­å®šã¯ API Gateway ã® API ã‚­ãƒ¼ã®è¨­å®šã«åæ˜ ã•ã‚Œã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-12-12 21.10.12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/edb7d912-c0cc-f8c3-b7d4-f9d45b7f9292.png)
ä½¿ç”¨é‡ã‚‚ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-12-12 21.49.53.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/e0a29e48-334e-af04-b1d2-db5fd6e7aaed.png)

# å‚è€ƒæ–‡çŒ®

- Serverless Framework å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  - [Setting API keys for your Rest API](https://www.serverless.com/framework/docs/providers/aws/events/apigateway#setting-api-keys-for-your-rest-api)
- AWS å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  - [API ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ãŸä½¿ç”¨é‡ãƒ—ãƒ©ãƒ³ã®ä½œæˆã¨ä½¿ç”¨](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-api-usage-plans.html)
- ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã®è§£èª¬
  - [API Gatewayã®APIã‚­ãƒ¼ã¨ä½¿ç”¨é‡ãƒ—ãƒ©ãƒ³ã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ãŸ](https://dev.classmethod.jp/articles/try-api-gateway-usage-plan/)
  - [API Gateway ã® API Key ã‚’èª¿ã¹ã¦ã¿ãŸ](https://dev.classmethod.jp/articles/api-gateway-usage-plan/)
