---
title: "CircleCI ã® Job ã®çµæœã‚’ Slack ã«é€šçŸ¥ã™ã‚‹ "
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CircleCI","Slack"]
published: true
---
# ã‚„ã‚ŠãŸã„ã“ã¨
CircleCI ã®Job ã®çµæœã‚’ Slack ã«é€šçŸ¥ã™ã‚‹ã“ã¨ã§ã™ã€‚

ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
[CircleCI Orbsã§ã€jobã®çµæœã‚’slackã«é€šçŸ¥ã™ã‚‹]
(https://qiita.com/k_bobchin/items/11f0d778de09502de1f3#3-circleciconfigyml%E3%82%92%E8%A8%AD%E5%AE%9A)

è¨˜äº‹ã®æµã‚Œã©ãŠã‚Šã§ä½œæˆã—ã¦ã¿ãŸå‚™å¿˜éŒ²ã®ã‚ˆã†ãªã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

# Webhook URL ã®ç™ºè¡Œ

CircleCI ã®å¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰å³ä¸Šã®ã€ŒProject Settingsã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
<img width="1920" alt="qwerr.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/5565f83b-f2f2-3bcd-f5f7-4a5c60466928.png">

ã€ŒSlack Integrationsã€ã‚’é¸æŠã—ã¦ã€ã€ŒSlack's CircleCI Integration pageã€ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
<img width="1458" alt="a.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/7b73cbb4-b331-feca-e309-5ee1de954cfd.png">

é€šçŸ¥ã—ãŸã„ãƒ«ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ï¼ˆä¸‹ã®ç”»åƒã®å³ä¸Šï¼‰ã€ã€ŒAdd to Slackã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã€‚
<img width="1454" alt="b.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/6b8e026c-2a95-ab82-d237-bd0c2d8bd831.png">

é€šçŸ¥ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«ã‚’é¸æŠã—ã¦ã€ã€ŒAdd CircleCI Integrationã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã€‚
<img width="1455" alt="c.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/9a72f4b3-2492-5b54-cbf8-2d6b75da6520.png">

URLãŒç™ºè¡Œã•ã‚Œã‚‹ã®ã§ç¢ºèªã—ã¦ã€ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã€ŒSave Integrationã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã€‚
<img width="1453" alt="d.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/1ef91253-fd7f-d243-ad1f-7fe505d3ebda.png">
<img width="1456" alt="e.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/3c315b89-aa45-f9f7-75d8-67445c09c264.png">

ã“ã‚Œã§URLãŒç™ºè¡Œã•ã‚Œã¾ã—ãŸã€‚

# Webhook URL ã®ç™»éŒ²

å…ˆã»ã©è¡¨ç¤ºã—ãŸCircleCIã®è¨­å®šãƒšãƒ¼ã‚¸ã®ã€ŒAdd Webhook URLã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
<img width="1458" alt="aa.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/2c647609-e136-1789-8693-46a4c796914e.png">

ç™ºè¡Œã•ã‚ŒãŸWebhook URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚ã“ã“ã§ã¯è‡ªå‹•çš„ã«ã€ŒSLACK_WEBHOOKã€ã¨ã„ã†ç’°å¢ƒå¤‰æ•°åã§ç™»éŒ²ã•ã‚Œã¾ã™ã€‚
<img width="552" alt="aaaa.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/ed4fd7ee-194e-43d5-7da3-b8550dbfa01e.png">

# Slack Ords ã®ç¢ºèª

ã€ŒAdd Slack Ordã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
<img width="1064" alt="qwww.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/387c030c-f84b-04ec-d193-5074fd189dca.png">

ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚
<img width="1255" alt="12334.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/ccb28e02-34ee-75bb-ff27-81f697342e36.png">

Slack Orb ã®ä½¿ç”¨ã®ä»•æ–¹ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã‚’ã¿ãªãŒã‚‰ `.circleci/config.yml` ã®è¨­å®šã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚

ã¡ãªã¿ã« Ords ã‚’ä½¿ç”¨ã™ã‚‹ã¨ `.circleci/config.yml` ã®è¨˜è¿°é‡ãŒæ¸›ã‚Šã€ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã¨ã„ã†ã“ã¨ãªã®ã§ã€CircleCI 2.1 ä»¥ä¸Šã§ã‚ã‚Œã°ç©æ¥µçš„ã«ä½¿ç”¨ã—ãŸæ–¹ãŒã„ã„ã‚‚ã®ã‚‰ã—ã„ã§ã™ã€‚

# .circleci/config.yml ã®è¨­å®š

ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã¾ã—ãŸã€‚

```yml
version: 2.1

executors:
  default:
    working_directory: ~/workspace
    docker:
      - image: node:12

orbs:
  slack: circleci/slack@3.4.2

commands:
  restore_npm:
    steps:
      - restore_cache:
          name: Restore npm dependencies
          key: npm-{{ checksum "package.json" }}

  save_npm:
    steps:
      - save_cache:
          name: Cache npm dependencies
          key: npm-{{ checksum "package.json" }}
          paths:
            - ~/workspace/node_modules

jobs:
  build:
    executor: default
    steps:
      - checkout
      - restore_npm
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Lint
          command: npm run lint
      - run:
          name: Build
          command: npm run build
      - run:
          name: Test
          command: npm run test:unit
      - save_npm

  deploy:
    executor: default
    steps:
      - checkout
      - restore_npm
      - run:
          name: Build
          command: npm run build
      - run:
          name: Check dist
          command: ls -la dist
      - run:
          name: Deploy to Firebase Hosting
          command: ./node_modules/.bin/firebase deploy --token=$FIREBASE_TOKEN
      - slack/status:
          success_message: ':ok:\nRepository: $CIRCLE_PROJECT_REPONAME\nBranch: $CIRCLE_BRANCH\nPull Requests: $CIRCLE_PULL_REQUESTS\nDeploy Success!'
          failure_message: ':ng:\nRepository: $CIRCLE_PROJECT_REPONAME\nBranch: $CIRCLE_BRANCH\nPull Requests: $CIRCLE_PULL_REQUESTS\nDeploy Failure!'
          webhook: "${SLACK_WEBHOOK}"

workflows:
  push-build:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
```

Orb ã®ä½¿ã„æ–¹ã¯ `orbs:` ã§ `Orbå`: `ä½¿ç”¨ã™ã‚‹Orb@ã‚¿ã‚°å` ã¨è¨˜è¿°ã—ã¦ã€ Job ã§ `Orbå/xxx` ã¨è¨˜è¿°ã™ã‚Œã° Orb å´ã§å®šç¾©ã—ã¦ã‚ã‚‹ `xxx` ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã¾ã™ã€‚

ã¾ãŸ circleci/slack@3.4.2v ã§ä½¿ãˆã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- approval: Notify Slack about an awaiting approval job.
- notify: Notify a Slack channel with a custom message.
- status: Send a status alert at the end of a job based on success or failure. Must be the last step in a job.

ä»Šå›ã¯ `status` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ 
`status` ã¯ Job ãŒ `æˆåŠŸ` or `å¤±æ•—` ã«å¿œã˜ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€šçŸ¥ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

Slack ã®é€šçŸ¥ã«ã¤ã„ã¦ã®è¨­å®šã‚’æŠœç²‹ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yml
# çœç•¥

orbs:
  slack: circleci/slack@3.4.2

# çœç•¥

jobs:
# çœç•¥
  deploy:
    executor: default
    steps:
      - checkout
      - restore_npm
      - run:
          name: Build
          command: npm run build
      - run:
          name: Check dist
          command: ls -la dist
      - run:
          name: Deploy to Firebase Hosting
          command: ./node_modules/.bin/firebase deploy --token=$FIREBASE_TOKEN
      - slack/status:
          success_message: ':ok:\nRepository: $CIRCLE_PROJECT_REPONAME\nBranch: $CIRCLE_BRANCH\nPull Requests: $CIRCLE_PULL_REQUESTS\nDeploy Success!'
          failure_message: ':ng:\nRepository: $CIRCLE_PROJECT_REPONAME\nBranch: $CIRCLE_BRANCH\nPull Requests: $CIRCLE_PULL_REQUESTS\nDeploy Failure!'
          webhook: "${SLACK_WEBHOOK}"

# çœç•¥
```

ä»Šå›ã®å ´åˆã¯ `deploy` ã® Job ãŒ `æˆåŠŸ` or `å¤±æ•—` ã«å¿œã˜ã¦ `- slack/status:` ä»¥ä¸‹ã® `success_message` or `failure_message` ã§å®šç¾©ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ Slack ã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚

ã¡ãªã¿ã«ã€ã„ã‚ã„ã‚å®Ÿé¨“ã—ãŸçµæœã€`- slack/status:` ã®ç›´å‰ã® Step ã§ãªãã¦ã‚‚ã€Job ã§å®šç¾©ã•ã‚ŒãŸ Step ã®ã©ã“ã‹ä¸€ç®‡æ‰€ã§ã‚‚å¤±æ•—ã—ã¦ã„ã‚‹ã¨ `failure_message` ãŒé£›ã¶ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚

å®Ÿéš›ã«é€šçŸ¥ã—ãŸä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
<img width="637" alt="1233444.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/259125/1d850841-88ea-20db-25da-e6afc9dc8f55.png">
å‡ºåŠ›ã™ã‚‹å†…å®¹ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é‹ç”¨ã«åˆã‚ã›ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚
