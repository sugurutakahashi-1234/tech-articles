---
title: "[Swift] [Combine] 1ã¤ã® Publisher ã‚’å…±æœ‰ã—ãŸã„ã¨ãã¯ share() ã‚’ä½¿ãŠã†ï¼"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift"]
published: true
---

# ä¼ãˆãŸã„ã“ã¨

- 1ã¤ã® Publisher ã‚’  `share()` ã›ãšã«å…±æœ‰ã—ãŸå ´åˆã¯ subscribe ã—ãŸæ•°ã ã‘é‡è¤‡ã—ã¦å‡¦ç†ãŒèµ°ã£ã¦ã—ã¾ã†ã®ã§ã€`share()` ã‚’ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ãã‚Œã‚’é˜²ãã“ã¨ãŒã§ãã‚‹

# å‰ææ¡ä»¶

ä»¥ä¸‹ã®ã‚ˆã†ãª `AnyPublisher` ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```swift
import Combine

var cancellables: Set<AnyCancellable> = []
let numPublisher: PassthroughSubject<Int, Never> = .init()

let è¦ªPublisher: AnyPublisher<Int, Never>
let å­1Publisher: AnyPublisher<Int, Never>
let å­2Publisher: AnyPublisher<Int, Never>
let å­«1_1Publisher: AnyPublisher<Int, Never>
let å­«1_2Publisher: AnyPublisher<Int, Never>
```

ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢ä¿‚ã§ Publisher ã‚’å…±æœ‰ã—ã¦ã„ãã¾ã™ã€‚

```yaml
- numPublisher
  - è¦ª
    - å­1
      - å­«1_1 â†
      - å­«1_2 â†
    - å­2 â†
```

ãã—ã¦ã€`â†` ã®ã¤ã„ã¦ã„ã‚‹ Publisher ã‚’ subscribe ã—ã¦ `numPublisher` ã‚’ `send()` ã—ãŸã¨ãã®æŒ™å‹•ã‚’ç¢ºèªã—ã¾ã™ã€‚

## share() ã‚’ä½¿ã‚ãªã„å ´åˆ

```swift
è¦ªPublisher = numPublisher
    .map {
        print("ã€Œè¦ªã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()

å­1Publisher = è¦ªPublisher
    .map {
        print("ã€Œå­1ã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()

å­2Publisher = è¦ªPublisher
    .map {
        print("ã€Œå­2ã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()

å­«1_1Publisher = å­1Publisher
    .map {
        print("ã€Œå­«1_1ã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()

å­«1_2Publisher = å­1Publisher
    .map {
        print("ã€Œå­«1_2ã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()

// ä»¥ä¸‹ã€subscribe ã®å‡¦ç†
å­2Publisher
    .sink { print("å­2Publisher receive: \($0)")}
    .store(in: &cancellables)

å­«1_1Publisher
    .sink { print("å­«1_1Publisher receive: \($0)")}
    .store(in: &cancellables)

å­«1_2Publisher
    .sink { print("å­«1_2Publisher receive: \($0)")}
    .store(in: &cancellables)
```

ã“ã®çŠ¶æ…‹ã§ `numPublisher` ã‚’ `send()` ã—ã¦ã¿ã¾ã™ã€‚

```swift
numPublisher.send(1)

// ï¼ˆå‡ºåŠ›ï¼‰
// ã€Œè¦ªã€ã‚’é€šéã—ã¾ã—ãŸ
// ã€Œå­1ã€ã‚’é€šéã—ã¾ã—ãŸ
// ã€Œå­«1_1ã€ã‚’é€šéã—ã¾ã—ãŸ
// å­«1_1Publisher receive: 1
// ã€Œè¦ªã€ã‚’é€šéã—ã¾ã—ãŸ â† ä½™è¨ˆ
// ã€Œå­1ã€ã‚’é€šéã—ã¾ã—ãŸ â† ä½™è¨ˆ
// ã€Œå­«1_2ã€ã‚’é€šéã—ã¾ã—ãŸ
// å­«1_2Publisher receive: 1
// ã€Œè¦ªã€ã‚’é€šéã—ã¾ã—ãŸ â† ä½™è¨ˆ
// ã€Œå­2ã€ã‚’é€šéã—ã¾ã—ãŸ
// å­2Publisher receive: 1
```

ä»¥ä¸‹ã®ã‚ˆã†ã« subscribe ã—ãŸæ•°ã ã‘å‡¦ç†ãŒé‡è¤‡ã—ã¦èµ°ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

- è¦ªï¼š3å› â† ä½™è¨ˆã« 2 å›é€šé
- å­1ï¼š2å› â† ä½™è¨ˆã« 1 å›é€šé
- å­2ï¼š1å›
- å­«1_1ï¼š1å›
- å­«1_2ï¼š1å›

ä»Šå›ã®ã‚ˆã†ã« `print()` ã§å€¤ã‚’å‡ºåŠ›ã—ã¦ã„ã‚Œã°ã€ã“ã®ã“ã¨ã«æ°—ãŒã¤ãã®ã§ã™ãŒã€ãã†ã§ã‚‚ã—ãªã„é™ã‚Šã€ãªã‹ãªã‹æ°—ã¥ãã¥ã‚‰ã„ç½ ã«ãªã‚Šã¾ã™ã€‚

## share() ã‚’ä½¿ã†å ´åˆ

å…±æœ‰ã•ã‚Œã‚‹ ã€Œè¦ªPublisherã€ ã¨ ã€Œå­1Publisherã€ ã‚’ `share()` ã—ãŸå¤‰æ•°ã‚’æ–°ãŸã«ä½œæˆã—ã¦ã€ãã‚Œã‚’ subscribe ã—ã¦ã„ãã¾ã™ã€‚

```swift
è¦ªPublisher = numPublisher
    .map {
        print("ã€Œè¦ªã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()

// share() ã—ãŸ Publisher ã‚’ä½œæˆ
let sharedè¦ªPublisher = è¦ªPublisher.share()

å­1Publisher = sharedè¦ªPublisher
    .map {
        print("ã€Œå­1ã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()

å­2Publisher = sharedè¦ªPublisher
    .map {
        print("ã€Œå­2ã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()

// share() ã—ãŸ Publisher ã‚’ä½œæˆ
let sharedå­1Publisher = å­1Publisher.share()

å­«1_1Publisher = sharedå­1Publisher
    .map {
        print("ã€Œå­«1_1ã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()

å­«1_2Publisher = sharedå­1Publisher
    .map {
        print("ã€Œå­«1_2ã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .eraseToAnyPublisher()
```


ã“ã®çŠ¶æ…‹ã§ `numPublisher` ã‚’ `send()` ã—ã¾ã™ã€‚

```swift
numPublisher.send(1)

// ï¼ˆå‡ºåŠ›ï¼‰
// ã€Œè¦ªã€ã‚’é€šéã—ã¾ã—ãŸ
// ã€Œå­1ã€ã‚’é€šéã—ã¾ã—ãŸ
// ã€Œå­«1_2ã€ã‚’é€šéã—ã¾ã—ãŸ
// å­«1_2Publisher receive: 1
// ã€Œå­«1_1ã€ã‚’é€šéã—ã¾ã—ãŸ
// å­«1_1Publisher receive: 1
// ã€Œå­2ã€ã‚’é€šéã—ã¾ã—ãŸ
// å­2Publisher receive: 1
```
å‡ºåŠ›ãŒã‚¹ãƒƒã‚­ãƒªã—ã¾ã—ãŸã­ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã« `share()` ã‚’ã¤ã‘ã‚‹ã¨å‡ºåŠ›ã®å›æ•°ãŒå…¨ã¦ ï¼‘ å›ã«ãªã£ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

- è¦ªï¼š1å›
- å­1ï¼š1å›
- å­2ï¼š1å›
- å­«1_1ï¼š1å›
- å­«1_2ï¼š1å›


### ã“ã‚Œã§ã‚‚ã„ã‘ã‚‹

`share()` ã—ãŸ Publisher ã®å¤‰æ•°ã‚’ã‚ã–ã‚ã–ç”¨æ„ã™ã‚‹ã®ãŒé¢å€’ãªæ™‚ã¯ã€`eraseToAnyPublisher()` ã®å‰ã« `share()`  ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§åŒæ§˜ã®æŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚

ãã®ã¨ãã¯ `share()` ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã‚ˆã†ãªå¤‰æ•°åã«ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

```swift
sharedè¦ªPublisher = numPublisher
    .map {
        print("ã€Œè¦ªã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .share() // è¿½åŠ 
    .eraseToAnyPublisher()

sharedå­1Publisher = è¦ªPublisher
    .map {
        print("ã€Œå­1ã€ã‚’é€šéã—ã¾ã—ãŸ")
        return $0
    }
    .share() // è¿½åŠ 
    .eraseToAnyPublisher()
```

# çµè«–

- 1ã¤ã® Publisher ã‚’  `share()` ã›ãšã«å…±æœ‰ã—ãŸå ´åˆã¯ subscribe ã—ãŸæ•°ã ã‘é‡è¤‡ã—ã¦å‡¦ç†ãŒèµ°ã£ã¦ã—ã¾ã†ã®ã§ã€`share()` ã‚’ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ãã‚Œã‚’é˜²ãã“ã¨ãŒã§ãã‚‹

ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚

# å‚è€ƒ

- [ã€Swiftã€‘Combineã§ä¸€ã¤ã®Publisherã®å‡ºåŠ›çµæœã‚’å…±æœ‰ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚„ã‚¯ãƒ©ã‚¹ã®é•ã„(share, multicast, Future)](https://qiita.com/shiz/items/f089c93bdebfaef2196f)