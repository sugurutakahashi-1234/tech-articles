---
title: "ã€Swift, Combineã€‘didSetã®oldValueã«ç›¸å½“ã™ã‚‹å€¤ã‚’Combineã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§æ‰±ã†æ–¹æ³•"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift", "Combine"]
published: true
---

# çµè«–

- åˆæœŸå€¤ã‚’è¨­å®šã—ãŸããªã„å ´åˆ -> `zip()` ã¨ `dropFirst()` ã‚’ä½¿ã†
- åˆæœŸå€¤ã‚’è¨­å®šã—ãŸã„å ´åˆ ->  `scan()` ã‚’ä½¿ã†

ä¸€èˆ¬åŒ–ã—ãŸ Publisher ã®æ‹¡å¼µã‚‚ç´¹ä»‹ã—ã¾ã™ãŒã€æ··ä¹±ã®å…ƒãªã®ã§å€‹äººçš„ã«ã¯ä½¿ã‚ãªã„ã»ã†ãŒã„ã„æ°—ãŒã—ã¾ã—ãŸã€‚

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

### åˆæœŸå€¤ã‚’è¨­å®šã—ãŸããªã„å ´åˆ

#### zip()ã¨dropFirst()ã‚’ä½¿ã†

```swift
var cancellables = Set<AnyCancellable>()
let numPublisher: PassthroughSubject<Int, Never> = .init()

numPublisher
    .zip(numPublisher.dropFirst())
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // å‡ºåŠ›ãªã—
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

#### åˆæœŸå€¤ã‚’è¨­å®šã—ãŸããªã„å ´åˆã®ä¸€èˆ¬åŒ–

```swift
// ä¸€èˆ¬åŒ–
extension Publisher {
    func withPrevious() -> AnyPublisher<(previous: Output, current: Output), Failure> {
        zip(self.dropFirst())
        .map { previous, current -> (previous: Output, current: Output) in (previous, current) }
        .eraseToAnyPublisher()
    }
}

// ä½¿ã„æ–¹
numPublisher
    .withPrevious()
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // å‡ºåŠ›ãªã—
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

### åˆæœŸå€¤ã‚’è¨­å®šã—ãŸã„å ´åˆ

#### scan()ã‚’ä½¿ã†

```swift
var cancellables = Set<AnyCancellable>()
let numPublisher: PassthroughSubject<Int, Never> = .init()

numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

### åˆæœŸå€¤ã‚’è¨­å®šã—ãŸã„å ´åˆã®ä¸€èˆ¬åŒ–

```swift
// ä¸€èˆ¬åŒ–
extension Publisher {
    func withPrevious(initialPreviousValue: Output) -> AnyPublisher<(previous: Output, current: Output), Failure> {
        scan((initialPreviousValue, initialPreviousValue)) { ($0.1, $1) }.eraseToAnyPublisher()
    }
}

// ä½¿ã„æ–¹
numPublisher
    .withPrevious(initialPreviousValue: 0)
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

æœ¬ç·¨ã¯ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚

# ä»¥é™ã€ä¸€èˆ¬ç³»ã®å°å‡ºã®éç¨‹ã¾ã§ã®ãƒ¡ãƒ¢æ›¸ãã«ãªã‚Šã¾ã™

## å‹•æ©Ÿ

ä»¥ä¸‹ã®ã‚ˆã†ãª Publisher ã¨ãã‚Œã‚’ subscribe ã™ã‚‹å‡¦ç†ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```swift
var cancellables = Set<AnyCancellable>()
let numPublisher: PassthroughSubject<Int, Never> = .init()

numPublisher
    .sink { print("receiveValue: \($0)") }
    .store(in: &cancellables)

numPublisher.send(1) // receiveValue: 1
numPublisher.send(2) // receiveValue: 2
numPublisher.send(3) // receiveValue: 3
```
ã“ã®ã¨ãã« `sink()` ã® `receiveValue` ã§ didSet ã® oldValue ã«ç›¸å½“ã™ã‚‹å€¤ã‚’ç”¨ã„ã¦å‡¦ç†ã—ãŸããªã£ãŸã®ãŒã€æœ¬è¨˜äº‹ã®å‹•æ©Ÿã«ãªã‚Šã¾ã™ã€‚


```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .sink { print("previous: \($0), current: \($1)") }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

Outputã®å¤‰æ•°åã‚’å®šç¾©ã™ã‚‹ã¨ã‚¿ãƒ—ãƒ«ã®Indexã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .sink { output in
        // Outputã®å¤‰æ•°åã‚’å®šç¾©ã™ã‚‹ã¨ã‚¿ãƒ—ãƒ«ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‹ã‚Šã¥ã‚‰ã„
        print("previous: \(output.0), current: \(output.1)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

Outputã®å¤‰æ•°åã‚’å®šç¾©ã—ã¦ã‚¿ãƒ—ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹


```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .map { previous, current -> (previous: Int, current: Int) in (previous, current) }
    .sink { output in
        // map()ã§ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã‚¿ãƒ—ãƒ«ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‹ã‚Šã‚„ã™ããªã‚‹
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

ã‚‚ã¡ã‚ã‚“ã€map()ã—ãªãã¦ã‚‚ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’å®šç¾©ã™ã‚‹ã ã‘ã§è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .sink { previous, current in // ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’å®šç¾©ã—ã¦ã‚‚ã‚ˆã„
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```
ãŸã ã—ã€æ¬¡ã« Publisher ã‚’æ‹¡å¼µã—ã¦ã€ä¸€èˆ¬åŒ–ã™ã‚‹éš›ã«å¤‰æ•°åã®å®šç¾©ã•ã‚Œã¦ã„ãªã„ã‚¿ãƒ—ãƒ«ã‚’è¿”ã™ã¨ã€å®šç¾©ã‚’ã„ã¡ã„ã¡ç¢ºèªã—ãªã‘ã‚Œãªã‚‰ãªã„ã®ã§ã€ä¸€èˆ¬åŒ–ã™ã‚‹éš›ã¯ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°ã‚’å®šç¾©ã—ã¦ã‚ã’ãŸã»ã†ãŒè¦ªåˆ‡ã ã¨æ€ã„ã¾ã™ã€‚

```swift
extension Publisher {
    func withPrevious(initialPreviousValue: Output) -> AnyPublisher<(previous: Output, current: Output), Failure> {
        scan((initialPreviousValue, initialPreviousValue)) { ($0.1, $1) }.eraseToAnyPublisher()
    }
}

numPublisher
    .withPrevious(initialPreviousValue: 0) // Publisherã‚’æ‹¡å¼µã—ãŸé–¢æ•°ã«ã‚ˆã‚Šå‡¦ç†ã‚’çœç•¥
    .sink { output in
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```


```swift
numPublisher
    .withPrevious(0)
    .dropFirst() // dropFirst() ã§åˆæœŸå€¤ã‚’ç„¡è¦–ã™ã‚‹
    .sink { output in
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // â† dropFirst() ã«ã‚ˆã£ã¦å‡ºåŠ›ã•ã‚Œãªã„
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

ãŸã ã—ã€ã“ã®æ–¹æ³•ã ã¨ä½¿ç”¨ã—ãªã„åˆæœŸå€¤ï¼ˆä»Šå›ã®å ´åˆã¯ `0`ï¼‰ã‚’å®šç¾©ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

ãã“ã§ã€ä»Šã®æ‹¡å¼µã§ã€åˆå›ã‚’ç„¡è¦–ã™ã‚‹ä¸€èˆ¬åŒ–ã¯ Output ã®åˆæœŸåŒ–ã®éš›ã«ã€ŒType 'Self.Output' has no member 'init'ã€ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```swift
extension Publisher {
    //  ä»¥ä¸‹ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ãªã£ã¦ã—ã¾ã†
    func withPrevious() -> AnyPublisher<(previous: Output, current: Output), Failure> {
        scan((Output(), Output())) { ($0.1, $1) } // compile error: Type 'Self.Output' has no member 'init'
        .dropFirst()
        .eraseToAnyPublisher()
    }
}
```



```swift
numPublisher
    .scan(Optional<(Int?, Int)>.none) { ($0?.1, $1) }
    .compactMap { $0 }
    .compactMap { previous, current -> (previous: Int, current: Int)? in
        guard let previous = previous else { return nil }
        return (previous, current)
    }
    .sink { output in
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // â† compactMap()ã«ã‚ˆã£ã¦å‡ºåŠ›ã•ã‚Œãªã„
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```



```swift
extension Publisher {
    func withPrevious() -> AnyPublisher<(previous: Output, current: Output), Failure> {
        scan(Optional<(Output?, Output)>.none) { ($0?.1, $1) }
        .compactMap { $0 }
        .compactMap { previous, current in
            guard let previous = previous else { return nil }
            return (previous, current)
        }
        .eraseToAnyPublisher()
    }
}

numPublisher
    .withPrevious() // Publisherã‚’æ‹¡å¼µã—ãŸé–¢æ•°ã«ã‚ˆã‚Šå‡¦ç†ã‚’çœç•¥
    .sink { output in
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // 
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

scan()ã‚’ä½¿ã‚ãšã«dropFirst()ã—ãŸPublisherã‚’zip()ã™ã‚‹ã ã‘å•é¡Œãªã•ãã†

```swift
numPublisher
    .zip(numPublisher.dropFirst())
    .map { previous, current -> (previous: Int, current: Int) in (previous, current) }
    .sink { output in
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)
```


```swift
extension Publisher {
    func withPrevious() -> AnyPublisher<(previous: Output, current: Output), Failure> {
        zip(self.dropFirst())
        .map { previous, current -> (previous: Output, current: Output) in (previous, current) }
        .eraseToAnyPublisher()
    }
}

numPublisher
    .withPrevious() // Publisherã‚’æ‹¡å¼µã—ãŸé–¢æ•°ã«ã‚ˆã‚Šå‡¦ç†ã‚’çœç•¥
    .sink { output in
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // å‡ºåŠ›ãªã—
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```


```swift
var cancellables = Set<AnyCancellable>()
let numPublisher: PassthroughSubject<Int, Never> = .init()
```

```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

```swift
numPublisher
    .zip(numPublisher.dropFirst())
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // å‡ºåŠ›ãªã—
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

```swift
extension Publisher {
    func withPrevious(initialPreviousValue: Output) -> AnyPublisher<(previous: Output, current: Output), Failure> {
        scan((initialPreviousValue, initialPreviousValue)) { ($0.1, $1) }.eraseToAnyPublisher()
    }
    
    func withPrevious() -> AnyPublisher<(previous: Output, current: Output), Failure> {
        zip(self.dropFirst())
        .map { previous, current -> (previous: Output, current: Output) in (previous, current) }
        .eraseToAnyPublisher()
    }
}
```

```swift
numPublisher
    .withPrevious(initialPreviousValue: 0)
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

```swift
numPublisher
    .withPrevious()
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // å‡ºåŠ›ãªã—
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```