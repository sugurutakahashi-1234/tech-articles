---
title: "ã€Swift, Combineã€‘didSetã®oldValueã«ç›¸å½“ã™ã‚‹å€¤ã‚’Combineã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§æ‰±ã†æ–¹æ³•"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift", "Combine"]
published: true
---

# çµè«–

- åˆæœŸå€¤ã‚’è¨­å®šã—ãŸããªã„å ´åˆ -> `zip()` ã¨ `dropFirst()` ã‚’ä½¿ã†
- åˆæœŸå€¤ã‚’è¨­å®šã—ãŸã„å ´åˆ ->  `scan()` ã‚’ä½¿ã†

ä¸€èˆ¬åŒ–ã—ãŸ Publisher ã® extension ã‚‚ç´¹ä»‹ã—ã¾ã™ãŒã€æ­£ç›´ã€æ··ä¹±ã®å…ƒãªã®ã§å€‹äººçš„ã«ã¯ä½¿ã‚ãªã„ã»ã†ãŒã„ã„æ°—ãŒã—ã¾ã—ãŸã€‚

# ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

## åˆæœŸå€¤ã‚’è¨­å®šã—ãŸããªã„å ´åˆ

### zip()ã¨dropFirst()ã‚’ä½¿ã†

```swift
var cancellables = Set<AnyCancellable>()
let numPublisher: PassthroughSubject<Int, Never> = .init()

numPublisher
    .zip(numPublisher.dropFirst())
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // å‡ºåŠ›ãªã—
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

### åˆæœŸå€¤ã‚’è¨­å®šã—ãŸããªã„å ´åˆã®ä¸€èˆ¬åŒ–

```swift
// ä¸€èˆ¬åŒ–
extension Publisher {
    func withPrevious() -> AnyPublisher<(previous: Output, current: Output), Failure> {
        zip(self.dropFirst())
        .map { previous, current -> (previous: Output, current: Output) in (previous, current) }
        .eraseToAnyPublisher()
    }
}

// ä½¿ã„æ–¹
numPublisher
    .withPrevious()
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // å‡ºåŠ›ãªã—
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

## åˆæœŸå€¤ã‚’è¨­å®šã—ãŸã„å ´åˆ

### scan()ã‚’ä½¿ã†

```swift
var cancellables = Set<AnyCancellable>()
let numPublisher: PassthroughSubject<Int, Never> = .init()

numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

### åˆæœŸå€¤ã‚’è¨­å®šã—ãŸã„å ´åˆã®ä¸€èˆ¬åŒ–

```swift
// ä¸€èˆ¬åŒ–
extension Publisher {
    func withPrevious(initialPreviousValue: Output) -> AnyPublisher<(previous: Output, current: Output), Failure> {
        scan((initialPreviousValue, initialPreviousValue)) { ($0.1, $1) }.eraseToAnyPublisher()
    }
}

// ä½¿ã„æ–¹
numPublisher
    .withPrevious(initialPreviousValue: 0)
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // previous: 0, current: 1
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

æœ¬ç·¨ã¯ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚

# ä»¥é™ã€çµè«–ã«è‡³ã‚‹ã¾ã§ã®ãƒ¡ãƒ¢æ›¸ãã«ãªã‚Šã¾ã™

çµè«–ã«è‡³ã‚‹ã¾ã§ã®éç¨‹ã§ã€ã„ã‚ã„ã‚ã¨æ¤œè¨¼ã—ã¦å‹‰å¼·ã«ãªã£ãŸã®ã§ã€ãã®ãƒ¡ãƒ¢æ›¸ãã‚’æ®‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## æœ¬è¨˜äº‹ã‚’æŠ•ç¨¿ã—ã‚ˆã†ã¨æ€ã£ãŸå‹•æ©Ÿ

ã¾ãšã€ä»¥ä¸‹ã®ã‚ˆã†ãª Publisher ã¨ãã‚Œã‚’ subscribe ã™ã‚‹å‡¦ç†ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```swift
var cancellables = Set<AnyCancellable>()
let numPublisher: PassthroughSubject<Int, Never> = .init()

numPublisher
    .sink { print("receiveValue: \($0)") }
    .store(in: &cancellables)

numPublisher.send(1) // receiveValue: 1
numPublisher.send(2) // receiveValue: 2
numPublisher.send(3) // receiveValue: 3
```
ã“ã®ã¨ãã« `sink()` ã® `receiveValue` ã§ ã„ã‚ã‚†ã‚‹ `didSet` ã® `oldValue` ã«ç›¸å½“ã™ã‚‹å€¤ã‚’ç”¨ã„ã¦å‡¦ç†ã—ãŸããªã£ãŸã®ãŒã€æœ¬è¨˜äº‹ã‚’æŠ•ç¨¿ã—ã‚ˆã†ã¨æ€ã£ãŸå‹•æ©Ÿã«ãªã‚Šã¾ã™ã€‚

ãã“ã§ã€ã€ŒCombine didSet oldValueã€ã§æ¤œç´¢ã™ã‚‹ã¨ä»¥ä¸‹ã® StackOverflow ã®è¨˜äº‹ãŒãƒ’ãƒƒãƒˆã—ã¦ã€ãã‚Œã‚’å‚è€ƒã«ã„ã‚ã„ã‚ã¨æ¤œè¨¼ã—ã¾ã—ãŸã€‚


- [Combine previous value using Combine - StackOverflow](https://stackoverflow.com/questions/63926305/combine-previous-value-using-combine)

## åˆæœŸå€¤ã‚’è¨­å®šã—ãŸããªã„å ´åˆã®ä¸€èˆ¬åŒ–ã®éš›ã« `map()` ã§ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’å®šç¾©ã—ãŸèƒŒæ™¯

ã¾ãšã€ä»¥ä¸‹ã®ã‚ˆã†ã« `sink()` ã® `receiveValue` ã®ãƒ–ãƒ­ãƒƒã‚¯ã«ãŠã„ã¦ã€ã©ã®ã‚ˆã†ã« Output ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã®ãŒèª­ã¿ã‚„ã™ã„ã®ã‹ã‚’æ¤œè¨ã—ã¾ã—ãŸã€‚

### ãã®1ï¼š `$index` ã§ã®ã‚¢ã‚¯ã‚»ã‚¹

```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .sink { print("previous: \($0), current: \($1)") }
    .store(in: &cancellables)
```

è¨˜è¿°é‡ã‚‚å°‘ãªãã‚·ãƒ³ãƒ—ãƒ«ã§ã™ãŒåˆè¦‹æ®ºã—ã§ã™ã€‚

### ãã®2ï¼š subscribe å´ã§ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’ãã‚Œãã‚Œå®šç¾©ã™ã‚‹

subscribe å´ã§ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’å®šç¾©ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .sink { previous, current in // ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’å®šç¾©
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)
```

ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
ä¸€èˆ¬åŒ–ã—ãªã„å ´åˆã¯ã“ã‚ŒãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚

### ãã®3ï¼š subscribe å´ã§å¤‰æ•°åã‚’å®šç¾©ã—ã¦ã€ã‚¿ãƒ—ãƒ«ã® index ã§ãã‚Œãã‚Œã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

Output ã®å¤‰æ•°åã‚’å®šç¾©ã™ã‚‹ã¨ã‚¿ãƒ—ãƒ«ã® Index ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .sink { output in
        print("previous: \(output.0), current: \(output.1)")
    }
    .store(in: &cancellables)
```

ã¡ã‚‡ã£ã¨ã‚ã‹ã‚Šã«ãã„ã§ã™ã­ã€‚

### ãã®4ï¼š structã‚’å®šç¾©ã™ã‚‹

```swift
struct NumPublisherOutput {
    let previous: Int
    let current: Int
}

numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .map { previous, current -> NumPublisherOutput in
        NumPublisherOutput(previous: previous, current: current)
    }
    .sink { output in
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)
```

ã¡ã‚‡ã£ã¨ã—ã‚“ã©ã„ã§ã™ã­ã€‚
ä»Šå›ã®å ´åˆã¯ã‚ã¾ã‚ŠãŠå‹§ã‚ã—ã¾ã›ã‚“ã€‚

### ãã®5ï¼š äº‹å‰ã« map() ã§ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’å®šç¾©ã™ã‚‹

`map()` ã§ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’å®šç¾©ã—ã¾ã™ã€‚

```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .map { previous, current -> (previous: Int, current: Int) in (previous, current) }
    .sink { output in
        // ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã‚¿ãƒ—ãƒ«ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‹ã‚Šã‚„ã™ããªã‚‹
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)
```

ã“ã®å ´åˆã€**ãã®3** ã®ã‚ˆã†ã«ã‚¿ãƒ—ãƒ«ã® index ã‚’æ°—ã«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã•ã‚‰ã«ã€ã“ã‚Œã®è‰¯ã„ã¨ã“ã‚ã¯ã€**ãã®2**ã®ã‚ˆã†ã« subscribe å´ã§ã‚¿ãƒ—ãƒ«ã®å¤‰æ•°åã‚’ãã‚Œãã‚Œå®šç¾©ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .map { previous, current -> (previous: Int, current: Int) in (previous, current) }
    .sink { previous, current in // ã“ã“ã§å¤‰æ•°åã®å®šç¾©ã‚‚å¯èƒ½
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)
```

ã©ã£ã¡ã§ã‚‚ã„ã‘ã‚‹ã®ã§ä¾¿åˆ©ã§ã™ã­ã€‚

ãã®ãŸã‚ã€ä»Šå›ã€ä¸€èˆ¬åŒ–ã—ãŸéš›ã«ã¯ã€**ãã®5** ã®ã‚ˆã†ã«å¤‰æ•°åã®å®šç¾©ã—ãŸã‚¿ãƒ—ãƒ«ã‚’è¿”ã—ã¦ã‚ã’ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

## åˆæœŸå€¤ã‚’è¨­å®šã—ãŸããªã„å ´åˆ ã« `scan()` ã¨ `dropFirst()` ã§ã¯ãªã `zip()` ã¨ `dropFirst()` ã‚’ä½¿ã†ã“ã¨ã«ãªã£ãŸèƒŒæ™¯

### æ¡ˆ1ï¼š `scan()` ã¨ `dropFirst()` ã‚’ä½¿ã†ï¼ˆ`self.init()` ç·¨ï¼‰

ã¯ã˜ã‚ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãª `scan()` ã¨ `dropFirst()` ã®çµ„ã¿åˆã‚ã›ã‚’è€ƒãˆã¦ã„ã¾ã—ãŸã€‚

```swift
numPublisher
    .scan((0, 0)) { ($0.1, $1) }
    .dropFirst() // dropFirst() ã§åˆæœŸå€¤ã‚’ç„¡è¦–ã™ã‚‹
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // â† dropFirst() ã«ã‚ˆã£ã¦å‡ºåŠ›ã•ã‚Œãªã„
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

ãŸã ã—ã€ã“ã®æ–¹æ³•ã ã¨ä½¿ç”¨ã—ãªã„åˆæœŸå€¤ï¼ˆä»Šå›ã®å ´åˆã¯ `0`ï¼‰ã‚’å®šç¾©ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã„ã†å•é¡Œç‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚

ãã‚Œã‚’å›é¿ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ã€`0` ã¨å…·ä½“å€¤ã‚’è¨˜è¿°ã™ã‚‹ã®ã§ã¯ãªãã€`Int()` ã¨æ›¸ãç›´ã™ã“ã¨ã‚’è€ƒãˆã¾ã—ãŸã€‚

```swift
numPublisher
    .scan((Int(), Int())) { ($0.1, $1) } // 0 ã§ã¯ãªãã€`Int()` ã¨æ›¸ãç›´ã™
    .dropFirst()
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)
```

ã—ã‹ã—ã€ã“ã‚Œã‚’ä¸€èˆ¬åŒ–ã—ã‚ˆã†ã¨æ€ã„ã€ä»¥ä¸‹ã® extension ã‚’è¨˜è¿°ã—ãŸã¨ã“ã‚ã€ŒType 'Self.Output' has no member 'init'ã€ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

```swift
extension Publisher {
    //  ä»¥ä¸‹ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ãªã£ã¦ã—ã¾ã†
    func withPrevious() -> AnyPublisher<(previous: Output, current: Output), Failure> {
        scan((Output(), Output())) { ($0.1, $1) } // compile error: Type 'Self.Output' has no member 'init'
        .dropFirst()
        .eraseToAnyPublisher()
    }
}
```

ã“ã‚Œã‚’æ‰“ç ´ã™ã‚‹æ–¹æ³•ãŒæ€ã„ã¤ã‹ãšã€ã“ã®æ–¹æ³•ã¯æ–­å¿µã—ã¾ã—ãŸã€‚

ï¼ˆã‚‚ã—æ‰“é–‹ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Œã°æ•™ãˆã¦ã„ãŸã ããŸã„ã§ã™ï¼ï¼œï¼‰

### æ¡ˆ2ï¼š `scan()` ã¨ `dropFirst()` ã‚’ä½¿ã†ï¼ˆ`Optional<(Output?, Output)>.none` ç·¨ï¼‰

`scan()`ã‚’å‚è€ƒã«ã—ãŸ StackOverflow ã®è¨˜äº‹ã« `Optional<(Output?, Output)>.none` ã‚’ä½¿ã†æ–¹æ³•ãŒæ›¸ã„ã¦ã‚ã£ãŸã®ã§ã€ãã‚Œã‚’ä½¿ãˆã°åˆæœŸå€¤ã‚’è¨­å®šã—ãªãã¦ã‚‚è¨˜è¿°ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

- [Combine previous value using Combine - StackOverflow](https://stackoverflow.com/questions/63926305/combine-previous-value-using-combine)

ãã‚ŒãŒä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

```swift
numPublisher
    .scan(Optional<(Int?, Int)>.none) { ($0?.1, $1) }
    .compactMap { $0 }
    .compactMap { previous, current -> (previous: Int, current: Int)? in
        guard let previous = previous else { return nil }
        return (previous, current)
    }
    .sink { output in
        print("previous: \(output.previous), current: \(output.current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // â† compactMap()ã«ã‚ˆã£ã¦å‡ºåŠ›ã•ã‚Œãªã„
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

ã©ã†ã§ã™ã‹ã­ï¼Ÿ
ã¡ã‚‡ã£ã¨èª­ã‚€ã®ãŒå¤§å¤‰ã§ã™ã‚ˆã­ã€‚

ãŸã ã€ä¸€èˆ¬åŒ–ã™ã‚‹ã“ã¨ã«ã¯æˆåŠŸã—ã¾ã—ãŸã€‚

```swift
extension Publisher {
    func withPrevious() -> AnyPublisher<(previous: Output, current: Output), Failure> {
        scan(Optional<(Output?, Output)>.none) { ($0?.1, $1) }
        .compactMap { $0 }
        .compactMap { previous, current in
            guard let previous = previous else { return nil }
            return (previous, current)
        }
        .eraseToAnyPublisher()
    }
}
```

ã§ã™ãŒã€ã±ã£ã¨è¦‹ã§ã¯ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚‰ãªãã¦ã€ç¬¬ä¸‰è€…ãŒæ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã ã¨è€ƒãˆã‚‹ã¨ä½¿ã†ã®ã‚’ãŸã‚ã‚‰ã„ã¾ã™ç¬‘

ãã“ã§ã€ã‚‚ã£ã¨ã„ã„æ–¹æ³•ãŒãªã„ã‹ã¨è€ƒãˆãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®æ¡ˆãŒã‚ˆã•ãã†ãªã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

### æ¡ˆ3ï¼š`zip()` ã¨ `dropFirst()` ã‚’ä½¿ã†

ã¨ã¦ã‚‚ã‚¹ãƒãƒ¼ãƒˆã§ã™ã­ã€‚

```swift
numPublisher
    .zip(numPublisher.dropFirst())
    .sink { previous, current in
        print("previous: \(previous), current: \(current)")
    }
    .store(in: &cancellables)

numPublisher.send(1) // å‡ºåŠ›ãªã—
numPublisher.send(2) // previous: 1, current: 2
numPublisher.send(3) // previous: 2, current: 3
```

`dropFirst()` å´ã®æ–¹ãŒã€`previous` ã§ã¯ãªãã€`current` ã«ãªã‚‹ã®ã¯ç›´æ„Ÿã«åã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€`zip()` ã¯ä¸¡æ–¹ã®çµ„ã¿åˆã‚ã›ãŒæƒã£ãŸã¨ãã«å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã€ã‚†ã£ãã‚Šè€ƒãˆã‚Œã°ç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä¸€èˆ¬åŒ–ã‚‚ã§ãã¾ã—ãŸã€‚

```swift
extension Publisher {
    func withPrevious() -> AnyPublisher<(previous: Output, current: Output), Failure> {
        zip(self.dropFirst())
        .map { previous, current -> (previous: Output, current: Output) in (previous, current) }
        .eraseToAnyPublisher()
    }
}
```

ã“ã†ã„ã£ãŸèƒŒæ™¯ã§ã€`zip()` ã¨ `dropFirst()` ã‚’ä½¿ã†ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚

ãƒ¡ãƒ¢æ›¸ãã¯ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚