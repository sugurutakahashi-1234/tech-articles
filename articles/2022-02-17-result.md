---
title: "[Swift] [Combine] ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚æ­¢ã¾ã‚‰ãªã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œã‚ŠãŸã„ï¼"
emoji: "ğŸŒ¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift"]
published: true
---

# ä¼ãˆãŸã„ã“ã¨

- **`tryMap()` -> `catch` -> `Empty` ã®åˆã‚ã›æŠ€**ã§ã€ã‚¨ãƒ©ãƒ¼ã‚’æ¡ã‚Šã¤ã¶ã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã¤ãã‚‹ã“ã¨ãŒã§ãã‚‹
- ã—ã‹ã—ã€`Failure` ã®å¯èƒ½æ€§ãŒã‚ã‚‹ Publisher ã‚’ subscribe ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€**ä¸€åº¦ã§ã‚‚ `Failure` ãŒç™ºç”Ÿã™ã‚‹ã¨ã€ãã®æ™‚ç‚¹ã§ `Completion` ã¨ãªã‚Šã€`Output` ã‚’å—ã‘ä»˜ã‘ãªããªã‚‹**
- ä¸Šè¨˜ã®å›é¿ç­–ã¨ã—ã¦ã€**`flatMap()` å†…**ã§ subscribe ã™ã‚‹ã“ã¨ãªã `tryMap()` -> `catch` -> `Empty` ã®åˆã‚ã›æŠ€ã‚’ã‹ã‘ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚æ­¢ã¾ã‚‰ãªã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œã‚Šå‡ºã›ã‚‹
- ãŸã ã—ã€`flatMap()` å†…ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯è¦‹é€šã—ãŒæ‚ªã„ãŸã‚ã€**Publisher ã® Output ã‚’ Result å‹ã«ã™ã‚‹æŠ€**ã‚’ä½¿ã†ã¨ã€è¦‹é€šã—ã‚ˆãã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚æ­¢ã¾ã‚‰ãªã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œã‚Šå‡ºã›ã‚‹

# ã‚„ã‚ŠãŸã„ã“ã¨

ä»¥ä¸‹ã‚’å®Ÿæ–½ã—ãŸã„ã¨ãã«ã€ã©ã®ã‚ˆã†ã«ã™ã‚‹ã‹è€ƒãˆã¾ã™ã€‚

- `numPublisher: PassthroughSubject<Int, Never>` ã‚’ç”¨æ„ã—ã¦ã€ã“ã‚Œã‚’ subscribe ã—ã¦ã€å¥‡æ•°ã¨å¶æ•°ã«åˆ†ã‘ã¦ç•°ãªã‚‹å‡¦ç†ã™ã‚‹
- è² ã®å€¤ãŒå‡ºåŠ›ã•ã‚ŒãŸã¨ãã¯ `minusError` ã¨ã—ã¦ã‚¨ãƒ©ãƒ¼å‡¦ç†ã™ã‚‹
- **ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯æ­¢ã‚ãšã«å¥‡æ•°ã¨å¶æ•°ã®å‡¦ç†ã‚’è¡Œã„ç¶šã‘ã‚‹**

ãƒã‚¤ãƒ³ãƒˆã¯ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’æ­¢ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚

ä»¥ä¸‹ã¯ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®å…±é€šã®å®šç¾©ã«ãªã‚Šã¾ã™ã€‚

```swift
import Combine

enum TestError: Error {
    case minusError
}

let numPublisher = PassthroughSubject<Int, Never>()

var cancellables: Set<AnyCancellable> = []
```

## æ¡ˆ1ï¼ˆãƒ€ãƒ¡ãªä¾‹ï¼‰ï¼š tryMap() -> catch -> Empty ã®åˆã‚ã›æŠ€

`tryMap()` -> `catch` -> `Empty` ã®åˆã‚ã›æŠ€ã§ã‚¨ãƒ©ãƒ¼ã¯æ¡ã‚Šã¤ã¶ã™ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ãã®æŠ€ã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚

```swift
// AnyPublisher<Int, Error> ã‚’å®£è¨€
let zeroCheckedPublisher: AnyPublisher<Int, Error>
zeroCheckedPublisher = numPublisher
    .tryMap {
        guard $0 >= 0 else {
            throw TestError.minusError
        }
        return $0
    }
    .eraseToAnyPublisher()

// AnyPublisher<Int, Error> -> AnyPublisher<Int, Never> ã«ã™ã‚‹
let outputPublisher: AnyPublisher<Int, Never>
outputPublisher = zeroCheckedPublisher
    .catch { error -> AnyPublisher<Int, Never> in
        print("error: \(error)")
        // catch -> Empty ã§ãªã‹ã£ãŸã“ã¨ã«ã™ã‚‹
        return Empty<Int, Never>().eraseToAnyPublisher()
    }
    .share()
    .eraseToAnyPublisher()

let oddPublisher: AnyPublisher<Int, Never>
oddPublisher = outputPublisher
    .filter { $0 % 2 != 0 }
    .eraseToAnyPublisher()

let evenPublisher: AnyPublisher<Int, Never>
evenPublisher = outputPublisher
    .filter { $0 % 2 == 0 }
    .eraseToAnyPublisher()

evenPublisher
    .sink { print("evenPublisher: \($0)") }
    .store(in: &cancellables)

oddPublisher
    .sink { print("oddPublisher: \($0)") }
    .store(in: &cancellables)

numPublisher.send(1)
numPublisher.send(2)
numPublisher.send(3)
numPublisher.send(-1)
numPublisher.send(4)
numPublisher.send(-2)
numPublisher.send(5)

// ï¼ˆå‡ºåŠ›ï¼‰
// oddPublisher: 1
// evenPublisher: 2
// oddPublisher: 3
// error: minusError

â†‘ ã‚ã‚Œã€ã€ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ­¢ã¾ã£ã¦ã—ã¾ã†ã€‚ã€‚ã€‚
```

ã©ã†ã‚„ã‚‰ Combine ã®æ€æƒ³ã¨ã—ã¦ã€`AnyPublisher<Int, Error>` ãªã©ã® `Failure` ã®å¯èƒ½æ€§ãŒã‚ã‚‹ Publisher ã‚’ subscribe ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€ä¸€åº¦ã§ã‚‚ `Failure` ãŒç™ºç”Ÿã™ã‚‹ã¨ã€ãã®æ™‚ç‚¹ã§ `Completion` ã¨ãªã‚Šã€`Output` ã‚’å—ã‘ä»˜ã‘ãªããªã‚‹ã¿ãŸã„ã§ã™ã€‚

ã€ä¸€åº¦ã§ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãªã‚‰ã€ã‚‚ã†ä¸€åº¦ Publisher ã‚’ç”Ÿæˆã™ã‚‹ã¨ã“ã‚ã‹ã‚‰ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã­ï¼ã€ã¨ã„ã†ã“ã¨ãªã‚“ã§ã—ã‚‡ã†ã€‚

ã‚‚ã—ãã¯ã€ãã‚‚ãã‚‚ã‚„ã‚Šç›´ã—ãŒå¿…è¦ãªã„ã‚¨ãƒ©ãƒ¼ã¯ã€ã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹ã®ã§ã¯ãªãã€`compactMap()` ã§æ¡ã‚Šæ½°ã—ã¦ãã ã•ã„ã¨ã„ã†ã“ã¨ãªã®ã§ã—ã‚‡ã†ã€‚

## æ¡ˆ2ï¼š flatMap() å†…ã§ã® tryMap() -> catch -> Empty ã®åˆã‚ã›æŠ€

æ¡ˆ 1 ã®ã‚ˆã†ã« 1 åº¦ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹ã¨ã€ãã®æ™‚ç‚¹ã§ `Output` ã‚’å—ã‘ä»˜ã‘ãªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ãã†ã§ã‚ã‚‹ãªã‚‰ã° `AnyPublisher<Int, Error>` ã§ã¯ãªã `AnyPublisher<Int, Never>` ã§ã‚„ã‚Šé€šã™ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

æ¡ˆ1 ã®å‡¦ç†ã‚’ `flatMap()` å†…ã§è¡Œã†ã“ã¨ã§ã€`Failure` ã®å¯èƒ½æ€§ãŒã‚ã‚‹ Publisher ã‚’ subscribe ã™ã‚‹ã“ã¨ãªãã€ã‚¨ãƒ©ãƒ¼ã‚’æ¡ã‚Šã¤ã¶ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

`flatMap()` å†…ã«éš è”½ã™ã‚‹æŠ€ã¨ã—ã¦ã€`flatMap()` å†…ã§ `Just()` ã§å›²ã†æŠ€ãŒã‚ã‚Šã¾ã™ã€‚

```swift
// flatMap() å†…ã§ subscribe ã™ã‚‹ã“ã¨ãªã tryMap() -> catch -> Empty ã®åˆã‚ã›æŠ€ã‚’ã‹ã‘ã‚‹
let outputPublisher: AnyPublisher<Int, Never>
outputPublisher = numPublisher
    .flatMap {
        Just($0)
            .tryMap {
                guard $0 >= 0 else {
                    throw TestError.minusError
                }
                return $0
            }
            .catch { error -> AnyPublisher<Int, Never> in
                print("error: \(error)")
                // catch -> Empty ã§ãªã‹ã£ãŸã“ã¨ã«ã™ã‚‹
                return Empty<Int, Never>().eraseToAnyPublisher()
            }
            .eraseToAnyPublisher()
    }
    .share()
    .eraseToAnyPublisher()

let oddPublisher: AnyPublisher<Int, Never>
oddPublisher = outputPublisher
    .filter { $0 % 2 != 0 }
    .eraseToAnyPublisher()

let evenPublisher: AnyPublisher<Int, Never>
evenPublisher = outputPublisher
    .filter { $0 % 2 == 0 }
    .eraseToAnyPublisher()

evenPublisher
    .sink { print("evenPublisher: \($0)") }
    .store(in: &cancellables)

oddPublisher
    .sink { print("oddPublisher: \($0)") }
    .store(in: &cancellables)

numPublisher.send(1)
numPublisher.send(2)
numPublisher.send(3)
numPublisher.send(-1)
numPublisher.send(4)
numPublisher.send(-2)
numPublisher.send(5)

// ï¼ˆå‡ºåŠ›ï¼‰
// oddPublisher: 1
// evenPublisher: 2
// oddPublisher: 3
// error: minusError
// evenPublisher: 4
// error: minusError
// oddPublisher: 5

â†‘
error ã§æ­¢ã¾ã‚‰ãªããªã‚Šã¾ã—ãŸğŸŒŸ
```

ã¨ã‚Šã‚ãˆãšã€ã“ã‚Œã§ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## æ¡ˆ3ï¼š Output ã‚’ Result å‹ã«ã™ã‚‹

æ¡ˆ2 ã§ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã™ãŒã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ `flatMap()` å†…ã§è¡Œã£ã¦ã„ã‚‹ãŸã‚ã€å…¨ä½“çš„ãªå‡¦ç†ã®è¦‹é€šã—ãŒæ‚ªã„ã¨ã„ã†æ¬ ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

æ­£ç›´ã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãã‚‰ã„å˜ç´”ãªå‡¦ç†ã§ã‚ã‚Œã°å•é¡Œãªã„ã®ã§ã™ãŒã€èª¿å­ã«ä¹—ã£ã¦ã„ã‚‹ã¨ 1 ã¤ã® Publisher ãŒå¤§ãããªã‚Šã™ãã¦ã€å¾Œã‹ã‚‰ä¿®æ­£ãŒã‹ã‘ã¥ã‚‰ããªã‚‹ã¨ã„ã†ã“ã¨ãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã™ã€‚

ãã“ã§ã€ `flatMap()` ã‚’ä½¿ã‚ãšã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Result å‹ ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€è¦‹é€šã—ã‚’ã‚ˆãã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¾ã—ãŸã€‚

```swift
// <Result<Int, Error>, Never> ã«å¤‰æ›´
let zeroCheckedPublisher: AnyPublisher<Result<Int, Error>, Never>
zeroCheckedPublisher = numPublisher
    .map {
        guard $0 >= 0 else {
            return .failure(TestError.minusError)
        }
        return .success($0)
    }
    .share()
    .eraseToAnyPublisher()

// Result<Int, Error> ã‹ã‚‰ Int ã®ã¿ã‚’æŠ½å‡º
let outputPublisher: AnyPublisher<Int, Never>
outputPublisher = zeroCheckedPublisher
    .compactMap {
        if case let .success(output) = $0 {
            return output
        }
        return nil
    }
    .share()
    .eraseToAnyPublisher()

// Result<Int, Error> ã‹ã‚‰ Error ã®ã¿ã‚’æŠ½å‡º
let failurePublisher: AnyPublisher<Error, Never>
failurePublisher = zeroCheckedPublisher
    .compactMap {
        if case let .failure(error) = $0 {
           return error
        }
        return nil
    }
    .eraseToAnyPublisher()

let oddPublisher: AnyPublisher<Int, Never>
oddPublisher = outputPublisher
    .filter { $0 % 2 != 0 }
    .eraseToAnyPublisher()

let evenPublisher: AnyPublisher<Int, Never>
evenPublisher = outputPublisher
    .filter { $0 % 2 == 0 }
    .eraseToAnyPublisher()

evenPublisher
    .sink { print("evenPublisher: \($0)") }
    .store(in: &cancellables)

oddPublisher
    .sink { print("oddPublisher: \($0)") }
    .store(in: &cancellables)

failurePublisher
    .sink { print("failurePublisher: \($0)") }
    .store(in: &cancellables)

numPublisher.send(1)
numPublisher.send(2)
numPublisher.send(3)
numPublisher.send(-1)
numPublisher.send(4)
numPublisher.send(-2)
numPublisher.send(5)

// ï¼ˆå‡ºåŠ›ï¼‰
// oddPublisher: 1
// evenPublisher: 2
// oddPublisher: 3
// failurePublisher: minusError
// evenPublisher: 4
// failurePublisher: minusError
// oddPublisher: 5
```

ã¡ã‚‡ã£ã¨è¨˜è¿°ãŒå†—é•·ã«æ„Ÿã˜ã‚‰ã‚Œã¾ã™ãŒã€Publisher ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ æ¬¡ç¬¬ã§ã€æ¡ˆ 2 ã‚ˆã‚Šã‚‚æ¡ˆ 3 ã®ã»ã†ãŒè¦‹é€šã—ãŒè‰¯ã„å ´åˆã‚‚ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

# çµè«–

- **`tryMap()` -> `catch` -> `Empty` ã®åˆã‚ã›æŠ€**ã§ã€ã‚¨ãƒ©ãƒ¼ã‚’æ¡ã‚Šã¤ã¶ã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã¤ãã‚‹ã“ã¨ãŒã§ãã‚‹
- ã—ã‹ã—ã€`Failure` ã®å¯èƒ½æ€§ãŒã‚ã‚‹ Publisher ã‚’ subscribe ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€**ä¸€åº¦ã§ã‚‚ `Failure` ãŒç™ºç”Ÿã™ã‚‹ã¨ã€ãã®æ™‚ç‚¹ã§ `Completion` ã¨ãªã‚Šã€`Output` ã‚’å—ã‘ä»˜ã‘ãªããªã‚‹**
- ä¸Šè¨˜ã®å›é¿ç­–ã¨ã—ã¦ã€**`flatMap()` å†…**ã§ subscribe ã™ã‚‹ã“ã¨ãªã `tryMap()` -> `catch` -> `Empty` ã®åˆã‚ã›æŠ€ã‚’ã‹ã‘ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚æ­¢ã¾ã‚‰ãªã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œã‚Šå‡ºã›ã‚‹
- ãŸã ã—ã€`flatMap()` å†…ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯è¦‹é€šã—ãŒæ‚ªã„ãŸã‚ã€**Publisher ã® Output ã‚’ Result å‹ã«ã™ã‚‹æŠ€**ã‚’ä½¿ã†ã¨ã€è¦‹é€šã—ã‚ˆãã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚æ­¢ã¾ã‚‰ãªã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ä½œã‚Šå‡ºã›ã‚‹


ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚

# å‚è€ƒ

æ›¸ã„ã¦ã„ã‚‹é€”ä¸­ã§ã»ã¼åŒã˜å†…å®¹ã®è¨˜äº‹ã«å·¡ã‚Šåˆã„ã¾ã—ãŸã€‚

- [[Swift] Combine ã® flatMap ã§ failure ã«ãªã‚‹ã¨ã€ä»¥é™ã¯å€¤ãŒæµã‚Œãªããªã‚‹å•é¡Œã«å¯¾å‡¦ã™ã‚‹](https://qiita.com/hcrane/items/76d6a91d58459373eb0f)

- [[Swift5][Combine]PublisherãŒFailureã‚’å‡ºåŠ›ã—ãŸå¾Œã‚‚ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é€”åˆ‡ã‚Œã•ã›ãªã„æ–¹æ³•ã®è€ƒå¯Ÿ](https://qiita.com/toya108/items/e5fb8b3b531c4011d5c7)
